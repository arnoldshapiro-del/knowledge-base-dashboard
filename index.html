<!DOCTYPE html>
<html lang="en">
<head>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ec4899">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="<head>#129504; Kn">
  <link rel="apple-touch-icon" href="icons/icon.svg">
  <meta name="mobile-web-app-capable" content="yes">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&#129504; Knowledge Base Dashboard v2 - Dr. Shapiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%); }
        .sidebar { background: rgba(30, 27, 75, 0.95); backdrop-filter: blur(10px); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        .active-filter { background: #7c3aed !important; }
        .preview-modal { backdrop-filter: blur(10px); }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .sidebar { animation: slideIn 0.3s ease-out; }
        .star-rating { display: inline-flex; gap: 2px; }
        .star-rating i { cursor: pointer; transition: all 0.15s; color: #4b5563; }
        .star-rating i.filled { color: #eab308; }
        .star-rating i:hover { transform: scale(1.2); }
        .favorite-btn { cursor: pointer; transition: all 0.2s; }
        .favorite-btn:hover { transform: scale(1.15); }
        .favorite-btn.active { color: #ef4444 !important; }
        .color-strip { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; border-radius: 4px 0 0 4px; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.selected { border-color: white; box-shadow: 0 0 8px currentColor; }
        .section-header { cursor: pointer; user-select: none; }
        .section-header .arrow { transition: transform 0.2s; }
        .section-header.collapsed .arrow { transform: rotate(-90deg); }
        .section-content { max-height: 500px; overflow: hidden; transition: max-height 0.3s ease; }
        .section-content.collapsed { max-height: 0; }
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; border-radius: 12px; display: flex; align-items: center; gap: 12px; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #22c55e; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #7c3aed; }
        .context-menu { position: fixed; background: rgba(30, 27, 75, 0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 8px; min-width: 180px; z-index: 1000; display: none; backdrop-filter: blur(10px); }
        .context-menu.show { display: block; }
        .context-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .context-item:hover { background: rgba(124, 58, 237, 0.5); }
        .context-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 6px 0; }
        .clr-red { background: #ef4444; }
        .clr-orange { background: #f97316; }
        .clr-yellow { background: #eab308; }
        .clr-green { background: #22c55e; }
        .clr-blue { background: #3b82f6; }
        .clr-purple { background: #a855f7; }
        .clr-pink { background: #ec4899; }
        .clr-cyan { background: #06b6d4; }
        .kanban-container { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; }
        .kanban-column { min-width: 280px; max-width: 280px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; flex-direction: column; max-height: calc(100vh - 320px); }
        .kanban-header { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .kanban-cards { padding: 12px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .kanban-card { background: rgba(255,255,255,0.08); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .kanban-card:hover { background: rgba(255,255,255,0.12); transform: translateX(4px); }
        .tag-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: rgba(124, 58, 237, 0.3); border-radius: 9999px; font-size: 11px; }
        .tag-pill button { opacity: 0.7; }
        .tag-pill button:hover { opacity: 1; }
        /* Smart Search Styles */
        .smart-search-toggle { transition: all 0.3s ease; cursor: pointer; user-select: none; }
        .smart-search-toggle.active { background: linear-gradient(135deg, #7c3aed, #3b82f6) !important; box-shadow: 0 0 12px rgba(124, 58, 237, 0.5); }
        .smart-search-toggle:hover { transform: scale(1.02); }
        .search-highlight { background: rgba(251, 191, 36, 0.35); padding: 1px 3px; border-radius: 3px; color: #fbbf24; }
        .search-results-bar { background: rgba(124, 58, 237, 0.2); border: 1px solid rgba(124, 58, 237, 0.3); }
        .relevance-badge { background: linear-gradient(135deg, #22c55e, #16a34a); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: rgba(30, 27, 75, 0.98); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; margin-top: 4px; z-index: 100; max-height: 300px; overflow-y: auto; backdrop-filter: blur(10px); display: none; }
        .search-suggestions.show { display: block; }
        .search-suggestion { padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.15s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .search-suggestion:last-child { border-bottom: none; }
        .search-suggestion:hover { background: rgba(124, 58, 237, 0.3); }
        .search-suggestion-tag { color: #a78bfa; }
        .search-suggestion-recent { color: #94a3b8; }
        .search-tips { padding: 12px 14px; color: #a78bfa; font-size: 0.85rem; }
        .match-indicator { font-size: 0.7rem; color: #94a3b8; margin-left: 4px; }
        /* Related Files Styles */
        .related-files-section { margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .related-files-header { font-size: 1rem; font-weight: 600; color: #e2e8f0; margin-bottom: 16px; display: flex; align-items: center; }
        .related-files-header .related-count { font-size: 0.8rem; color: #64748b; font-weight: 400; margin-left: 8px; }
        .related-files-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
        .related-file-card { background: rgba(30, 27, 75, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 14px 16px; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; gap: 8px; }
        .related-file-card:hover { background: rgba(124, 58, 237, 0.2); border-color: rgba(124, 58, 237, 0.5); transform: translateX(4px); }
        .related-file-name { font-size: 0.9rem; font-weight: 500; color: #e2e8f0; display: flex; align-items: center; gap: 8px; }
        .related-file-name i { color: #a78bfa; font-size: 0.85rem; }
        .related-file-summary { font-size: 0.8rem; color: #94a3b8; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .related-file-meta { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .related-similarity-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 9999px; font-weight: 500; }
        .similarity-high { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .similarity-medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .similarity-low { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
        .shared-tags-preview { display: flex; gap: 6px; flex-wrap: wrap; }
        .shared-tag-mini { font-size: 0.65rem; padding: 2px 6px; background: rgba(6, 182, 212, 0.2); color: #22d3ee; border-radius: 9999px; }
        .card-related-indicator { font-size: 0.7rem; color: #06b6d4; display: flex; align-items: center; gap: 4px; margin-top: 8px; opacity: 0.7; transition: opacity 0.2s; }
        .card-related-indicator:hover { opacity: 1; }
        .card-related-indicator i { font-size: 0.65rem; }
        /* Smart Duplicates Modal Styles */
        #smartDuplicatesModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        #smartDuplicatesModal .modal-content {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        .duplicate-group:hover {
            border-color: rgba(124, 58, 237, 0.5);
        }
        .duplicate-file-item:hover {
            background: rgba(124, 58, 237, 0.1);
        }
        .smart-dup-modal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .smart-dup-modal-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .smart-dup-modal-btn.primary:hover {
            background: #6d28d9;
        }

        /* Research Chat Button */
        .research-chat-btn:hover {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.5), rgba(59, 130, 246, 0.5)) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        /* Research Chat Modal */
        .chat-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .chat-modal-content {
            width: 700px;
            max-width: 90vw;
            height: 80vh;
            max-height: 700px;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(30, 27, 75, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-right {
            display: flex;
            gap: 8px;
        }

        .chat-header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #94a3b8;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            max-width: 90%;
        }

        .chat-message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .chat-message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-message.assistant .message-avatar {
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            color: #fff;
        }

        .chat-message.user .message-avatar {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message-text {
            background: rgba(30, 27, 75, 0.8);
            padding: 14px 18px;
            border-radius: 16px;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .chat-message.user .message-text {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.3), rgba(59, 130, 246, 0.3));
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .chat-message.assistant .message-text {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Referenced Files */
        .referenced-files {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-top: 8px;
        }

        .referenced-files-header {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .referenced-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .referenced-file:hover {
            background: rgba(124, 58, 237, 0.2);
        }

        .referenced-file:last-child {
            margin-bottom: 0;
        }

        .referenced-file-icon {
            color: #a78bfa;
            font-size: 0.85rem;
        }

        .referenced-file-name {
            font-size: 0.8rem;
            color: #c4b5fd;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .referenced-file-similarity {
            font-size: 0.7rem;
            color: #10b981;
            background: rgba(16, 185, 129, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Chat Input */
        .chat-input-area {
            padding: 16px 20px;
            background: rgba(30, 27, 75, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input-container textarea {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            color: #fff;
            font-size: 0.95rem;
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input-container textarea:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .chat-input-container textarea::placeholder {
            color: #64748b;
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            border: none;
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-disclaimer {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 10px;
            text-align: center;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #7c3aed;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Batch Mode Controls */
        .batch-mode-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
        }

        .batch-mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .batch-mode-toggle:hover {
            background: rgba(124, 58, 237, 0.2);
            border-color: rgba(124, 58, 237, 0.5);
        }

        .batch-mode-toggle.active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.4), rgba(59, 130, 246, 0.4));
            border-color: #7c3aed;
            color: #fff;
        }

        .batch-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(30, 27, 75, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .selected-count {
            font-size: 0.9rem;
            color: #a78bfa;
            font-weight: 500;
            padding-right: 12px;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .batch-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .batch-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .batch-btn.primary {
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            color: #fff;
        }

        .batch-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }

        .batch-btn.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .batch-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* File Card Selection Checkbox - Enhanced */
        .file-card-checkbox {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .file-card-checkbox:hover {
            border-color: #7c3aed;
            background: rgba(124, 58, 237, 0.3);
        }

        .file-card-checkbox.checked {
            background: #7c3aed;
            border-color: #7c3aed;
        }

        .file-card-checkbox.checked::after {
            content: '\2713';
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }

        /* Show checkboxes when selection mode is active */
        .selection-mode-active .file-card-checkbox {
            display: flex;
        }

        /* Highlight selected cards */
        .file-card.batch-selected {
            border-color: #7c3aed !important;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
        }

        /* Batch Actions Modal Styles */
        .batch-action-item {
            background: rgba(30, 27, 75, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
        }

        .batch-action-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 12px;
        }

        .batch-action-content {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .batch-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .batch-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }

        .batch-action-btn.danger {
            background: #ef4444;
        }

        .batch-action-btn.danger:hover {
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .color-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.8rem;
        }

        .color-btn:hover {
            transform: scale(1.1);
            border-color: #fff;
        }

        .rating-btn {
            padding: 8px 12px;
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            color: #eab308;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            background: rgba(234, 179, 8, 0.3);
            transform: scale(1.05);
        }

        .toast.warning { background: #f59e0b; }

        /* ============================================
           ADVANCED ANALYTICS DASHBOARD STYLES
           ============================================ */
        .analytics-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .analytics-modal.show {
            display: flex;
        }

        .analytics-container {
            background: linear-gradient(145deg, #1e1b4b 0%, #312e81 100%);
            border-radius: 20px;
            width: 100%;
            max-width: 1400px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        .analytics-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .analytics-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .analytics-header h2 i {
            color: #a78bfa;
        }

        .analytics-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .analytics-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .analytics-tabs {
            display: flex;
            gap: 8px;
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            overflow-x: auto;
        }

        .analytics-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analytics-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        .analytics-tab.active {
            background: linear-gradient(135deg, #7c3aed, #6366f1);
            border-color: transparent;
            color: #fff;
        }

        .analytics-tab i {
            font-size: 0.85rem;
        }

        .analytics-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .analytics-panel {
            display: none;
        }

        .analytics-panel.active {
            display: block;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .analytics-metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.2s;
        }

        .analytics-metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .analytics-metric-card .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-bottom: 12px;
        }

        .analytics-metric-card .metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .analytics-metric-card .metric-label {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        .analytics-metric-card .metric-change {
            font-size: 0.8rem;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .analytics-metric-card .metric-change.positive {
            color: #22c55e;
        }

        .analytics-metric-card .metric-change.negative {
            color: #ef4444;
        }

        .analytics-chart-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
        }

        .analytics-chart-card h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analytics-chart-card h4 i {
            color: #a78bfa;
            font-size: 0.9rem;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .chart-container.small {
            height: 180px;
        }

        .analytics-progress-ring {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto;
        }

        .analytics-progress-ring svg {
            transform: rotate(-90deg);
        }

        .analytics-progress-ring circle {
            fill: none;
            stroke-width: 12;
        }

        .analytics-progress-ring .bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .analytics-progress-ring .progress {
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .analytics-progress-ring .center-text {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .analytics-progress-ring .center-text .value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .analytics-progress-ring .center-text .label {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .analytics-table th {
            text-align: left;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-table th:first-child {
            border-radius: 8px 0 0 8px;
        }

        .analytics-table th:last-child {
            border-radius: 0 8px 8px 0;
        }

        .analytics-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }

        .analytics-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        .analytics-tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .analytics-tag-cloud .tag {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: default;
            transition: all 0.2s;
        }

        .analytics-tag-cloud .tag:hover {
            transform: scale(1.05);
        }

        .analytics-health-score {
            text-align: center;
            padding: 30px;
        }

        .analytics-health-score .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .analytics-health-score .score-circle::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            padding: 4px;
            background: conic-gradient(from 0deg, var(--score-color) calc(var(--score) * 3.6deg), rgba(255,255,255,0.1) 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .analytics-health-score .score-value {
            font-size: 3rem;
            font-weight: 700;
        }

        .analytics-health-score .score-label {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .analytics-health-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .health-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .health-item i {
            font-size: 1.2rem;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .health-item .health-info {
            flex: 1;
        }

        .health-item .health-label {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .health-item .health-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .analytics-recommendations {
            margin-top: 24px;
        }

        .analytics-recommendations h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid;
            transition: all 0.2s;
        }

        .recommendation-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .recommendation-item.high {
            border-color: #ef4444;
        }

        .recommendation-item.medium {
            border-color: #f59e0b;
        }

        .recommendation-item.low {
            border-color: #22c55e;
        }

        .recommendation-item i {
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .recommendation-item.high i {
            color: #ef4444;
        }

        .recommendation-item.medium i {
            color: #f59e0b;
        }

        .recommendation-item.low i {
            color: #22c55e;
        }

        .recommendation-item .rec-content h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .recommendation-item .rec-content p {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .analytics-files-attention {
            margin-top: 24px;
        }

        .attention-file {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attention-file:hover {
            background: rgba(124, 58, 237, 0.2);
        }

        .attention-file i {
            color: #f59e0b;
        }

        .attention-file .file-name {
            flex: 1;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attention-file .issue-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .analytics-two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .analytics-two-col {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           UNDO BAR STYLES
           ============================================ */
        .undo-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 27, 75, 0.95);
            border: 1px solid rgba(124, 58, 237, 0.5);
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(124, 58, 237, 0.2);
            z-index: 9999;
            backdrop-filter: blur(10px);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
        }

        .undo-bar.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .undo-bar .undo-message {
            color: #e2e8f0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .undo-bar .undo-message i {
            color: #a78bfa;
        }

        .undo-bar .undo-btn {
            background: linear-gradient(135deg, #7c3aed, #6366f1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .undo-bar .undo-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }

        .undo-bar .undo-close {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .undo-bar .undo-close:hover {
            color: #e2e8f0;
            background: rgba(255, 255, 255, 0.1);
        }

        .undo-bar .undo-timer {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            position: absolute;
            bottom: 0;
            left: 0;
            overflow: hidden;
        }

        .undo-bar .undo-timer-progress {
            height: 100%;
            background: linear-gradient(90deg, #7c3aed, #a78bfa);
            border-radius: 2px;
            animation: undoTimerShrink 6s linear forwards;
        }

        @keyframes undoTimerShrink {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* ============================================
           DUAL-PANE VIEW STYLES
           ============================================ */
        #dualPaneContainer {
            height: calc(100vh - 280px);
            min-height: 400px;
        }

        .dual-folder-item {
            padding: 10px 14px;
            margin: 3px 0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.15s ease;
            color: #e2e8f0;
            border-left: 3px solid transparent;
        }

        .dual-folder-item:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        .dual-folder-item.active {
            background: rgba(139, 92, 246, 0.3);
            border-left-color: #8b5cf6;
        }

        .dual-folder-item .folder-icon {
            color: #fbbf24;
            font-size: 1rem;
        }

        .dual-folder-item .folder-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .dual-folder-item .folder-count {
            font-size: 0.7rem;
            color: #9ca3af;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .dual-file-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .dual-file-card:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        .dual-file-card .file-icon {
            font-size: 1.1rem;
        }

        .dual-file-card .file-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dual-file-card .file-category {
            font-size: 0.75rem;
            color: #9ca3af;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dual-file-card .file-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.7rem;
            color: #6b7280;
        }

        .dual-file-card .file-rating {
            color: #eab308;
        }

        .dual-pane-header {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
        }

        .dual-pane-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #c4b5fd;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dual-files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            padding: 16px;
        }

        #dualPaneLeft {
            width: 280px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            #dualPaneContainer {
                flex-direction: column;
                height: auto;
            }
            #dualPaneLeft {
                width: 100%;
                max-height: 200px;
            }
            #dualPaneRight {
                min-height: 400px;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="text-6xl mb-4">&#129504;</div>
            <h1 class="text-3xl font-bold mb-4">Knowledge Base Dashboard v2</h1>
            <p class="text-purple-300 mb-8" id="loadingStatus">Checking for cached data...</p>
            <div id="loadingSpinner" class="mb-8">
                <i class="fas fa-spinner fa-spin text-4xl text-purple-400"></i>
            </div>
            <div id="filePickerSection" class="hidden">
                <label class="cursor-pointer bg-purple-600 hover:bg-purple-700 px-8 py-4 rounded-xl text-lg font-semibold transition-all inline-block">
                    <i class="fas fa-folder-open mr-2"></i> Select knowledge_base.json
                    <input type="file" id="fileInput" accept=".json" class="hidden">
                </label>
                <p class="text-purple-400 text-sm mt-4">File location: Desktop\KnowledgeBase\knowledge_base_output\</p>
                <p class="text-purple-500 text-xs mt-2">After loading once, it will auto-load next time!</p>
            </div>
        </div>
    </div>
    <div id="app" class="hidden flex min-h-screen">
        <aside class="sidebar w-72 fixed left-0 top-0 h-full overflow-y-auto scrollbar-thin z-40">
            <div class="p-4">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-white/10">
                    <span class="text-3xl">&#129504;</span>
                    <div>
                        <h1 class="font-bold text-lg">Knowledge Base v2</h1>
                        <p class="text-purple-300 text-xs" id="sidebarFileCount">0 files</p>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs uppercase text-purple-400 font-semibold mb-2 section-header" onclick="toggleSection(this)">
                        <i class="fas fa-bolt mr-1"></i> Quick Actions <i class="fas fa-chevron-down arrow ml-auto float-right"></i>
                    </h3>
                    <div class="section-content space-y-1">
                        <button onclick="loadNewFile()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm">
                            <i class="fas fa-folder-open mr-2 text-purple-400"></i> Load Different File
                        </button>
                        <button onclick="refreshFromFile()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm">
                            <i class="fas fa-sync-alt mr-2 text-orange-400"></i> Refresh Data
                        </button>
                        <button onclick="showFavorites()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex justify-between">
                            <span><i class="fas fa-heart mr-2 text-red-400"></i> Favorites</span>
                            <span class="text-purple-400 text-xs" id="favCount">0</span>
                        </button>
                        <button onclick="showRecent()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex justify-between">
                            <span><i class="fas fa-clock mr-2 text-cyan-400"></i> Recent Files</span>
                            <span class="text-purple-400 text-xs">50</span>
                        </button>
                        <button onclick="showDuplicates()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex justify-between">
                            <span><i class="fas fa-clone mr-2 text-yellow-400"></i> Duplicates</span>
                            <span class="text-purple-400 text-xs" id="dupCount">0</span>
                        </button>
                        <button onclick="showSmartDuplicates()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex justify-between">
                            <span><i class="fas fa-brain mr-2 text-orange-400"></i> Content Duplicates</span>
                            <span class="text-orange-400 text-xs" id="smartDupCount">0</span>
                        </button>
                        <button onclick="openAdvancedAnalytics()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm">
                            <i class="fas fa-chart-line mr-2 text-green-400"></i> Advanced Analytics
                        </button>
                        <button onclick="exportData()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm">
                            <i class="fas fa-download mr-2 text-blue-400"></i> Export Data
                        </button>
                        <button onclick="showAIRenamer()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex justify-between">
                            <span><i class="fas fa-robot mr-2 text-emerald-400"></i> AI Renamer</span>
                            <span class="text-emerald-400 text-xs" id="aiRenamerCount">0</span>
                        </button>
                        <button onclick="showGenerateSummariesInfo()" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex justify-between">
                            <span><i class="fas fa-file-alt mr-2 text-purple-400"></i> Generate Summaries</span>
                        </button>
                        <button onclick="openResearchChat()" class="w-full text-left px-3 py-2 rounded-lg transition-all text-sm flex justify-between items-center research-chat-btn" style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.3), rgba(59, 130, 246, 0.3)); border: 1px solid rgba(124, 58, 237, 0.5); margin-top: 8px;">
                            <span><i class="fas fa-comments mr-2" style="color: #a78bfa;"></i> Research Assistant</span>
                            <span style="font-size: 0.6rem; padding: 2px 6px; background: #7c3aed; border-radius: 4px;">AI</span>
                        </button>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs uppercase text-purple-400 font-semibold mb-2 section-header" onclick="toggleSection(this)">
                        <i class="fas fa-database mr-1"></i> Sources <i class="fas fa-chevron-down arrow ml-auto float-right"></i>
                    </h3>
                    <div class="section-content space-y-1">
                        <button onclick="filterBySource('google_drive')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between source-filter" data-source="google_drive">
                            <span><i class="fab fa-google-drive mr-2 text-yellow-400"></i> Google Drive</span>
                            <span class="text-purple-400 text-xs" id="gdriveCount">0</span>
                        </button>
                        <button onclick="filterBySource('local')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between source-filter" data-source="local">
                            <span><i class="fas fa-laptop mr-2 text-blue-400"></i> Local Files</span>
                            <span class="text-purple-400 text-xs" id="localCount">0</span>
                        </button>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs uppercase text-purple-400 font-semibold mb-2 section-header" onclick="toggleSection(this)">
                        <i class="fas fa-layer-group mr-1"></i> Domains <i class="fas fa-chevron-down arrow ml-auto float-right"></i>
                    </h3>
                    <div class="section-content" id="domainList"></div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs uppercase text-purple-400 font-semibold mb-2 section-header" onclick="toggleSection(this)">
                        <i class="fas fa-folder mr-1"></i> Categories <i class="fas fa-chevron-down arrow ml-auto float-right"></i>
                    </h3>
                    <div class="section-content max-h-64 overflow-y-auto scrollbar-thin" id="categoryList"></div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs uppercase text-purple-400 font-semibold mb-2 section-header" onclick="toggleSection(this)">
                        <i class="fas fa-file-alt mr-1"></i> File Types <i class="fas fa-chevron-down arrow ml-auto float-right"></i>
                    </h3>
                    <div class="section-content" id="fileTypeList"></div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs uppercase text-purple-400 font-semibold mb-2 section-header" onclick="toggleSection(this)">
                        <i class="fas fa-tags mr-1"></i> Tags <i class="fas fa-chevron-down arrow ml-auto float-right"></i>
                    </h3>
                    <div class="section-content"><div id="tagCloud" class="flex flex-wrap gap-1"></div></div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs uppercase text-purple-400 font-semibold mb-2 section-header collapsed" onclick="toggleSection(this)">
                        <i class="fas fa-palette mr-1"></i> My Labels & Ratings <i class="fas fa-chevron-down arrow ml-auto float-right"></i>
                    </h3>
                    <div class="section-content collapsed space-y-1">
                        <p class="text-xs text-purple-300 mb-2 px-2">Right-click any file to add color labels or star ratings. Then filter by them here!</p>
                        <button onclick="filterByColor('red')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><span class="inline-block w-3 h-3 rounded clr-red mr-2"></span> Red</span>
                            <span class="text-purple-400 text-xs clr-count" data-color="red">0</span>
                        </button>
                        <button onclick="filterByColor('orange')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><span class="inline-block w-3 h-3 rounded clr-orange mr-2"></span> Orange</span>
                            <span class="text-purple-400 text-xs clr-count" data-color="orange">0</span>
                        </button>
                        <button onclick="filterByColor('yellow')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><span class="inline-block w-3 h-3 rounded clr-yellow mr-2"></span> Yellow</span>
                            <span class="text-purple-400 text-xs clr-count" data-color="yellow">0</span>
                        </button>
                        <button onclick="filterByColor('green')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><span class="inline-block w-3 h-3 rounded clr-green mr-2"></span> Green</span>
                            <span class="text-purple-400 text-xs clr-count" data-color="green">0</span>
                        </button>
                        <button onclick="filterByColor('blue')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><span class="inline-block w-3 h-3 rounded clr-blue mr-2"></span> Blue</span>
                            <span class="text-purple-400 text-xs clr-count" data-color="blue">0</span>
                        </button>
                        <button onclick="filterByColor('purple')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><span class="inline-block w-3 h-3 rounded clr-purple mr-2"></span> Purple</span>
                            <span class="text-purple-400 text-xs clr-count" data-color="purple">0</span>
                        </button>
                        <button onclick="filterByColor('pink')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><span class="inline-block w-3 h-3 rounded clr-pink mr-2"></span> Pink</span>
                            <span class="text-purple-400 text-xs clr-count" data-color="pink">0</span>
                        </button>
                        <button onclick="filterByColor('cyan')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><span class="inline-block w-3 h-3 rounded clr-cyan mr-2"></span> Cyan</span>
                            <span class="text-purple-400 text-xs clr-count" data-color="cyan">0</span>
                        </button>
                        <div class="border-t border-white/10 my-2"></div>
                        <button onclick="filterByRating(5)" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><i class="fas fa-star text-yellow-400 mr-2"></i> 5 Stars</span>
                            <span class="text-purple-400 text-xs" id="r5Count">0</span>
                        </button>
                        <button onclick="filterByRating(4)" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between">
                            <span><i class="fas fa-star text-yellow-400 mr-2"></i> 4+ Stars</span>
                            <span class="text-purple-400 text-xs" id="r4Count">0</span>
                        </button>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs uppercase text-purple-400 font-semibold mb-2 section-header collapsed" onclick="toggleSection(this)">
                        <i class="fas fa-keyboard mr-1"></i> Shortcuts <i class="fas fa-chevron-down arrow ml-auto float-right"></i>
                    </h3>
                    <div class="section-content collapsed text-xs space-y-1 text-purple-300">
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">/</kbd> Search</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">G</kbd> Grid view</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">L</kbd> List view</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">K</kbd> Kanban view</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">P</kbd> Dual-Pane view</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">D</kbd> Duplicates</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">C</kbd> Content Duplicates</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">R</kbd> Recent files</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">F</kbd> Favorite selected</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">T</kbd> Edit tags</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">N</kbd> Smart Rename</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">1-5</kbd> Rate selected</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">A</kbd> Advanced Analytics</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">Esc</kbd> Clear/Close</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">?</kbd> User Manual</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">Ctrl+Shift+R</kbd> Research Chat</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">Ctrl+Shift+B</kbd> Batch Select</div>
                        <div><kbd class="bg-white/20 px-2 py-1 rounded">Ctrl+Z</kbd> Undo Last Action</div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/10">
                    <button onclick="showUserManual()" class="w-full text-left px-4 py-4 rounded-xl bg-gradient-to-r from-amber-600/40 to-yellow-500/40 hover:from-amber-500/60 hover:to-yellow-400/60 transition-all text-sm flex items-center gap-3 border-2 border-amber-400/50 shadow-lg shadow-amber-500/20 group">
                        <div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-yellow-500 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                            <i class="fas fa-book-open text-xl text-gray-900"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-amber-100 text-base">User Manual</div>
                            <div class="text-xs text-amber-300/80">Press ? for help  14 sections</div>
                        </div>
                        <i class="fas fa-chevron-right text-amber-400 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </aside>
        <main class="ml-72 flex-1 p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold" id="totalFiles">0</div>
                    <div class="text-purple-300 text-sm">Total Files</div>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold" id="categorizedFiles">0</div>
                    <div class="text-purple-300 text-sm">Categorized</div>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold" id="totalDomains">0</div>
                    <div class="text-purple-300 text-sm">Domains</div>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold" id="totalCategories">0</div>
                    <div class="text-purple-300 text-sm">Categories</div>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-red-400" id="totalFavorites">0</div>
                    <div class="text-purple-300 text-sm">Favorites</div>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-green-400" id="totalSize">0</div>
                    <div class="text-purple-300 text-sm">Total Size</div>
                </div>
            </div>
            <div class="bg-white/10 rounded-xl p-4 mb-6">
                <div class="flex gap-4 flex-wrap">
                    <div class="flex-1 min-w-64">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-purple-400"></i>
                            <input type="text" id="searchInput" placeholder="Search files..." class="w-full pl-10 pr-24 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-purple-300 focus:outline-none focus:border-purple-400" autocomplete="off">
                            <button id="smartSearchToggle" onclick="toggleSmartSearch()" class="smart-search-toggle absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-slate-600/50 rounded-lg text-xs font-medium flex items-center gap-1">
                                <span id="smartSearchLabel">Exact</span>
                            </button>
                            <!-- Search Suggestions Dropdown -->
                            <div id="searchSuggestions" class="search-suggestions">
                                <div id="searchTips" class="search-tips hidden">
                                    <div class="font-semibold mb-2"><i class="fas fa-lightbulb mr-2 text-yellow-400"></i>Search Tips:</div>
                                    <ul class="text-sm space-y-1 text-purple-300">
                                        <li>Enable "Smart" to search summaries & tags</li>
                                        <li>Use specific terms: "ADHD children dosing"</li>
                                        <li>Press "/" anywhere to focus search</li>
                                    </ul>
                                </div>
                                <div id="recentSearchesSection" class="hidden border-t border-white/10 pt-2 mt-2">
                                    <div class="px-3 py-1 text-xs text-purple-400 font-semibold">Recent Searches</div>
                                    <div id="recentSearchesList"></div>
                                </div>
                                <div id="tagSuggestionsSection" class="hidden">
                                    <div id="tagSuggestionsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <select id="sortBy" class="px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none cursor-pointer">
                        <option value="name">Sort by Name</option>
                        <option value="modified">Sort by Date Modified</option>
                        <option value="created">Sort by Date Created</option>
                        <option value="category">Sort by Category</option>
                        <option value="confidence">Sort by Confidence</option>
                        <option value="rating">Sort by Rating</option>
                        <option value="size">Sort by Size</option>
                    </select>
                    <select id="viewMode" class="px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none cursor-pointer">
                        <option value="grid">Grid View</option>
                        <option value="list">List View</option>
                        <option value="kanban">Kanban View</option>
                        <option value="compact">Compact View</option>
                        <option value="dual">Dual-Pane</option>
                    </select>
                    <button onclick="clearAllFilters()" class="px-4 py-3 bg-red-600/50 hover:bg-red-600 rounded-xl transition-all">
                        <i class="fas fa-times mr-2"></i> Clear
                    </button>
                </div>
                <div class="mt-3 flex items-center gap-4 flex-wrap">
                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                        <input type="checkbox" id="regexMode" class="accent-purple-500 w-4 h-4"> Regex
                    </label>
                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                        <input type="checkbox" id="caseSensitive" class="accent-purple-500 w-4 h-4"> Case Sensitive
                    </label>
                    <div class="border-l border-white/20 h-6 mx-2"></div>
                    <select id="minSize" class="px-3 py-1 bg-white/10 border border-white/20 rounded-lg text-sm text-white">
                        <option value="">Min Size</option>
                        <option value="1024">1 KB+</option>
                        <option value="102400">100 KB+</option>
                        <option value="1048576">1 MB+</option>
                        <option value="10485760">10 MB+</option>
                        <option value="104857600">100 MB+</option>
                    </select>
                    <select id="maxSize" class="px-3 py-1 bg-white/10 border border-white/20 rounded-lg text-sm text-white">
                        <option value="">Max Size</option>
                        <option value="102400">100 KB</option>
                        <option value="1048576">1 MB</option>
                        <option value="10485760">10 MB</option>
                        <option value="104857600">100 MB</option>
                        <option value="1073741824">1 GB</option>
                    </select>
                    <div class="border-l border-white/20 h-6 mx-2"></div>
                    <label class="text-sm text-purple-300">After:</label>
                    <input type="date" id="dateAfter" class="px-3 py-1 bg-white/10 border border-white/20 rounded-lg text-sm text-white">
                    <label class="text-sm text-purple-300">Before:</label>
                    <input type="date" id="dateBefore" class="px-3 py-1 bg-white/10 border border-white/20 rounded-lg text-sm text-white">
                </div>
                <div id="activeFilters" class="mt-3 flex flex-wrap gap-2 hidden"></div>
            </div>
            <!-- Smart Search Results Bar -->
            <div id="searchResultsBar" class="search-results-bar rounded-xl p-3 mb-4 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-search text-purple-400"></i>
                        <span id="searchResultsText" class="text-purple-200">Found 0 files</span>
                        <span id="searchModeIndicator" class="text-xs px-2 py-1 bg-purple-600/50 rounded-full hidden">Smart Search</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="sortedByRelevance" class="text-xs text-purple-400 hidden"><i class="fas fa-sort-amount-down mr-1"></i>Sorted by relevance</span>
                        <button onclick="clearSearch()" class="text-sm text-purple-400 hover:text-white flex items-center gap-1">
                            <i class="fas fa-times"></i> Clear search
                        </button>
                    </div>
                </div>
            </div>
            <!-- Batch Mode Controls -->
            <div class="batch-mode-controls" id="batchModeControls">
                <button onclick="toggleBatchSelectionMode()" class="batch-mode-toggle" id="selectionModeToggle">
                    <i class="fas fa-check-square" id="selectionModeIcon"></i>
                    <span id="selectionModeText">Select Files</span>
                </button>

                <!-- These controls appear when selection mode is ON -->
                <div class="batch-actions" id="batchActions" style="display: none;">
                    <span class="selected-count">
                        <span id="batchSelectedCount">0</span> files selected
                    </span>

                    <button onclick="batchSelectAllVisible()" class="batch-btn" title="Select all visible files">
                        <i class="fas fa-check-double"></i> Select All
                    </button>

                    <button onclick="batchClearSelection()" class="batch-btn" title="Clear selection">
                        <i class="fas fa-times"></i> Clear
                    </button>

                    <div class="batch-divider"></div>

                    <button onclick="openBatchActionsModal()" class="batch-btn primary" id="batchActionsBtn" title="Actions for selected files" disabled style="opacity: 0.5;">
                        <i class="fas fa-bolt"></i> Batch Actions
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <span class="text-purple-300" id="resultsCount">Showing 0 files</span>
                <div class="flex gap-2">
                    <button onclick="selectAll()" class="text-sm text-purple-400 hover:text-white">Select All</button>
                    <span class="text-purple-600">|</span>
                    <button onclick="bulkFavorite()" class="text-sm text-purple-400 hover:text-white"><i class="fas fa-heart mr-1"></i> Favorite</button>
                    <span class="text-purple-600">|</span>
                    <button onclick="bulkEditTags()" class="text-sm text-purple-400 hover:text-white"><i class="fas fa-tags mr-1"></i> Tags</button>
                    <span class="text-purple-600">|</span>
                    <button onclick="downloadSelected()" class="text-sm text-purple-400 hover:text-white"><i class="fas fa-download mr-1"></i> Download</button>
                </div>
            </div>
            <div id="fileGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>

            <!-- Dual-Pane View Container -->
            <div id="dualPaneContainer" class="hidden flex gap-4">
                <!-- Left Pane: Folder Tree -->
                <div id="dualPaneLeft" class="bg-white/5 rounded-xl border border-white/10 overflow-hidden flex flex-col">
                    <div class="dual-pane-header">
                        <h3><i class="fas fa-folder-tree"></i> Domains</h3>
                    </div>
                    <div id="dualPaneFolders" class="flex-1 overflow-y-auto p-2 scrollbar-thin">
                        <!-- Domain/category folders will be listed here -->
                    </div>
                </div>

                <!-- Right Pane: Files from selected folder -->
                <div id="dualPaneRight" class="flex-1 bg-white/5 rounded-xl border border-white/10 overflow-hidden flex flex-col">
                    <div class="dual-pane-header flex items-center justify-between">
                        <h3 id="dualPaneTitle"><i class="fas fa-folder-open text-yellow-400"></i> Select a domain</h3>
                        <span id="dualPaneCount" class="text-sm text-gray-400"></span>
                    </div>
                    <div id="dualPaneFiles" class="flex-1 overflow-y-auto dual-files-grid scrollbar-thin">
                        <!-- Files will be displayed here -->
                        <p class="text-gray-400 col-span-full text-center py-12">
                            <i class="fas fa-hand-pointer text-4xl mb-4 block text-purple-400"></i>
                            Click a domain on the left to view files
                        </p>
                    </div>
                </div>
            </div>

            <div class="text-center mt-8">
                <button id="loadMoreBtn" onclick="loadMore()" class="hidden bg-purple-600 hover:bg-purple-700 px-8 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-plus mr-2"></i> Load More Files
                </button>
            </div>
        </main>
    </div>
    <div id="contextMenu" class="context-menu">
        <div class="context-item" onclick="contextAction('preview')"><i class="fas fa-eye text-blue-400"></i> Preview</div>
        <div class="context-item" onclick="contextAction('favorite')"><i class="fas fa-heart text-red-400"></i> Toggle Favorite</div>
        <div class="context-item" onclick="contextAction('tags')"><i class="fas fa-tags text-cyan-400"></i> Edit Tags</div>
        <div class="context-item" onclick="contextAction('open')"><i class="fas fa-external-link-alt text-purple-400"></i> Open in Drive</div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="contextAction('color')"><i class="fas fa-palette text-pink-400"></i> Set Color</div>
        <div class="context-item" onclick="contextAction('rating')"><i class="fas fa-star text-yellow-400"></i> Set Rating</div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="contextAction('related')"><i class="fas fa-link text-cyan-400"></i> View Related Files</div>
        <div class="context-item" onclick="contextAction('copy')"><i class="fas fa-copy text-green-400"></i> Copy Link</div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="contextAction('smartRename')"><i class="fas fa-magic text-yellow-400"></i> Smart Rename</div>
    </div>
    <div id="previewModal" class="fixed inset-0 bg-black/80 preview-modal hidden z-50 flex items-center justify-center p-8">
        <div class="bg-gray-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <h3 class="font-semibold text-lg" id="previewTitle">File Preview</h3>
                <button onclick="closePreview()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[60vh]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div id="previewThumb" class="bg-white/5 rounded-xl aspect-video flex items-center justify-center text-6xl mb-4"><i class="fas fa-file-alt text-gray-400"></i></div>
                        <div class="mb-4">
                            <div class="text-xs text-purple-400 mb-2">RATING</div>
                            <div class="star-rating text-2xl" id="previewStars"></div>
                        </div>
                        <div class="mb-4">
                            <div class="text-xs text-purple-400 mb-2">COLOR LABEL</div>
                            <div class="flex gap-2" id="previewColors">
                                <div class="color-dot clr-red" data-color="red" onclick="setPreviewColor('red')"></div>
                                <div class="color-dot clr-orange" data-color="orange" onclick="setPreviewColor('orange')"></div>
                                <div class="color-dot clr-yellow" data-color="yellow" onclick="setPreviewColor('yellow')"></div>
                                <div class="color-dot clr-green" data-color="green" onclick="setPreviewColor('green')"></div>
                                <div class="color-dot clr-blue" data-color="blue" onclick="setPreviewColor('blue')"></div>
                                <div class="color-dot clr-purple" data-color="purple" onclick="setPreviewColor('purple')"></div>
                                <div class="color-dot clr-pink" data-color="pink" onclick="setPreviewColor('pink')"></div>
                                <div class="color-dot clr-cyan" data-color="cyan" onclick="setPreviewColor('cyan')"></div>
                                <div class="color-dot bg-gray-600 flex items-center justify-center text-xs" data-color="" onclick="setPreviewColor('')">X</div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="text-xs text-purple-400 mb-2">CUSTOM TAGS</div>
                            <div id="previewCustomTags" class="flex flex-wrap gap-1 mb-2"></div>
                            <button onclick="openTagsEditor(currentPreviewFile?.id)" class="text-xs text-purple-400 hover:text-white"><i class="fas fa-plus mr-1"></i> Add/Edit Tags</button>
                        </div>
                    </div>
                    <div class="space-y-3 text-sm">
                        <div><span class="text-purple-400">Name:</span> <span id="prevName">-</span></div>
                        <div><span class="text-purple-400">Domain:</span> <span id="prevDomain">-</span></div>
                        <div><span class="text-purple-400">Category:</span> <span id="prevCategory">-</span></div>
                        <div><span class="text-purple-400">Type:</span> <span id="prevType">-</span></div>
                        <div><span class="text-purple-400">Size:</span> <span id="prevSize">-</span></div>
                        <div><span class="text-purple-400">Modified:</span> <span id="prevModified">-</span></div>
                        <div><span class="text-purple-400">Created:</span> <span id="prevCreated">-</span></div>
                        <div><span class="text-purple-400">Confidence:</span> <span id="prevConfidence">-</span></div>
                        <div><span class="text-purple-400">Auto Tags:</span> <span id="prevTags">-</span></div>
                        <div id="prevSummarySection" class="mt-4 hidden">
                            <div class="text-purple-400 mb-1"><i class="fas fa-file-alt mr-1"></i> AI Summary:</div>
                            <div id="prevSummary" class="bg-purple-900/30 border border-purple-500/30 rounded-lg p-3 text-sm" style="color: #c4b5fd;">-</div>
                        </div>
                        <!-- Related Files Section -->
                        <div class="related-files-section" id="relatedFilesSection">
                            <h4 class="related-files-header">
                                <i class="fas fa-link" style="color: #06b6d4; margin-right: 8px;"></i>
                                Related Files
                                <span class="related-count" id="relatedFilesCount">(0 found)</span>
                            </h4>
                            <div class="related-files-list" id="relatedFilesList"></div>
                            <div id="relatedFilesEmpty" class="hidden">
                                <p style="color: #64748b; font-style: italic; text-align: center; padding: 20px;">
                                    No related files found. This file may not have been analyzed yet,
                                    or it has unique content not shared with other documents.
                                </p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="text-purple-400 mb-1">Personal Notes:</div>
                            <textarea id="prevNotes" placeholder="Add notes..." class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white text-sm resize-none h-20 focus:outline-none focus:border-purple-400"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 p-4 border-t border-white/10">
                <button onclick="togglePreviewFavorite()" id="prevFavBtn" class="flex-1 py-3 bg-red-600/50 hover:bg-red-600 rounded-xl transition-all"><i class="far fa-heart mr-2"></i> Favorite</button>
                <a id="previewOpenBtn" href="#" target="_blank" class="flex-1 text-center py-3 bg-purple-600 hover:bg-purple-700 rounded-xl transition-all"><i class="fas fa-external-link-alt mr-2"></i> Open</a>
                <a id="previewDownloadBtn" href="#" target="_blank" class="flex-1 text-center py-3 bg-green-600 hover:bg-green-700 rounded-xl transition-all"><i class="fas fa-download mr-2"></i> Download</a>
                <button onclick="copyPreviewLink()" class="flex-1 py-3 bg-cyan-600 hover:bg-cyan-700 rounded-xl transition-all"><i class="fas fa-link mr-2"></i> Copy Link</button>
                <button onclick="showPreviewRelated()" class="flex-1 py-3 bg-violet-600 hover:bg-violet-700 rounded-xl transition-all"><i class="fas fa-project-diagram mr-2"></i> Related</button>
                <button onclick="openLocalAIRenameFromPreview()" class="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-xl transition-all"><i class="fas fa-magic mr-2"></i> Rename</button>
                <button onclick="savePreviewChanges()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl transition-all"><i class="fas fa-save mr-2"></i> Save</button>
            </div>
        </div>
    </div>
    <!-- Advanced Analytics Dashboard Modal -->
    <div id="advancedAnalyticsModal" class="analytics-modal">
        <div class="analytics-container">
            <!-- Header -->
            <div class="analytics-header">
                <h2><i class="fas fa-chart-line"></i> Advanced Analytics Dashboard</h2>
                <button onclick="closeAdvancedAnalytics()" class="analytics-close">&times;</button>
            </div>

            <!-- Tabs -->
            <div class="analytics-tabs">
                <button class="analytics-tab active" onclick="showAnalyticsTab('overview')">
                    <i class="fas fa-home"></i> Overview
                </button>
                <button class="analytics-tab" onclick="showAnalyticsTab('files')">
                    <i class="fas fa-file-alt"></i> Files
                </button>
                <button class="analytics-tab" onclick="showAnalyticsTab('tags')">
                    <i class="fas fa-tags"></i> Tags
                </button>
                <button class="analytics-tab" onclick="showAnalyticsTab('ai')">
                    <i class="fas fa-robot"></i> AI Analysis
                </button>
                <button class="analytics-tab" onclick="showAnalyticsTab('storage')">
                    <i class="fas fa-database"></i> Storage
                </button>
                <button class="analytics-tab" onclick="showAnalyticsTab('quality')">
                    <i class="fas fa-clipboard-check"></i> Quality
                </button>
            </div>

            <!-- Content -->
            <div class="analytics-content">
                <!-- Overview Panel -->
                <div id="analyticsOverview" class="analytics-panel active">
                    <!-- Key Metrics -->
                    <div class="analytics-grid">
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(124, 58, 237, 0.2); color: #a78bfa;">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="metric-value" id="metricTotalFiles">0</div>
                            <div class="metric-label">Total Files</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                                <i class="fas fa-hdd"></i>
                            </div>
                            <div class="metric-value" id="metricTotalStorage">0 GB</div>
                            <div class="metric-label">Total Storage</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(16, 185, 129, 0.2); color: #34d399;">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="metric-value" id="metricTotalTags">0</div>
                            <div class="metric-label">Unique Tags</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(239, 68, 68, 0.2); color: #f87171;">
                                <i class="fas fa-clone"></i>
                            </div>
                            <div class="metric-value" id="metricDuplicates">0</div>
                            <div class="metric-label">Potential Duplicates</div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="analytics-two-col">
                        <div class="analytics-chart-card">
                            <h4><i class="fas fa-chart-pie"></i> Files by Type</h4>
                            <div class="chart-container">
                                <canvas id="advFileTypeChart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-chart-card">
                            <h4><i class="fas fa-sitemap"></i> Files by Source</h4>
                            <div class="chart-container">
                                <canvas id="advSourceChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- AI Progress Ring -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-brain"></i> AI Processing Progress</h4>
                        <div style="display: flex; justify-content: space-around; align-items: center; padding: 20px;">
                            <div class="analytics-progress-ring" id="aiSummaryRing">
                                <svg width="140" height="140">
                                    <circle class="bg" cx="70" cy="70" r="58"></circle>
                                    <circle class="progress" cx="70" cy="70" r="58" stroke="#22c55e"
                                        stroke-dasharray="364.42" stroke-dashoffset="364.42"></circle>
                                </svg>
                                <div class="center-text">
                                    <span class="value" id="aiSummaryPercent">0%</span>
                                    <span class="label">Summarized</span>
                                </div>
                            </div>
                            <div class="analytics-progress-ring" id="aiTaggedRing">
                                <svg width="140" height="140">
                                    <circle class="bg" cx="70" cy="70" r="58"></circle>
                                    <circle class="progress" cx="70" cy="70" r="58" stroke="#3b82f6"
                                        stroke-dasharray="364.42" stroke-dashoffset="364.42"></circle>
                                </svg>
                                <div class="center-text">
                                    <span class="value" id="aiTaggedPercent">0%</span>
                                    <span class="label">Tagged</span>
                                </div>
                            </div>
                            <div class="analytics-progress-ring" id="aiRenamedRing">
                                <svg width="140" height="140">
                                    <circle class="bg" cx="70" cy="70" r="58"></circle>
                                    <circle class="progress" cx="70" cy="70" r="58" stroke="#a855f7"
                                        stroke-dasharray="364.42" stroke-dashoffset="364.42"></circle>
                                </svg>
                                <div class="center-text">
                                    <span class="value" id="aiRenamedPercent">0%</span>
                                    <span class="label">Renamed</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Files Panel -->
                <div id="analyticsFiles" class="analytics-panel">
                    <div class="analytics-two-col">
                        <div class="analytics-chart-card">
                            <h4><i class="fas fa-chart-bar"></i> File Type Distribution</h4>
                            <div class="chart-container">
                                <canvas id="advFileDistChart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-chart-card">
                            <h4><i class="fas fa-chart-line"></i> Files Over Time</h4>
                            <div class="chart-container">
                                <canvas id="advTimelineChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Largest Files -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-weight-hanging"></i> Largest Files</h4>
                        <div style="overflow-x: auto;">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>File Name</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody id="largestFilesTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- File Types Table -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-list"></i> Complete File Type Breakdown</h4>
                        <div style="overflow-x: auto; max-height: 300px;">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                        <th>Total Size</th>
                                    </tr>
                                </thead>
                                <tbody id="fileTypesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tags Panel -->
                <div id="analyticsTags" class="analytics-panel">
                    <div class="analytics-grid">
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(16, 185, 129, 0.2); color: #34d399;">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="metric-value" id="tagMetricTotal">0</div>
                            <div class="metric-label">Total Unique Tags</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="metric-value" id="tagMetricTaggedFiles">0</div>
                            <div class="metric-label">Files With Tags</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(245, 158, 11, 0.2); color: #fbbf24;">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="metric-value" id="tagMetricAvgTags">0</div>
                            <div class="metric-label">Avg Tags per File</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(236, 72, 153, 0.2); color: #f472b6;">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="metric-value" id="tagMetricTopTag">-</div>
                            <div class="metric-label">Most Used Tag</div>
                        </div>
                    </div>

                    <!-- Tag Cloud -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-cloud"></i> Tag Cloud</h4>
                        <div class="analytics-tag-cloud" id="analyticsTagCloud"></div>
                    </div>

                    <!-- Top Tags Chart -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-chart-bar"></i> Top 15 Tags</h4>
                        <div class="chart-container">
                            <canvas id="advTagsChart"></canvas>
                        </div>
                    </div>

                    <!-- All Tags Table -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-table"></i> All Tags</h4>
                        <div style="overflow-x: auto; max-height: 300px;">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Tag</th>
                                        <th>Files</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="allTagsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Panel -->
                <div id="analyticsAI" class="analytics-panel">
                    <div class="analytics-grid">
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(34, 197, 94, 0.2); color: #22c55e;">
                                <i class="fas fa-align-left"></i>
                            </div>
                            <div class="metric-value" id="aiMetricSummarized">0</div>
                            <div class="metric-label">Files Summarized</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="metric-value" id="aiMetricTagged">0</div>
                            <div class="metric-label">Files Tagged by AI</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(168, 85, 247, 0.2); color: #a855f7;">
                                <i class="fas fa-i-cursor"></i>
                            </div>
                            <div class="metric-value" id="aiMetricRenamed">0</div>
                            <div class="metric-label">Files Renamed</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(239, 68, 68, 0.2); color: #f87171;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="metric-value" id="aiMetricBadNames">0</div>
                            <div class="metric-label">Bad Filenames</div>
                        </div>
                    </div>

                    <!-- AI Processing Chart -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-tasks"></i> AI Processing Status</h4>
                        <div class="chart-container">
                            <canvas id="advAIStatusChart"></canvas>
                        </div>
                    </div>

                    <!-- Rename Suggestions Status -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-edit"></i> Rename Suggestions</h4>
                        <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                                    <div style="font-size: 2.5rem; font-weight: 700; color: #f59e0b;" id="aiPendingRenames">0</div>
                                    <div style="font-size: 0.85rem; color: #94a3b8;">Pending Renames</div>
                                </div>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                                    <div style="font-size: 2.5rem; font-weight: 700; color: #22c55e;" id="aiApprovedRenames">0</div>
                                    <div style="font-size: 0.85rem; color: #94a3b8;">Approved Renames</div>
                                </div>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                                    <div style="font-size: 2.5rem; font-weight: 700; color: #ef4444;" id="aiRejectedRenames">0</div>
                                    <div style="font-size: 0.85rem; color: #94a3b8;">Rejected Renames</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Storage Panel -->
                <div id="analyticsStorage" class="analytics-panel">
                    <div class="analytics-grid">
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="metric-value" id="storageMetricTotal">0 GB</div>
                            <div class="metric-label">Total Storage Used</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(16, 185, 129, 0.2); color: #34d399;">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="metric-value" id="storageMetricPDF">0 MB</div>
                            <div class="metric-label">PDF Documents</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(168, 85, 247, 0.2); color: #a855f7;">
                                <i class="fas fa-file-word"></i>
                            </div>
                            <div class="metric-value" id="storageMetricDocs">0 MB</div>
                            <div class="metric-label">Office Documents</div>
                        </div>
                        <div class="analytics-metric-card">
                            <div class="metric-icon" style="background: rgba(245, 158, 11, 0.2); color: #fbbf24;">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="metric-value" id="storageMetricImages">0 MB</div>
                            <div class="metric-label">Images</div>
                        </div>
                    </div>

                    <!-- Storage Charts -->
                    <div class="analytics-two-col" style="margin-top: 24px;">
                        <div class="analytics-chart-card">
                            <h4><i class="fas fa-chart-pie"></i> Storage by Type</h4>
                            <div class="chart-container">
                                <canvas id="advStorageTypeChart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-chart-card">
                            <h4><i class="fas fa-folder"></i> Storage by Source</h4>
                            <div class="chart-container">
                                <canvas id="advStorageSourceChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Largest Files by Storage -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-weight-hanging"></i> Top 10 Largest Files</h4>
                        <div style="overflow-x: auto;">
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>File Name</th>
                                        <th>Size</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody id="storageTopFilesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Quality Panel -->
                <div id="analyticsQuality" class="analytics-panel">
                    <!-- Health Score -->
                    <div class="analytics-chart-card">
                        <h4><i class="fas fa-heartbeat"></i> Knowledge Base Health Score</h4>
                        <div class="analytics-health-score">
                            <div class="score-circle" id="healthScoreCircle" style="background: rgba(255,255,255,0.05);">
                                <span class="score-value" id="healthScoreValue">0</span>
                                <span class="score-label">out of 100</span>
                            </div>
                            <p id="healthScoreLabel" style="font-size: 1.1rem; color: #94a3b8;">Calculating...</p>
                        </div>

                        <!-- Health Breakdown -->
                        <div class="analytics-health-breakdown" id="healthBreakdown"></div>
                    </div>

                    <!-- Files Needing Attention -->
                    <div class="analytics-chart-card" style="margin-top: 24px;">
                        <h4><i class="fas fa-exclamation-circle"></i> Files Needing Attention</h4>
                        <div class="analytics-files-attention" id="filesNeedingAttention">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="analytics-recommendations">
                        <h4><i class="fas fa-lightbulb"></i> Recommendations</h4>
                        <div id="analyticsRecommendations">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="duplicatesModal" class="fixed inset-0 bg-black/80 preview-modal hidden z-50 flex items-center justify-center p-8">
        <div class="bg-gray-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <h3 class="font-semibold text-lg"><i class="fas fa-clone mr-2"></i> Duplicates</h3>
                <button onclick="closeDuplicates()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="duplicatesContent" class="p-4 overflow-y-auto max-h-[70vh]"></div>
        </div>
    </div>
    <!-- Smart Duplicates Modal (Content-based duplicate detection) -->
    <div class="modal-overlay" id="smartDuplicatesModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div class="modal-header" style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div>
                    <h3 style="font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-brain" style="color: #f59e0b;"></i>
                        Smart Duplicate Detection
                    </h3>
                    <p style="font-size: 0.85rem; color: #94a3b8; margin-top: 4px;">
                        Files with similar CONTENT (not just same filename)
                    </p>
                </div>
                <button onclick="closeSmartDuplicatesModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; padding: 5px;">&times;</button>
            </div>
            <!-- Statistics Bar -->
            <div class="duplicate-stats-bar" style="flex-shrink: 0; display: flex; gap: 30px; padding: 16px 24px; background: rgba(30, 27, 75, 0.6); border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div class="stat-item">
                    <span class="stat-value" id="dupGroupCount" style="font-size: 1.5rem; font-weight: 600; color: #f59e0b;">0</span>
                    <span class="stat-label" style="font-size: 0.75rem; color: #64748b; display: block;">Duplicate Groups</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="dupFileCount" style="font-size: 1.5rem; font-weight: 600; color: #ef4444;">0</span>
                    <span class="stat-label" style="font-size: 0.75rem; color: #64748b; display: block;">Duplicate Files</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="dupSpaceSaved" style="font-size: 1.5rem; font-weight: 600; color: #10b981;">0 MB</span>
                    <span class="stat-label" style="font-size: 0.75rem; color: #64748b; display: block;">Potential Space Saved</span>
                </div>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                    <label style="font-size: 0.85rem; color: #94a3b8;">Similarity Threshold:</label>
                    <select id="similarityThreshold" onchange="refreshDuplicates()" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 12px; border-radius: 6px;">
                        <option value="90">90%+ (Very Similar)</option>
                        <option value="80">80%+ (Similar)</option>
                        <option value="70" selected>70%+ (Likely Duplicates)</option>
                        <option value="60">60%+ (Possibly Related)</option>
                    </select>
                </div>
            </div>
            <!-- Duplicate Groups List -->
            <div class="duplicate-groups-container" id="duplicateGroupsContainer" style="flex: 1; overflow-y: auto; padding: 20px 24px;">
                <!-- Groups will be inserted here by JavaScript -->
                <div id="duplicateGroupsList"></div>
                <!-- Empty State -->
                <div id="noDuplicatesMessage" style="display: none; text-align: center; padding: 60px 20px;">
                    <i class="fas fa-check-circle" style="font-size: 4rem; color: #10b981; margin-bottom: 20px;"></i>
                    <h4 style="font-size: 1.2rem; margin-bottom: 10px;">No Duplicates Found!</h4>
                    <p style="color: #94a3b8;">At the current similarity threshold, no content duplicates were detected.</p>
                    <p style="color: #64748b; font-size: 0.85rem; margin-top: 10px;">Try lowering the threshold to find more potential duplicates.</p>
                </div>
                <!-- Loading State -->
                <div id="duplicatesLoading" style="display: none; text-align: center; padding: 60px 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #7c3aed; margin-bottom: 20px;"></i>
                    <h4 style="font-size: 1.1rem;">Scanning for duplicates...</h4>
                    <p style="color: #94a3b8; font-size: 0.9rem;">This may take a moment for large collections.</p>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="modal-footer" style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(30, 27, 75, 0.6);">
                <div style="font-size: 0.8rem; color: #64748b;">
                    <i class="fas fa-info-circle"></i>
                    Duplicates are detected by comparing AI-generated summaries and tags
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="exportDuplicateReport()" class="smart-dup-modal-btn secondary" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                    <button onclick="closeSmartDuplicatesModal()" class="smart-dup-modal-btn primary" style="padding: 10px 20px; background: #7c3aed; border: none; color: #fff; border-radius: 8px; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="relatedModal" class="fixed inset-0 bg-black/80 preview-modal hidden z-50 flex items-center justify-center p-8">
        <div class="bg-gray-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <h3 class="font-semibold text-lg"><i class="fas fa-project-diagram mr-2"></i> Related Files</h3>
                <button onclick="closeRelated()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="relatedContent" class="p-4 overflow-y-auto max-h-[70vh]"></div>
        </div>
    </div>
    <div id="colorPickerModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-900 rounded-2xl p-6">
            <h3 class="font-semibold mb-4">Select Color Label</h3>
            <div class="flex gap-4 mb-4">
                <div class="color-dot w-10 h-10 clr-red" onclick="applyColorFromPicker('red')"></div>
                <div class="color-dot w-10 h-10 clr-orange" onclick="applyColorFromPicker('orange')"></div>
                <div class="color-dot w-10 h-10 clr-yellow" onclick="applyColorFromPicker('yellow')"></div>
                <div class="color-dot w-10 h-10 clr-green" onclick="applyColorFromPicker('green')"></div>
                <div class="color-dot w-10 h-10 clr-blue" onclick="applyColorFromPicker('blue')"></div>
                <div class="color-dot w-10 h-10 clr-purple" onclick="applyColorFromPicker('purple')"></div>
                <div class="color-dot w-10 h-10 clr-pink" onclick="applyColorFromPicker('pink')"></div>
                <div class="color-dot w-10 h-10 clr-cyan" onclick="applyColorFromPicker('cyan')"></div>
                <div class="color-dot w-10 h-10 bg-gray-600 flex items-center justify-center" onclick="applyColorFromPicker('')">X</div>
            </div>
            <button onclick="closeColorPicker()" class="w-full py-2 bg-white/10 hover:bg-white/20 rounded-lg">Cancel</button>
        </div>
    </div>
    <div id="tagsEditorModal" class="fixed inset-0 bg-black/80 preview-modal hidden z-50 flex items-center justify-center p-8">
        <div class="bg-gray-900 rounded-2xl max-w-md w-full">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <h3 class="font-semibold text-lg"><i class="fas fa-tags mr-2"></i> Edit Tags</h3>
                <button onclick="closeTagsEditor()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4">
                <p class="text-sm text-purple-300 mb-3" id="tagsEditorFileName">File: -</p>
                <div class="mb-4">
                    <div class="text-xs text-purple-400 mb-2">CURRENT TAGS</div>
                    <div id="currentTagsList" class="flex flex-wrap gap-2 min-h-8"></div>
                </div>
                <div class="mb-4">
                    <div class="text-xs text-purple-400 mb-2">ADD NEW TAG</div>
                    <div class="flex gap-2">
                        <input type="text" id="newTagInput" placeholder="Enter tag..." class="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:outline-none focus:border-purple-400" onkeypress="if(event.key==='Enter') addTagFromEditor()">
                        <button onclick="addTagFromEditor()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div>
                    <div class="text-xs text-purple-400 mb-2">SUGGESTED</div>
                    <div id="suggestedTags" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="flex gap-3 p-4 border-t border-white/10">
                <button onclick="closeTagsEditor()" class="flex-1 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Cancel</button>
                <button onclick="saveTagsFromEditor()" class="flex-1 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg">Save</button>
            </div>
        </div>
    </div>
    <!-- COMPREHENSIVE USER MANUAL MODAL -->
    <div id="userManualModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gradient-to-br from-gray-900 via-purple-900/20 to-gray-900 rounded-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col border border-purple-500/30 shadow-2xl shadow-purple-500/20">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-purple-500/30 bg-gradient-to-r from-purple-900/50 to-amber-900/30">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-yellow-500 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-book-open text-xl text-gray-900"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-white">Knowledge Base Dashboard - User Manual</h3>
                        <p class="text-sm text-purple-300">Complete Guide to All 39+ Features</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="printManual()" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm flex items-center gap-2 transition-colors">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button onclick="closeUserManual()" class="w-10 h-10 bg-white/10 hover:bg-red-500/50 rounded-lg flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Main Content with Sidebar Navigation -->
            <div class="flex flex-1 overflow-hidden">
                <!-- Left Navigation Sidebar -->
                <div class="w-64 bg-black/40 border-r border-purple-500/20 overflow-y-auto shrink-0" id="manualNav">
                    <div class="p-3 sticky top-0 bg-black/60 backdrop-blur-sm border-b border-purple-500/20">
                        <input type="text" placeholder="Search manual..." class="w-full px-3 py-2 bg-white/10 border border-purple-500/30 rounded-lg text-sm text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400" id="manualSearchInput" oninput="searchManual(this.value)">
                    </div>
                    <nav class="p-2 space-y-1" id="manualNavItems">
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg bg-amber-500/30 text-amber-100 text-sm flex items-center gap-2 border border-amber-500/30" data-section="welcome">
                            <i class="fas fa-home w-5"></i> Welcome
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="getting-started">
                            <i class="fas fa-rocket w-5"></i> Getting Started
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="sidebar">
                            <i class="fas fa-bars w-5"></i> Sidebar Navigation
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="search">
                            <i class="fas fa-search w-5"></i> Search & Filtering
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="views">
                            <i class="fas fa-th-large w-5"></i> View Modes
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="personalization">
                            <i class="fas fa-palette w-5"></i> Personalization
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="preview">
                            <i class="fas fa-eye w-5"></i> Preview Modal
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="analytics">
                            <i class="fas fa-chart-pie w-5"></i> Analytics Dashboard
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="special-tools">
                            <i class="fas fa-magic w-5"></i> Special Tools
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="shortcuts">
                            <i class="fas fa-keyboard w-5"></i> Keyboard Shortcuts
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="context-menu">
                            <i class="fas fa-mouse-pointer w-5"></i> Context Menu
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="workflows">
                            <i class="fas fa-route w-5"></i> Tips & Workflows
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="data">
                            <i class="fas fa-database w-5"></i> Data & Persistence
                        </button>
                        <button class="manual-nav-item w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 text-purple-200 text-sm flex items-center gap-2 transition-colors" data-section="troubleshooting">
                            <i class="fas fa-wrench w-5"></i> Troubleshooting
                        </button>
                    </nav>
                </div>

                <!-- Right Content Area -->
                <div class="flex-1 overflow-y-auto p-6 manual-content-area" id="manualContentArea">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>

            <!-- Footer -->
            <div class="flex items-center justify-between px-4 py-3 border-t border-purple-500/30 bg-black/40">
                <div class="text-sm text-purple-300">
                    <i class="fas fa-lightbulb text-amber-400 mr-2"></i>
                    Tip: Press <kbd class="bg-purple-600 px-2 py-1 rounded text-xs mx-1">?</kbd> anytime to open this manual
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="navigateManual('prev')" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded text-sm flex items-center gap-1 transition-colors">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button onclick="navigateManual('next')" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm flex items-center gap-1 transition-colors">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"><i id="toastIcon" class="fas fa-check-circle"></i><span id="toastMsg">Success</span></div>

    <!-- Undo Bar -->
    <div id="undoBar" class="undo-bar">
        <div class="undo-message">
            <i class="fas fa-info-circle"></i>
            <span id="undoMessage">Action completed</span>
        </div>
        <button onclick="performUndo()" class="undo-btn">
            <i class="fas fa-undo"></i> Undo
        </button>
        <button onclick="hideUndoBar()" class="undo-close">
            <i class="fas fa-times"></i>
        </button>
        <div class="undo-timer">
            <div class="undo-timer-progress" id="undoTimerProgress"></div>
        </div>
    </div>

    <!-- AI Renamer Modal -->
    <div id="aiRenamerModal" class="fixed inset-0 bg-black/90 preview-modal hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <h3 class="font-semibold text-lg flex items-center gap-2">
                    <i class="fas fa-robot text-emerald-400"></i> AI File Renamer
                    <span class="text-xs bg-emerald-600 px-2 py-1 rounded-full ml-2">Powered by Gemini</span>
                </h3>
                <button onclick="closeAIRenamer()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Stats Bar -->
            <div class="flex gap-4 p-4 bg-black/30 border-b border-white/10">
                <div class="text-center px-4">
                    <div class="text-2xl font-bold text-emerald-400" id="aiPendingCount">0</div>
                    <div class="text-xs text-gray-400">Pending</div>
                </div>
                <div class="text-center px-4 border-l border-white/10">
                    <div class="text-2xl font-bold text-green-400" id="aiApprovedCount">0</div>
                    <div class="text-xs text-gray-400">Approved</div>
                </div>
                <div class="text-center px-4 border-l border-white/10">
                    <div class="text-2xl font-bold text-gray-400" id="aiSkippedCount">0</div>
                    <div class="text-xs text-gray-400">Skipped</div>
                </div>
                <div class="flex-1 flex items-center px-4 border-l border-white/10">
                    <div class="w-full">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-purple-300">Files with summaries:</span>
                            <span class="text-purple-400" id="aiSummaryStats">0 of 0</span>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-2">
                            <div class="bg-purple-500 h-2 rounded-full transition-all" id="aiSummaryProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <select id="aiFilterStatus" class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm text-white" onchange="filterAISuggestions()">
                        <option value="all">All</option>
                        <option value="pending" selected>Pending</option>
                        <option value="approved">Approved</option>
                        <option value="skipped">Skipped</option>
                    </select>
                    <button onclick="loadAISuggestions()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Instructions Panel (collapsed by default) -->
            <div id="aiInstructions" class="p-4 bg-emerald-900/30 border-b border-white/10 hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold mb-2"><i class="fas fa-info-circle mr-2"></i>How to Use AI Renamer</h4>
                        <ol class="text-sm text-purple-200 space-y-1 list-decimal list-inside">
                            <li>Go to <code class="bg-black/30 px-2 py-1 rounded">C:\Users\arnol\Desktop\KnowledgeBaseAI</code></li>
                            <li>Double-click <strong>run_ai_renamer_setup.bat</strong></li>
                            <li>Get your FREE API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-cyan-400 underline">Google AI Studio</a></li>
                            <li>The script will process ~1,400 files/day automatically</li>
                            <li>Come back here to review and approve suggestions!</li>
                        </ol>
                    </div>
                    <button onclick="document.getElementById('aiInstructions').classList.add('hidden')" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Suggestions List -->
            <div class="p-4 overflow-y-auto flex-1" id="aiSuggestionsList">
                <div class="text-center py-12 text-purple-300">
                    <i class="fas fa-robot text-6xl mb-4 text-emerald-400/50"></i>
                    <p class="mb-4">No AI suggestions loaded yet.</p>
                    <button onclick="loadAISuggestions()" class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 rounded-xl">
                        <i class="fas fa-upload mr-2"></i> Load ai_suggestions.json
                    </button>
                    <p class="text-xs text-gray-500 mt-4">Or click "Show Setup" below to get started</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex gap-3 p-4 border-t border-white/10 bg-black/30">
                <button onclick="document.getElementById('aiInstructions').classList.toggle('hidden')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm">
                    <i class="fas fa-question-circle mr-1"></i> Show Setup
                </button>
                <button onclick="approveAllPending()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">
                    <i class="fas fa-check-double mr-1"></i> Approve All Pending
                </button>
                <div class="flex-1"></div>
                <button onclick="exportApprovedRenames()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">
                    <i class="fas fa-download mr-1"></i> Export Approved
                </button>
            </div>
        </div>
    </div>

    <!-- Local AI Rename Modal (metadata-based, no API) -->
    <div id="localAIRenameModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-purple-500/30 rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl">
            <!-- Header -->
            <div class="p-4 border-b border-white/10 bg-gradient-to-r from-purple-900/50 to-yellow-900/50">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-magic text-yellow-400"></i>
                        Smart Rename Suggestion
                    </h3>
                    <button onclick="closeLocalAIRename()" class="text-gray-400 hover:text-white transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-1">Generate a descriptive filename based on file metadata</p>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-4">
                <!-- Current Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Current Filename</label>
                    <div id="localAICurrentName" class="bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-red-400 font-mono text-sm break-all">
                        Document1.pdf
                    </div>
                </div>

                <!-- File Info Used for Suggestion -->
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Based On</label>
                    <div id="localAIBasedOn" class="bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-xs">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Suggested Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Suggested Filename</label>
                    <input type="text" id="localAISuggestion"
                        class="w-full bg-black/30 border border-green-500/50 rounded-lg px-4 py-3 text-green-400 font-mono text-sm focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400/50"
                        value="">
                    <p class="text-xs text-gray-500 mt-1">You can edit this before copying</p>
                </div>

                <!-- Alternative Suggestions -->
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Other Suggestions</label>
                    <div id="localAIAlternatives" class="space-y-2 max-h-32 overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-white/10 bg-black/20 flex items-center justify-between gap-3">
                <button onclick="closeLocalAIRename()" class="px-4 py-2 text-gray-400 hover:text-white transition">
                    Cancel
                </button>
                <div class="flex gap-2">
                    <button onclick="regenerateLocalAISuggestion()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        Regenerate
                    </button>
                    <button onclick="copyLocalAIRename()" class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold transition flex items-center gap-2">
                        <i class="fas fa-copy"></i>
                        Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Summaries Info Modal -->
    <div id="generateSummariesModal" class="fixed inset-0 bg-black/90 preview-modal hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl max-w-2xl w-full overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <h3 class="font-semibold text-lg flex items-center gap-2">
                    <i class="fas fa-file-alt text-purple-400"></i> Generate AI Summaries
                </h3>
                <button onclick="closeGenerateSummariesInfo()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-purple-900/30 border border-purple-500/30 rounded-xl p-4 mb-4">
                    <h4 class="font-semibold mb-2 text-purple-300"><i class="fas fa-info-circle mr-2"></i>What This Does</h4>
                    <p class="text-sm text-purple-200">This tool uses Google Gemini 3 Flash (FREE!) to analyze your files and generate helpful 2-3 sentence summaries describing what each document is about.</p>
                </div>
                <div class="space-y-3">
                    <h4 class="font-semibold text-white">How to Generate Summaries:</h4>
                    <ol class="text-sm text-purple-200 space-y-2 list-decimal list-inside">
                        <li>Open File Explorer and navigate to:<br><code class="bg-black/30 px-2 py-1 rounded text-xs ml-4 block mt-1">C:\Users\arnol\Desktop\KnowledgeBaseAI</code></li>
                        <li>Double-click <strong class="text-emerald-400">run_summaries.bat</strong></li>
                        <li>Wait for the script to process your files (100 at a time)</li>
                        <li>Run again to continue processing more files</li>
                        <li>Come back here and load the ai_suggestions.json file in AI Renamer to see summaries!</li>
                    </ol>
                </div>
                <div class="mt-4 p-3 bg-emerald-900/30 border border-emerald-500/30 rounded-lg">
                    <p class="text-sm text-emerald-300"><i class="fas fa-lightbulb mr-2"></i><strong>Tip:</strong> The free Gemini API allows ~1,400 files/day. Run the script multiple times over several days to process all your files.</p>
                </div>
            </div>
            <div class="flex gap-3 p-4 border-t border-white/10">
                <button onclick="closeGenerateSummariesInfo()" class="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-all">Close</button>
                <button onclick="closeGenerateSummariesInfo(); showAIRenamer();" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 rounded-xl transition-all"><i class="fas fa-robot mr-2"></i>Open AI Renamer</button>
            </div>
        </div>
    </div>

    <script>
        let allFiles = [];
        let filteredFiles = [];
        let displayedCount = 0;
        let selectedFiles = new Set();
        let currentFilters = { domain: null, category: null, fileType: null, tag: null, source: null, color: null, rating: null, favoritesOnly: false, minSize: null, maxSize: null, dateAfter: null, dateBefore: null };
        const ITEMS_PER_PAGE = 100;
        let currentPreviewFile = null;
        let contextMenuFile = null;
        let tagsEditorFileId = null;
        let tagsEditorTags = [];
        let userPrefs = { favorites: {}, ratings: {}, colors: {}, notes: {}, customTags: {} };

        // Undo system variables
        let undoStack = [];
        let undoTimeout = null;
        const UNDO_TIMEOUT_MS = 6000;
        const MAX_UNDO_STACK = 20;

        // Smart Search variables
        let smartSearchEnabled = false;
        let currentSearchQuery = '';
        let currentSearchResults = [];
        const domainConfig = {
            'Psychiatry': { color: 'bg-blue-600', icon: 'fa-brain' },
            'Apps & Development': { color: 'bg-green-600', icon: 'fa-code' },
            'Day Trading': { color: 'bg-yellow-600', icon: 'fa-chart-line' },
            'Real Estate': { color: 'bg-red-600', icon: 'fa-home' },
            'AI Projects': { color: 'bg-purple-600', icon: 'fa-robot' },
            'Documents': { color: 'bg-indigo-600', icon: 'fa-file-alt' },
            'Media': { color: 'bg-pink-600', icon: 'fa-photo-video' },
            'Personal': { color: 'bg-teal-600', icon: 'fa-user' },
            'Uncategorized': { color: 'bg-gray-600', icon: 'fa-question' }
        };
        let charts = {};
        const DB_NAME = 'KnowledgeBaseDashboard';
        const DB_VERSION = 1;
        const STORE_NAME = 'knowledgeBase';

        // IndexedDB functions for caching the knowledge base
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveToCacheDB(data) {
            try {
                const db = await openDatabase();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                // Clear existing data and save new
                store.clear();
                store.put({ id: 'knowledgebase', data: data, timestamp: Date.now() });
                return new Promise((resolve, reject) => {
                    tx.oncomplete = () => { db.close(); resolve(true); };
                    tx.onerror = () => { db.close(); reject(tx.error); };
                });
            } catch (e) {
                console.error('Cache save error:', e);
                return false;
            }
        }

        async function loadFromCacheDB() {
            try {
                const db = await openDatabase();
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get('knowledgebase');
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        db.close();
                        if (request.result && request.result.data) {
                            resolve(request.result.data);
                        } else {
                            resolve(null);
                        }
                    };
                    request.onerror = () => { db.close(); reject(request.error); };
                });
            } catch (e) {
                console.error('Cache load error:', e);
                return null;
            }
        }

        async function clearCacheDB() {
            try {
                const db = await openDatabase();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).clear();
                return new Promise((resolve) => {
                    tx.oncomplete = () => { db.close(); resolve(true); };
                    tx.onerror = () => { db.close(); resolve(false); };
                });
            } catch (e) {
                return false;
            }
        }

        function showFilePicker() {
            document.getElementById('loadingSpinner').classList.add('hidden');
            document.getElementById('loadingStatus').textContent = 'Load your organized files to get started';
            document.getElementById('filePickerSection').classList.remove('hidden');
        }

        async function tryAutoLoad() {
            document.getElementById('loadingStatus').textContent = 'Checking for cached data...';
            try {
                const cachedData = await loadFromCacheDB();
                if (cachedData && Array.isArray(cachedData) && cachedData.length > 0) {
                    document.getElementById('loadingStatus').textContent = 'Loading ' + cachedData.length.toLocaleString() + ' files from cache...';
                    allFiles = cachedData;
                    allFiles.forEach(f => {
                        f._favorite = userPrefs.favorites[f.id] || false;
                        f._rating = userPrefs.ratings[f.id] || 0;
                        f._color = userPrefs.colors[f.id] || '';
                        f._notes = userPrefs.notes[f.id] || '';
                        f._customTags = userPrefs.customTags[f.id] || [];
                    });
                    initializeDashboard();
                    toast('Auto-loaded ' + allFiles.length.toLocaleString() + ' files from cache!', 'success');
                } else {
                    // Try to fetch knowledge_base.json from server (for Netlify deployment)
                    await tryFetchFromServer();
                }
            } catch (e) {
                console.error('Auto-load failed:', e);
                await tryFetchFromServer();
            }
        }

        async function tryFetchFromServer() {
            document.getElementById('loadingStatus').textContent = 'Loading knowledge base from server...';
            try {
                const response = await fetch('knowledge_base.json');
                if (response.ok) {
                    const data = await response.json();
                    if (data && Array.isArray(data) && data.length > 0) {
                        document.getElementById('loadingStatus').textContent = 'Processing ' + data.length.toLocaleString() + ' files...';
                        allFiles = data;
                        allFiles.forEach(f => {
                            f._favorite = userPrefs.favorites[f.id] || false;
                            f._rating = userPrefs.ratings[f.id] || 0;
                            f._color = userPrefs.colors[f.id] || '';
                            f._notes = userPrefs.notes[f.id] || '';
                            f._customTags = userPrefs.customTags[f.id] || [];
                        });
                        await saveToCacheDB(allFiles);
                        initializeDashboard();
                        toast('Loaded ' + allFiles.length.toLocaleString() + ' files from server!', 'success');
                        return;
                    }
                }
                showFilePicker();
            } catch (e) {
                console.error('Server fetch failed:', e);
                showFilePicker();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadUserPrefs();

            // Restore saved view mode and sort preferences
            const savedViewMode = localStorage.getItem('kb_viewMode');
            const savedSortBy = localStorage.getItem('kb_sortBy');
            if (savedViewMode) {
                document.getElementById('viewMode').value = savedViewMode;
            }
            if (savedSortBy) {
                document.getElementById('sortBy').value = savedSortBy;
            }

            document.getElementById('fileInput').addEventListener('change', handleFileLoad);
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(filterFiles, 200));
            searchInput.addEventListener('input', debounce(showSearchSuggestions, 100));
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { filterFiles(); hideSearchSuggestions(); } });
            searchInput.addEventListener('focus', showSearchSuggestions);
            searchInput.addEventListener('blur', hideSearchSuggestions);
            document.getElementById('sortBy').addEventListener('change', function() {
                localStorage.setItem('kb_sortBy', this.value);
                sortFiles();
            });
            document.getElementById('viewMode').addEventListener('change', function() {
                localStorage.setItem('kb_viewMode', this.value);
                changeViewMode();
            });
            ['regexMode','caseSensitive','minSize','maxSize','dateAfter','dateBefore'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', filterFiles);
            });
            document.addEventListener('click', (e) => {
                document.getElementById('contextMenu').classList.remove('show');
                // Hide search suggestions if clicking outside
                if (!e.target.closest('#searchInput') && !e.target.closest('#searchSuggestions')) {
                    document.getElementById('searchSuggestions').classList.remove('show');
                }
            });
            document.addEventListener('contextmenu', (e) => {
                if (e.target.closest('.file-card')) {
                    e.preventDefault();
                    contextMenuFile = e.target.closest('.file-card').dataset.id;
                    showContextMenu(e.clientX, e.clientY);
                }
            });
            document.addEventListener('keydown', handleKeyboard);

            // Try to auto-load from cache
            tryAutoLoad();
        });

        function loadUserPrefs() {
            try {
                const saved = localStorage.getItem('kb_prefs_v2');
                if (saved) userPrefs = JSON.parse(saved);
                if (!userPrefs.customTags) userPrefs.customTags = {};
            } catch(e) {}
        }
        function saveUserPrefs() {
            try { localStorage.setItem('kb_prefs_v2', JSON.stringify(userPrefs)); } catch(e) {}
        }

        // ==========================================
        // UNDO SYSTEM FUNCTIONS
        // ==========================================

        function pushToUndoStack(actionType, fileId, previousValue, newValue, description) {
            undoStack.push({
                actionType: actionType,
                fileId: fileId,
                previousValue: previousValue,
                newValue: newValue,
                description: description,
                timestamp: Date.now()
            });
            // Keep only last MAX_UNDO_STACK actions
            if (undoStack.length > MAX_UNDO_STACK) {
                undoStack.shift();
            }
        }

        function showUndoBar(message) {
            const bar = document.getElementById('undoBar');
            const msgEl = document.getElementById('undoMessage');
            const timerProgress = document.getElementById('undoTimerProgress');

            msgEl.textContent = message;

            // Reset and restart timer animation
            timerProgress.style.animation = 'none';
            timerProgress.offsetHeight; // Force reflow
            timerProgress.style.animation = 'undoTimerShrink ' + (UNDO_TIMEOUT_MS / 1000) + 's linear forwards';

            bar.classList.add('show');

            // Clear any existing timeout
            if (undoTimeout) clearTimeout(undoTimeout);

            // Auto-hide after timeout
            undoTimeout = setTimeout(() => {
                hideUndoBar();
            }, UNDO_TIMEOUT_MS);
        }

        function hideUndoBar() {
            const bar = document.getElementById('undoBar');
            bar.classList.remove('show');
            if (undoTimeout) {
                clearTimeout(undoTimeout);
                undoTimeout = null;
            }
        }

        function performUndo() {
            if (undoStack.length === 0) {
                toast('Nothing to undo', 'info');
                return;
            }

            const lastAction = undoStack.pop();

            switch(lastAction.actionType) {
                case 'favorite':
                case 'unfavorite':
                    restoreFavorite(lastAction.fileId, lastAction.previousValue);
                    break;
                case 'rating':
                    restoreRating(lastAction.fileId, lastAction.previousValue);
                    break;
                case 'color':
                    restoreColor(lastAction.fileId, lastAction.previousValue);
                    break;
                case 'tags':
                    restoreTags(lastAction.fileId, lastAction.previousValue);
                    break;
            }

            hideUndoBar();
            toast('Action undone', 'success');
        }

        function restoreFavorite(fileId, previousValue) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            file._favorite = previousValue;
            if (previousValue) {
                userPrefs.favorites[fileId] = true;
            } else {
                delete userPrefs.favorites[fileId];
            }
            saveUserPrefs();

            // Update UI
            document.querySelectorAll('.file-card[data-id="' + fileId + '"] .favorite-btn').forEach(btn => {
                btn.classList.toggle('active', file._favorite);
                btn.classList.toggle('text-red-500', file._favorite);
                btn.classList.toggle('text-gray-500', !file._favorite);
            });
            updateHeaderStats();
            buildSidebar();
        }

        function restoreRating(fileId, previousValue) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            file._rating = previousValue;
            if (previousValue) {
                userPrefs.ratings[fileId] = previousValue;
            } else {
                delete userPrefs.ratings[fileId];
            }
            saveUserPrefs();

            // Update UI
            document.querySelectorAll('.file-card[data-id="' + fileId + '"] .star-rating i').forEach((star, i) => {
                star.classList.toggle('filled', i < file._rating);
            });
            buildSidebar();
        }

        function restoreColor(fileId, previousValue) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            file._color = previousValue;
            if (previousValue) {
                userPrefs.colors[fileId] = previousValue;
            } else {
                delete userPrefs.colors[fileId];
            }
            saveUserPrefs();
            buildSidebar();
            displayedCount = 0;
            displayFiles();
        }

        function restoreTags(fileId, previousValue) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            file._customTags = previousValue ? [...previousValue] : [];
            if (previousValue && previousValue.length > 0) {
                userPrefs.customTags[fileId] = [...previousValue];
            } else {
                delete userPrefs.customTags[fileId];
            }
            saveUserPrefs();
            buildSidebar();
            displayedCount = 0;
            displayFiles();
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); };
        }

        // ==========================================
        // SMART SEARCH FUNCTIONS
        // ==========================================

        function toggleSmartSearch() {
            smartSearchEnabled = !smartSearchEnabled;
            const toggle = document.getElementById('smartSearchToggle');
            const label = document.getElementById('smartSearchLabel');
            if (smartSearchEnabled) {
                toggle.classList.add('active');
                label.innerHTML = '<i class="fas fa-brain mr-1"></i>Smart';
            } else {
                toggle.classList.remove('active');
                label.textContent = 'Exact';
            }
            // Re-run search if there's a query
            const query = document.getElementById('searchInput').value.trim();
            if (query.length >= 2) {
                filterFiles();
            }
            toast(smartSearchEnabled ? 'Smart Search enabled - searches summaries & tags' : 'Exact Match enabled - searches filenames only', 'info');
        }

        function smartSearch(query, files) {
            const queryLower = query.toLowerCase();
            const queryWords = queryLower.split(/\s+/).filter(w => w.length > 2);

            if (queryWords.length === 0) return files;

            const results = files.map(file => {
                let score = 0;
                const matches = { filename: false, summary: false, tags: false, suggestedName: false, matchedTerms: [] };

                // 1. Check filename (highest weight = 10)
                const filenameLower = (file.name || '').toLowerCase();
                queryWords.forEach(word => {
                    if (filenameLower.includes(word)) {
                        score += 10;
                        matches.filename = true;
                        if (!matches.matchedTerms.includes(word)) matches.matchedTerms.push(word);
                    }
                });

                // 2. Check AI summary (medium weight = 5)
                const aiData = aiSuggestions[file.id] || file._aiData || {};
                const summary = (aiData.summary || file._summary || '').toLowerCase();
                if (summary) {
                    queryWords.forEach(word => {
                        if (summary.includes(word)) {
                            score += 5;
                            matches.summary = true;
                            if (!matches.matchedTerms.includes(word)) matches.matchedTerms.push(word);
                        }
                    });
                }

                // 3. Check tags - both AI tags and regular tags (medium-high weight = 7)
                const allTags = [...(file.tags || []), ...(file._customTags || []), ...(aiData.tags || [])];
                allTags.forEach(tag => {
                    const tagLower = tag.toLowerCase();
                    queryWords.forEach(word => {
                        if (tagLower.includes(word) || word.includes(tagLower)) {
                            score += 7;
                            matches.tags = true;
                            if (!matches.matchedTerms.includes(word)) matches.matchedTerms.push(word);
                        }
                    });
                });

                // 4. Check suggested name from AI (lower weight = 3)
                const suggestedName = (aiData.suggested_name || '').toLowerCase();
                if (suggestedName) {
                    queryWords.forEach(word => {
                        if (suggestedName.includes(word)) {
                            score += 3;
                            matches.suggestedName = true;
                            if (!matches.matchedTerms.includes(word)) matches.matchedTerms.push(word);
                        }
                    });
                }

                // 5. Check category and subcategory (lower weight = 2)
                const categoryText = ((file.category || '') + ' ' + (file.subcategory || '') + ' ' + (file.full_category || '')).toLowerCase();
                queryWords.forEach(word => {
                    if (categoryText.includes(word)) {
                        score += 2;
                        if (!matches.matchedTerms.includes(word)) matches.matchedTerms.push(word);
                    }
                });

                return {
                    ...file,
                    _searchScore: score,
                    _searchMatches: matches,
                    _matchedTerms: matches.matchedTerms
                };
            });

            // Filter and sort by score
            return results
                .filter(file => file._searchScore > 0)
                .sort((a, b) => b._searchScore - a._searchScore);
        }

        function exactSearch(query, files) {
            const queryLower = query.toLowerCase();
            const caseSensitive = document.getElementById('caseSensitive')?.checked;
            const regexMode = document.getElementById('regexMode')?.checked;

            return files.filter(file => {
                const searchText = (file.name || '');
                if (regexMode) {
                    try { return new RegExp(query, caseSensitive ? '' : 'i').test(searchText); }
                    catch(e) { return false; }
                } else {
                    // Wildcard support
                    let pattern = query.replace(/[.+^${}()|[\]\\]/g, '\\$&').replace(/\*/g, '.*').replace(/\?/g, '.');
                    return new RegExp(pattern, caseSensitive ? '' : 'i').test(searchText);
                }
            });
        }

        function highlightSearchTerms(text, terms) {
            if (!terms || terms.length === 0 || !text) return text;
            let result = text;
            terms.forEach(term => {
                const regex = new RegExp('(' + term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                result = result.replace(regex, '<span class="search-highlight">$1</span>');
            });
            return result;
        }

        function calculateRelevancePercent(file, queryWords) {
            if (!file._searchScore || !queryWords || queryWords.length === 0) return 0;
            const maxPossibleScore = queryWords.length * (10 + 5 + 7 + 3 + 2); // All sources matched
            return Math.min(100, Math.round((file._searchScore / maxPossibleScore) * 100));
        }

        function updateSearchResultsBar(results, query, isSmartSearch) {
            const bar = document.getElementById('searchResultsBar');
            const text = document.getElementById('searchResultsText');
            const modeIndicator = document.getElementById('searchModeIndicator');
            const sortIndicator = document.getElementById('sortedByRelevance');

            if (query && query.length >= 2) {
                bar.classList.remove('hidden');
                text.innerHTML = '<strong>' + results.length + '</strong> files matching "<em>' + query + '</em>"';

                if (isSmartSearch) {
                    modeIndicator.classList.remove('hidden');
                    sortIndicator.classList.remove('hidden');
                } else {
                    modeIndicator.classList.add('hidden');
                    sortIndicator.classList.add('hidden');
                }
            } else {
                bar.classList.add('hidden');
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearchQuery = '';
            currentSearchResults = [];
            document.getElementById('searchResultsBar').classList.add('hidden');
            filterFiles();
        }

        // Recent searches management
        function saveRecentSearch(query) {
            if (!query || query.length < 3) return;
            let recent = JSON.parse(localStorage.getItem('kb_recent_searches') || '[]');
            recent = recent.filter(s => s.toLowerCase() !== query.toLowerCase());
            recent.unshift(query);
            recent = recent.slice(0, 10);
            localStorage.setItem('kb_recent_searches', JSON.stringify(recent));
        }

        function getRecentSearches() {
            return JSON.parse(localStorage.getItem('kb_recent_searches') || '[]');
        }

        function deleteRecentSearch(query) {
            let recent = getRecentSearches();
            recent = recent.filter(s => s !== query);
            localStorage.setItem('kb_recent_searches', JSON.stringify(recent));
            showSearchSuggestions();
        }

        // Search suggestions
        function showSearchSuggestions() {
            const input = document.getElementById('searchInput');
            const suggestions = document.getElementById('searchSuggestions');
            const query = input.value.trim().toLowerCase();

            const recentSection = document.getElementById('recentSearchesSection');
            const recentList = document.getElementById('recentSearchesList');
            const tagSection = document.getElementById('tagSuggestionsSection');
            const tagList = document.getElementById('tagSuggestionsList');
            const tips = document.getElementById('searchTips');

            // Get recent searches
            const recentSearches = getRecentSearches();

            // Get all tags for suggestions
            const tagCounts = {};
            allFiles.forEach(f => {
                const aiData = aiSuggestions[f.id] || f._aiData || {};
                const allTags = [...(f.tags || []), ...(aiData.tags || [])];
                allTags.forEach(tag => {
                    if (tag && tag !== 'uncategorized') {
                        tagCounts[tag.toLowerCase()] = (tagCounts[tag.toLowerCase()] || 0) + 1;
                    }
                });
            });
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);

            // If no query, show tips and recent searches
            if (!query) {
                tips.classList.remove('hidden');

                if (recentSearches.length > 0) {
                    recentSection.classList.remove('hidden');
                    recentList.innerHTML = recentSearches.slice(0, 5).map(s =>
                        '<div class="search-suggestion" onclick="useSearchSuggestion(\'' + s.replace(/'/g, "\\'") + '\')">' +
                        '<i class="fas fa-history text-purple-400"></i>' +
                        '<span class="flex-1">' + s + '</span>' +
                        '<button onclick="event.stopPropagation(); deleteRecentSearch(\'' + s.replace(/'/g, "\\'") + '\')" class="text-gray-500 hover:text-red-400"><i class="fas fa-times text-xs"></i></button>' +
                        '</div>'
                    ).join('');
                } else {
                    recentSection.classList.add('hidden');
                }

                tagSection.classList.add('hidden');
                suggestions.classList.add('show');
                return;
            }

            tips.classList.add('hidden');

            // Filter tags matching query
            const matchingTags = sortedTags.filter(([tag]) => tag.includes(query)).slice(0, 5);
            if (matchingTags.length > 0) {
                tagSection.classList.remove('hidden');
                tagList.innerHTML = matchingTags.map(([tag, count]) =>
                    '<div class="search-suggestion search-suggestion-tag" onclick="useSearchSuggestion(\'' + tag + '\')">' +
                    '<i class="fas fa-tag text-purple-400"></i>' +
                    '<span class="flex-1">' + tag + '</span>' +
                    '<span class="text-xs text-purple-400">' + count + ' files</span>' +
                    '</div>'
                ).join('');
            } else {
                tagSection.classList.add('hidden');
            }

            // Filter recent searches matching query
            const matchingRecent = recentSearches.filter(s => s.toLowerCase().includes(query)).slice(0, 3);
            if (matchingRecent.length > 0) {
                recentSection.classList.remove('hidden');
                recentList.innerHTML = matchingRecent.map(s =>
                    '<div class="search-suggestion search-suggestion-recent" onclick="useSearchSuggestion(\'' + s.replace(/'/g, "\\'") + '\')">' +
                    '<i class="fas fa-history text-gray-400"></i>' +
                    '<span class="flex-1">' + s + '</span>' +
                    '</div>'
                ).join('');
            } else if (!query) {
                recentSection.classList.remove('hidden');
            } else {
                recentSection.classList.add('hidden');
            }

            if (matchingTags.length > 0 || matchingRecent.length > 0 || !query) {
                suggestions.classList.add('show');
            } else {
                suggestions.classList.remove('show');
            }
        }

        function hideSearchSuggestions() {
            setTimeout(() => {
                document.getElementById('searchSuggestions').classList.remove('show');
            }, 200);
        }

        function useSearchSuggestion(text) {
            document.getElementById('searchInput').value = text;
            document.getElementById('searchSuggestions').classList.remove('show');
            filterFiles();
        }

        // ============================================
        // RELATED FILES FUNCTIONS
        // ============================================

        // Stop words to filter out from summary comparison
        const stopWords = new Set([
            'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with',
            'by', 'from', 'as', 'is', 'was', 'are', 'were', 'been', 'be', 'have', 'has', 'had',
            'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must',
            'this', 'that', 'these', 'those', 'it', 'its', 'they', 'them', 'their', 'we', 'our',
            'you', 'your', 'he', 'she', 'him', 'her', 'his', 'i', 'me', 'my', 'file', 'document',
            'contains', 'about', 'also', 'just', 'more', 'some', 'such', 'than', 'then', 'there',
            'what', 'when', 'where', 'which', 'who', 'how', 'all', 'each', 'other', 'into', 'through'
        ]);

        function extractKeywords(text) {
            if (!text) return [];
            return text.toLowerCase()
                .replace(/[^a-z0-9\s]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 3 && !stopWords.has(word));
        }

        function getSharedTags(file1, file2) {
            const tags1 = new Set([
                ...(file1.ai_tags || []),
                ...(file1._customTags || []),
                ...(file1.tags || [])
            ].map(t => t.toLowerCase()));

            const tags2 = new Set([
                ...(file2.ai_tags || []),
                ...(file2._customTags || []),
                ...(file2.tags || [])
            ].map(t => t.toLowerCase()));

            const shared = [];
            tags1.forEach(tag => {
                if (tags2.has(tag)) shared.push(tag);
            });
            return shared;
        }

        function calculateSimilarity(file1, file2) {
            let score = 0;

            // 1. Shared tags: 10 points each, +20 bonus for 5+
            const sharedTags = getSharedTags(file1, file2);
            score += sharedTags.length * 10;
            if (sharedTags.length >= 5) score += 20;

            // 2. Summary keyword overlap: 2 points per meaningful word
            const keywords1 = extractKeywords(file1.ai_summary || file1.summary || '');
            const keywords2 = extractKeywords(file2.ai_summary || file2.summary || '');
            const keywordSet2 = new Set(keywords2);
            let keywordOverlap = 0;
            keywords1.forEach(kw => {
                if (keywordSet2.has(kw)) keywordOverlap++;
            });
            score += keywordOverlap * 2;

            // 3. Same file type: 3 points
            const ext1 = (file1.extension || '').toLowerCase();
            const ext2 = (file2.extension || '').toLowerCase();
            if (ext1 && ext2 && ext1 === ext2) score += 3;

            // 4. Same/similar folder path: 5 points
            const folder1 = (file1.relative_path || file1.path || '').replace(/[^/\\]+$/, '');
            const folder2 = (file2.relative_path || file2.path || '').replace(/[^/\\]+$/, '');
            if (folder1 && folder2 && folder1 === folder2) score += 5;

            return { score, sharedTags, keywordOverlap };
        }

        function findRelatedFiles(targetFile, allFilesArray, maxResults = 10) {
            const results = [];

            for (const file of allFilesArray) {
                // Skip self
                if (file.id === targetFile.id || file.path === targetFile.path) continue;

                const similarity = calculateSimilarity(targetFile, file);

                // Only include if there's some similarity
                if (similarity.score > 0) {
                    results.push({
                        file: file,
                        score: similarity.score,
                        sharedTags: similarity.sharedTags,
                        keywordOverlap: similarity.keywordOverlap
                    });
                }
            }

            // Sort by score descending and return top N
            results.sort((a, b) => b.score - a.score);
            return results.slice(0, maxResults);
        }

        function getSimilarityLevel(score) {
            if (score >= 50) return { label: 'Very Similar', class: 'similarity-high' };
            if (score >= 25) return { label: 'Similar', class: 'similarity-medium' };
            return { label: 'Somewhat Related', class: 'similarity-low' };
        }

        function getFileIconForRelated(file) {
            const ext = (file.extension || '').toLowerCase();
            const iconMap = {
                '.pdf': 'fas fa-file-pdf',
                '.doc': 'fas fa-file-word',
                '.docx': 'fas fa-file-word',
                '.xls': 'fas fa-file-excel',
                '.xlsx': 'fas fa-file-excel',
                '.ppt': 'fas fa-file-powerpoint',
                '.pptx': 'fas fa-file-powerpoint',
                '.txt': 'fas fa-file-alt',
                '.md': 'fas fa-file-alt',
                '.jpg': 'fas fa-file-image',
                '.jpeg': 'fas fa-file-image',
                '.png': 'fas fa-file-image',
                '.gif': 'fas fa-file-image',
                '.mp3': 'fas fa-file-audio',
                '.wav': 'fas fa-file-audio',
                '.mp4': 'fas fa-file-video',
                '.mov': 'fas fa-file-video',
                '.zip': 'fas fa-file-archive',
                '.rar': 'fas fa-file-archive'
            };
            return iconMap[ext] || 'fas fa-file';
        }

        function populateRelatedFiles(targetFile) {
            const relatedList = document.getElementById('relatedFilesList');
            const relatedCount = document.getElementById('relatedFilesCount');
            const relatedEmpty = document.getElementById('relatedFilesEmpty');
            const relatedSection = document.getElementById('relatedFilesSection');

            if (!relatedList || !relatedSection) return;

            relatedList.innerHTML = '';

            const related = findRelatedFiles(targetFile, allFiles, 10);

            if (related.length === 0) {
                relatedEmpty.classList.remove('hidden');
                relatedCount.textContent = '(0 found)';
                return;
            }

            relatedEmpty.classList.add('hidden');
            relatedCount.textContent = '(' + related.length + ' found)';

            related.forEach(item => {
                const similarity = getSimilarityLevel(item.score);
                const icon = getFileIconForRelated(item.file);
                const summary = item.file.ai_summary || item.file.summary || 'No summary available';
                const displayName = item.file.ai_suggested_name || item.file.name || 'Unknown';

                const card = document.createElement('div');
                card.className = 'related-file-card';
                card.onclick = () => openRelatedFile(item.file);

                let sharedTagsHtml = '';
                if (item.sharedTags.length > 0) {
                    const tagsToShow = item.sharedTags.slice(0, 3);
                    sharedTagsHtml = '<div class="shared-tags-preview">' +
                        tagsToShow.map(t => '<span class="shared-tag-mini">' + t + '</span>').join('') +
                        (item.sharedTags.length > 3 ? '<span class="shared-tag-mini">+' + (item.sharedTags.length - 3) + '</span>' : '') +
                        '</div>';
                }

                card.innerHTML =
                    '<div class="related-file-name">' +
                        '<i class="' + icon + '"></i>' +
                        '<span>' + displayName + '</span>' +
                    '</div>' +
                    '<div class="related-file-summary">' + summary + '</div>' +
                    '<div class="related-file-meta">' +
                        '<span class="related-similarity-badge ' + similarity.class + '">' + similarity.label + ' (' + item.score + ' pts)</span>' +
                        sharedTagsHtml +
                    '</div>';

                relatedList.appendChild(card);
            });
        }

        function openRelatedFile(file) {
            // Close current preview and open the related file
            closePreview();
            setTimeout(() => {
                previewFile(file);
            }, 100);
        }

        function countRelatedFiles(targetFile) {
            // Quick count of related files for card indicator
            let count = 0;
            for (const file of allFiles) {
                if (file.id === targetFile.id || file.path === targetFile.path) continue;
                const similarity = calculateSimilarity(targetFile, file);
                if (similarity.score >= 15) count++; // Only count meaningful relationships
                if (count >= 99) break; // Cap for performance
            }
            return count;
        }

        function handleFileLoad(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(evt) {
                try {
                    const rawData = JSON.parse(evt.target.result);
                    allFiles = rawData;
                    allFiles.forEach(f => {
                        f._favorite = userPrefs.favorites[f.id] || false;
                        f._rating = userPrefs.ratings[f.id] || 0;
                        f._color = userPrefs.colors[f.id] || '';
                        f._notes = userPrefs.notes[f.id] || '';
                        f._customTags = userPrefs.customTags[f.id] || [];
                    });
                    // Save to cache for auto-load next time
                    await saveToCacheDB(rawData);
                    initializeDashboard();
                    toast('Loaded ' + allFiles.length.toLocaleString() + ' files! (Cached for next time)', 'success');
                } catch (err) { toast('Error: ' + err.message, 'error'); }
            };
            reader.readAsText(file);
        }

        function initializeDashboard() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            updateHeaderStats();
            buildSidebar();
            filteredFiles = [...allFiles];
            displayFiles();
        }
        function loadNewFile() { document.getElementById('fileInput').click(); }
        async function refreshFromFile() {
            if (confirm('This will clear the cache and let you select a new file. Continue?')) {
                await clearCacheDB();
                toast('Cache cleared! Select a new file.', 'info');
                document.getElementById('fileInput').click();
            }
        }

        function updateHeaderStats() {
            const domains = new Set(), categories = new Set();
            let categorized = 0, totalSize = 0, favorites = 0;
            allFiles.forEach(f => {
                if (f.category) domains.add(f.category);
                if (f.full_category) categories.add(f.full_category);
                if (f.category && f.category !== 'Uncategorized') categorized++;
                if (f.size) totalSize += parseInt(f.size) || 0;
                if (f._favorite) favorites++;
            });
            document.getElementById('totalFiles').textContent = allFiles.length.toLocaleString();
            document.getElementById('sidebarFileCount').textContent = allFiles.length.toLocaleString() + ' files';
            document.getElementById('categorizedFiles').textContent = categorized.toLocaleString();
            document.getElementById('totalDomains').textContent = domains.size;
            document.getElementById('totalCategories').textContent = categories.size;
            document.getElementById('totalFavorites').textContent = favorites;
            document.getElementById('totalSize').textContent = formatSize(totalSize);
            document.getElementById('favCount').textContent = favorites;
        }

        function buildSidebar() {
            const domains = {}, categories = {}, fileTypes = {}, tags = {}, colorCounts = {}, sourceCounts = {};
            let r5 = 0, r4 = 0;
            allFiles.forEach(f => {
                const domain = f.category || 'Uncategorized';
                domains[domain] = (domains[domain] || 0) + 1;
                const cat = f.full_category || f.category || 'Uncategorized';
                categories[cat] = (categories[cat] || 0) + 1;
                const type = getFileTypeName(f.mime_type || '');
                fileTypes[type] = (fileTypes[type] || 0) + 1;
                if (f.tags) f.tags.forEach(tag => { if (tag && tag !== 'uncategorized') tags[tag] = (tags[tag] || 0) + 1; });
                if (f._customTags) f._customTags.forEach(tag => { tags[tag] = (tags[tag] || 0) + 1; });
                if (f._color) colorCounts[f._color] = (colorCounts[f._color] || 0) + 1;
                const src = f.source || 'google_drive';
                sourceCounts[src] = (sourceCounts[src] || 0) + 1;
                if (f._rating === 5) r5++;
                if (f._rating >= 4) r4++;
            });
            document.getElementById('domainList').innerHTML = Object.entries(domains).sort((a,b) => b[1]-a[1]).map(([domain, count]) => {
                const cfg = domainConfig[domain] || { color: 'bg-gray-600', icon: 'fa-folder' };
                return '<button onclick="filterByDomain(\'' + domain + '\')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-sm flex items-center justify-between domain-filter" data-domain="' + domain + '"><span><i class="fas ' + cfg.icon + ' mr-2 text-purple-400"></i>' + domain + '</span><span class="text-purple-400 text-xs">' + count.toLocaleString() + '</span></button>';
            }).join('');
            document.getElementById('categoryList').innerHTML = Object.entries(categories).filter(([cat]) => cat.includes(' - ')).sort((a,b) => b[1]-a[1]).slice(0,25).map(([category, count]) => {
                const subcat = category.split(' - ')[1] || category;
                return '<button onclick="filterByCategory(\'' + category.replace(/'/g, "\\'") + '\')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-xs flex items-center justify-between category-filter" data-category="' + category + '"><span class="truncate">' + subcat + '</span><span class="text-purple-400">' + count.toLocaleString() + '</span></button>';
            }).join('');
            document.getElementById('fileTypeList').innerHTML = Object.entries(fileTypes).sort((a,b) => b[1]-a[1]).slice(0,12).map(([type, count]) => '<button onclick="filterByFileType(\'' + type + '\')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10 transition-all text-xs flex items-center justify-between filetype-filter" data-filetype="' + type + '"><span>' + getFileTypeIcon(type) + ' ' + type + '</span><span class="text-purple-400">' + count.toLocaleString() + '</span></button>').join('');
            document.getElementById('tagCloud').innerHTML = Object.entries(tags).sort((a,b) => b[1]-a[1]).slice(0,20).map(([tag]) => '<button onclick="filterByTag(\'' + tag + '\')" class="px-2 py-1 bg-white/10 hover:bg-purple-600 rounded-full text-xs transition-all tag-filter" data-tag="' + tag + '">' + tag + '</button>').join('');
            // Update color counts (no greying out - just show counts)
            document.querySelectorAll('.clr-count').forEach(el => { 
                el.textContent = colorCounts[el.dataset.color] || 0;
            });
            // Update rating counts
            document.getElementById('r5Count').textContent = r5;
            document.getElementById('r4Count').textContent = r4;
            document.getElementById('gdriveCount').textContent = sourceCounts['google_drive'] || 0;
            document.getElementById('localCount').textContent = sourceCounts['local'] || 0;
            const md5s = {};
            allFiles.forEach(f => { if (f.md5) md5s[f.md5] = (md5s[f.md5] || 0) + 1; });
            document.getElementById('dupCount').textContent = Object.values(md5s).filter(c => c > 1).length;
        }

        function filterByDomain(domain) {
            // If clicking same domain, toggle off. Otherwise, set new domain.
            currentFilters.domain = currentFilters.domain === domain ? null : domain;
            // When setting a domain, clear category since they're related
            if (currentFilters.domain) {
                currentFilters.category = null;
                document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active-filter'));
            }
            updateActiveFiltersUI();
            filterFiles();
            document.querySelectorAll('.domain-filter').forEach(btn => btn.classList.toggle('active-filter', btn.dataset.domain === currentFilters.domain));
        }

        function filterByCategory(category) {
            currentFilters.category = currentFilters.category === category ? null : category;
            // Clear file type filter when selecting a category (they overlap)
            if (currentFilters.category) {
                currentFilters.fileType = null;
                document.querySelectorAll('.filetype-filter').forEach(btn => btn.classList.remove('active-filter'));
            }
            updateActiveFiltersUI();
            filterFiles();
            document.querySelectorAll('.category-filter').forEach(btn => btn.classList.toggle('active-filter', btn.dataset.category === currentFilters.category));
        }

        function filterByFileType(type) {
            currentFilters.fileType = currentFilters.fileType === type ? null : type;
            // Clear category filter when selecting a file type (they overlap)
            if (currentFilters.fileType) {
                currentFilters.category = null;
                document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active-filter'));
            }
            updateActiveFiltersUI();
            filterFiles();
            document.querySelectorAll('.filetype-filter').forEach(btn => btn.classList.toggle('active-filter', btn.dataset.filetype === currentFilters.fileType));
        }

        function filterByTag(tag) {
            currentFilters.tag = currentFilters.tag === tag ? null : tag;
            updateActiveFiltersUI();
            filterFiles();
            document.querySelectorAll('.tag-filter').forEach(btn => btn.classList.toggle('active-filter', btn.dataset.tag === currentFilters.tag));
        }

        function filterBySource(source) {
            currentFilters.source = currentFilters.source === source ? null : source;
            updateActiveFiltersUI();
            filterFiles();
            document.querySelectorAll('.source-filter').forEach(btn => btn.classList.toggle('active-filter', btn.dataset.source === currentFilters.source));
        }

        function filterByColor(color) {
            currentFilters.color = currentFilters.color === color ? null : color;
            updateActiveFiltersUI();
            filterFiles();
        }

        function filterByRating(minRating) {
            currentFilters.rating = currentFilters.rating === minRating ? null : minRating;
            updateActiveFiltersUI();
            filterFiles();
        }

        function showFavorites() {
            currentFilters.favoritesOnly = !currentFilters.favoritesOnly;
            updateActiveFiltersUI();
            filterFiles();
        }

        function showRecent() {
            clearAllFilters();
            filteredFiles = [...allFiles].sort((a, b) => new Date(b.modified || 0) - new Date(a.modified || 0)).slice(0, 50);
            displayedCount = 0;
            displayFiles();
            toast('Showing 50 most recent files', 'info');
        }

        function updateActiveFiltersUI() {
            const container = document.getElementById('activeFilters');
            const filters = [];
            if (currentFilters.domain) filters.push({ type: 'Domain', value: currentFilters.domain });
            if (currentFilters.category) filters.push({ type: 'Category', value: currentFilters.category.split(' - ')[1] || currentFilters.category });
            if (currentFilters.fileType) filters.push({ type: 'Type', value: currentFilters.fileType });
            if (currentFilters.tag) filters.push({ type: 'Tag', value: currentFilters.tag });
            if (currentFilters.source) filters.push({ type: 'Source', value: currentFilters.source });
            if (currentFilters.color) filters.push({ type: 'Color', value: currentFilters.color });
            if (currentFilters.rating) filters.push({ type: 'Rating', value: currentFilters.rating + '+ stars' });
            if (currentFilters.favoritesOnly) filters.push({ type: 'Favorites', value: 'Only' });
            if (currentFilters.minSize) filters.push({ type: 'Min', value: formatSize(parseInt(currentFilters.minSize)) });
            if (currentFilters.maxSize) filters.push({ type: 'Max', value: formatSize(parseInt(currentFilters.maxSize)) });
            if (currentFilters.dateAfter) filters.push({ type: 'After', value: currentFilters.dateAfter });
            if (currentFilters.dateBefore) filters.push({ type: 'Before', value: currentFilters.dateBefore });
            if (filters.length > 0) {
                container.classList.remove('hidden');
                container.innerHTML = filters.map((f, i) => '<span class="px-3 py-1 bg-purple-600 rounded-full text-sm flex items-center gap-2">' + f.type + ': ' + f.value + '<button onclick="clearFilterByIndex(' + i + ')" class="hover:text-red-300"><i class="fas fa-times"></i></button></span>').join('');
            } else {
                container.classList.add('hidden');
            }
        }

        function clearFilterByIndex(index) {
            const keys = ['domain', 'category', 'fileType', 'tag', 'source', 'color', 'rating', 'favoritesOnly', 'minSize', 'maxSize', 'dateAfter', 'dateBefore'];
            let activeIndex = 0;
            for (const key of keys) {
                if (currentFilters[key]) {
                    if (activeIndex === index) {
                        currentFilters[key] = key === 'favoritesOnly' ? false : null;
                        if (key === 'minSize') document.getElementById('minSize').value = '';
                        if (key === 'maxSize') document.getElementById('maxSize').value = '';
                        if (key === 'dateAfter') document.getElementById('dateAfter').value = '';
                        if (key === 'dateBefore') document.getElementById('dateBefore').value = '';
                        break;
                    }
                    activeIndex++;
                }
            }
            updateActiveFiltersUI();
            filterFiles();
            document.querySelectorAll('.active-filter').forEach(el => el.classList.remove('active-filter'));
        }

        function clearAllFilters() {
            currentFilters = { domain: null, category: null, fileType: null, tag: null, source: null, color: null, rating: null, favoritesOnly: false, minSize: null, maxSize: null, dateAfter: null, dateBefore: null };
            document.getElementById('searchInput').value = '';
            document.getElementById('minSize').value = '';
            document.getElementById('maxSize').value = '';
            document.getElementById('dateAfter').value = '';
            document.getElementById('dateBefore').value = '';
            document.querySelectorAll('.active-filter').forEach(el => el.classList.remove('active-filter'));
            updateActiveFiltersUI();
            filteredFiles = [...allFiles];
            displayedCount = 0;
            displayFiles();
            toast('Filters cleared', 'info');
        }

        function filterFiles() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const regexMode = document.getElementById('regexMode')?.checked;
            const caseSensitive = document.getElementById('caseSensitive')?.checked;
            currentFilters.minSize = document.getElementById('minSize')?.value || null;
            currentFilters.maxSize = document.getElementById('maxSize')?.value || null;
            currentFilters.dateAfter = document.getElementById('dateAfter')?.value || null;
            currentFilters.dateBefore = document.getElementById('dateBefore')?.value || null;

            // Store search query for highlighting
            currentSearchQuery = searchTerm;

            // Start with all files
            let workingFiles = allFiles;

            // Apply smart search or exact search based on mode
            if (searchTerm && searchTerm.length >= 2) {
                if (smartSearchEnabled) {
                    // Use smart search - searches summaries, tags, etc.
                    workingFiles = smartSearch(searchTerm, allFiles);
                    // Save recent search
                    saveRecentSearch(searchTerm);
                } else {
                    // Use existing exact/wildcard/regex search
                    workingFiles = allFiles.filter(file => {
                        const allTags = [...(file.tags || []), ...(file._customTags || [])].join(' ');
                        const searchText = (file.name || '') + ' ' + (file.category || '') + ' ' + (file.full_category || '') + ' ' + allTags;
                        let matches = false;
                        if (regexMode) { try { matches = new RegExp(searchTerm, caseSensitive ? '' : 'i').test(searchText); } catch(e) { matches = false; } }
                        else { let pattern = searchTerm.replace(/[.+^${}()|[\]\\]/g, '\\$&').replace(/\*/g, '.*').replace(/\?/g, '.'); matches = new RegExp(pattern, caseSensitive ? '' : 'i').test(searchText); }
                        return matches;
                    });
                    // Save recent search
                    if (workingFiles.length > 0) saveRecentSearch(searchTerm);
                }
            }

            // Apply other filters
            filteredFiles = workingFiles.filter(file => {
                if (currentFilters.domain && file.category !== currentFilters.domain) return false;
                if (currentFilters.category && file.full_category !== currentFilters.category) return false;
                if (currentFilters.fileType && getFileTypeName(file.mime_type || '') !== currentFilters.fileType) return false;
                if (currentFilters.tag) { const allTags = [...(file.tags || []), ...(file._customTags || [])]; if (!allTags.includes(currentFilters.tag)) return false; }
                if (currentFilters.source && (file.source || 'google_drive') !== currentFilters.source) return false;
                if (currentFilters.color && file._color !== currentFilters.color) return false;
                if (currentFilters.rating && (file._rating || 0) < currentFilters.rating) return false;
                if (currentFilters.favoritesOnly && !file._favorite) return false;
                const fileSize = parseInt(file.size) || 0;
                if (currentFilters.minSize && fileSize < parseInt(currentFilters.minSize)) return false;
                if (currentFilters.maxSize && fileSize > parseInt(currentFilters.maxSize)) return false;
                const fileDate = new Date(file.modified || file.created || 0);
                if (currentFilters.dateAfter && fileDate < new Date(currentFilters.dateAfter)) return false;
                if (currentFilters.dateBefore && fileDate > new Date(currentFilters.dateBefore + 'T23:59:59')) return false;
                return true;
            });

            // Update search results bar
            updateSearchResultsBar(filteredFiles, searchTerm, smartSearchEnabled);

            // Warn if filter combination results in 0 files
            if (filteredFiles.length === 0) {
                const activeFilterCount = Object.values(currentFilters).filter(v => v && v !== false).length;
                if (activeFilterCount > 1) {
                    toast('No files match all filters. Try removing some filters.', 'info');
                }
            }

            // When using smart search, skip the regular sort to preserve relevance order
            if (smartSearchEnabled && searchTerm && searchTerm.length >= 2) {
                displayedCount = 0; selectedFiles.clear(); updateActiveFiltersUI(); displayFiles();
            } else {
                displayedCount = 0; selectedFiles.clear(); updateActiveFiltersUI(); sortFiles();
            }
        }

        function sortFiles() {
            const sortBy = document.getElementById('sortBy').value;
            filteredFiles.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return (a.name || '').localeCompare(b.name || '');
                    case 'modified': return new Date(b.modified || 0) - new Date(a.modified || 0);
                    case 'created': return new Date(b.created || 0) - new Date(a.created || 0);
                    case 'category': return (a.full_category || '').localeCompare(b.full_category || '');
                    case 'confidence': return (b.confidence || 0) - (a.confidence || 0);
                    case 'rating': return (b._rating || 0) - (a._rating || 0);
                    case 'size': return (parseInt(b.size) || 0) - (parseInt(a.size) || 0);
                    default: return 0;
                }
            });
            displayedCount = 0; displayFiles();
        }
        function changeViewMode() {
            displayedCount = 0;
            const viewMode = document.getElementById('viewMode').value;
            const dualContainer = document.getElementById('dualPaneContainer');
            const fileGrid = document.getElementById('fileGrid');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            // Toggle visibility based on view mode
            if (viewMode === 'dual') {
                dualContainer.classList.remove('hidden');
                fileGrid.classList.add('hidden');
                loadMoreBtn.classList.add('hidden');
            } else {
                dualContainer.classList.add('hidden');
                fileGrid.classList.remove('hidden');
            }

            // Save to localStorage
            localStorage.setItem('kb_viewMode', viewMode);

            displayFiles();
        }

        function displayFiles() {
            const grid = document.getElementById('fileGrid');
            const viewMode = document.getElementById('viewMode').value;

            // Handle dual-pane view separately
            if (viewMode === 'dual') {
                renderDualPaneView();
                return;
            }

            if (viewMode === 'kanban') { renderKanbanView(); return; }
            const startIndex = displayedCount;
            const endIndex = Math.min(displayedCount + ITEMS_PER_PAGE, filteredFiles.length);
            if (startIndex === 0) {
                grid.innerHTML = '';
                grid.className = viewMode === 'list' ? 'flex flex-col gap-2' : viewMode === 'compact' ? 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2' : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            }
            filteredFiles.slice(startIndex, endIndex).forEach(file => { grid.appendChild(createFileCard(file, viewMode)); });
            displayedCount = endIndex;
            document.getElementById('resultsCount').textContent = 'Showing ' + displayedCount.toLocaleString() + ' of ' + filteredFiles.length.toLocaleString() + ' files';
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            loadMoreBtn.classList.toggle('hidden', displayedCount >= filteredFiles.length);
            if (displayedCount < filteredFiles.length) { loadMoreBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Load More (' + (filteredFiles.length - displayedCount).toLocaleString() + ' remaining)'; }
        }
        function loadMore() { displayFiles(); }

        function renderKanbanView() {
            const grid = document.getElementById('fileGrid');
            grid.className = 'kanban-container';
            const byDomain = {};
            filteredFiles.forEach(f => { const d = f.category || 'Uncategorized'; (byDomain[d] = byDomain[d] || []).push(f); });
            grid.innerHTML = Object.entries(byDomain).map(([domain, files]) => {
                const cfg = domainConfig[domain] || { color: 'bg-gray-600', icon: 'fa-folder' };
                return '<div class="kanban-column"><div class="kanban-header"><span><i class="fas ' + cfg.icon + ' mr-2"></i>' + domain + '</span><span class="text-xs text-purple-400">' + files.length + '</span></div><div class="kanban-cards">' + files.slice(0,50).map(f => '<div class="kanban-card file-card" data-id="' + f.id + '" style="border-left-color: ' + (f._color ? getColorHex(f._color) : 'transparent') + '" onclick="previewFile(\'' + f.id + '\')"><div class="flex justify-between items-start mb-1"><span class="text-xs truncate flex-1">' + (f.name || 'Unnamed') + '</span>' + (f._favorite ? '<i class="fas fa-heart text-red-500 text-xs ml-1"></i>' : '') + '</div><div class="text-xs text-purple-400">' + (f.subcategory || '') + '</div>' + (f._rating ? '<div class="text-xs text-yellow-400 mt-1">' + '&#9733;'.repeat(f._rating) + '</div>' : '') + '</div>').join('') + '</div></div>';
            }).join('');
            displayedCount = filteredFiles.length;
            document.getElementById('resultsCount').textContent = 'Showing ' + filteredFiles.length.toLocaleString() + ' files in Kanban';
            document.getElementById('loadMoreBtn').classList.add('hidden');
        }

        // ============================================================
        // DUAL-PANE VIEW FUNCTIONS
        // ============================================================

        let selectedDualPaneFolder = null;

        function renderDualPaneView() {
            const dualContainer = document.getElementById('dualPaneContainer');
            const fileGrid = document.getElementById('fileGrid');

            // Make sure dual pane is visible and file grid is hidden
            dualContainer.classList.remove('hidden');
            fileGrid.classList.add('hidden');
            document.getElementById('loadMoreBtn').classList.add('hidden');

            // Populate the folder list
            renderDualPaneFolders();

            // If a folder was previously selected, show its files
            if (selectedDualPaneFolder) {
                renderDualPaneFiles(selectedDualPaneFolder);
            } else {
                // Show placeholder
                document.getElementById('dualPaneFiles').innerHTML = `
                    <p class="text-gray-400 col-span-full text-center py-12">
                        <i class="fas fa-hand-pointer text-4xl mb-4 block text-purple-400"></i>
                        Click a domain on the left to view files
                    </p>
                `;
                document.getElementById('dualPaneTitle').innerHTML = '<i class="fas fa-folder-open text-yellow-400"></i> Select a domain';
                document.getElementById('dualPaneCount').textContent = '';
            }

            // Update results count
            document.getElementById('resultsCount').textContent = 'Dual-Pane view: ' + filteredFiles.length.toLocaleString() + ' files';
        }

        function renderDualPaneFolders() {
            const container = document.getElementById('dualPaneFolders');

            // Get unique domains and their file counts from filtered files
            const domainCounts = {};
            filteredFiles.forEach(file => {
                const domain = file.category || 'Uncategorized';
                domainCounts[domain] = (domainCounts[domain] || 0) + 1;
            });

            // Sort domains alphabetically
            const sortedDomains = Object.keys(domainCounts).sort();

            if (sortedDomains.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No domains found</p>';
                return;
            }

            // Create folder items
            container.innerHTML = sortedDomains.map(domain => {
                const config = domainConfig[domain] || { color: 'bg-gray-600', icon: 'fa-folder' };
                const isActive = selectedDualPaneFolder === domain;
                const escapedDomain = domain.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                    <div class="dual-folder-item ${isActive ? 'active' : ''}" onclick="selectDualPaneFolder('${escapedDomain}')">
                        <i class="fas ${config.icon} folder-icon"></i>
                        <span class="folder-name">${domain}</span>
                        <span class="folder-count">${domainCounts[domain].toLocaleString()}</span>
                    </div>
                `;
            }).join('');
        }

        function selectDualPaneFolder(domain) {
            selectedDualPaneFolder = domain;
            renderDualPaneFolders(); // Re-render to update active state
            renderDualPaneFiles(domain);
        }

        function renderDualPaneFiles(domain) {
            const container = document.getElementById('dualPaneFiles');
            const titleEl = document.getElementById('dualPaneTitle');
            const countEl = document.getElementById('dualPaneCount');

            // Filter files by selected domain
            const domainFiles = filteredFiles.filter(f => (f.category || 'Uncategorized') === domain);

            // Update header
            const config = domainConfig[domain] || { color: 'bg-gray-600', icon: 'fa-folder' };
            titleEl.innerHTML = `<i class="fas ${config.icon} text-yellow-400"></i> ${domain}`;
            countEl.textContent = `${domainFiles.length.toLocaleString()} files`;

            if (domainFiles.length === 0) {
                container.innerHTML = `
                    <p class="text-gray-400 col-span-full text-center py-12">
                        <i class="fas fa-folder-open text-4xl mb-4 block text-gray-600"></i>
                        No files in this domain
                    </p>
                `;
                return;
            }

            // Render file cards (limit to 200 for performance)
            const maxFiles = 200;
            const filesToShow = domainFiles.slice(0, maxFiles);

            container.innerHTML = filesToShow.map(file => {
                const fileType = getFileTypeName(file.mime_type || '');
                const icon = getFileTypeIcon(fileType);
                const colorStyle = file._color ? `border-left: 3px solid ${getColorHex(file._color)};` : '';
                const stars = file._rating ? ''.repeat(file._rating) : '';
                const favorite = file._favorite ? '<i class="fas fa-heart text-red-500"></i>' : '';

                return `
                    <div class="dual-file-card" style="${colorStyle}" onclick="previewFile('${file.id}')" title="${(file.name || 'Unnamed').replace(/"/g, '&quot;')}">
                        <div class="flex items-start gap-3">
                            <span class="file-icon text-purple-400">${icon}</span>
                            <div class="flex-1 min-w-0">
                                <p class="file-name">${file.name || 'Unnamed'}</p>
                                <p class="file-category">${file.subcategory || file.full_category || fileType}</p>
                            </div>
                        </div>
                        <div class="file-meta">
                            <span>${formatFileSize(file.size || 0)}</span>
                            <span class="flex items-center gap-2">
                                <span class="file-rating">${stars}</span>
                                ${favorite}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            // If more files exist, show a note
            if (domainFiles.length > maxFiles) {
                container.innerHTML += `
                    <p class="text-gray-500 text-sm col-span-full text-center py-4 border-t border-white/10 mt-4">
                        <i class="fas fa-info-circle mr-2"></i>
                        Showing first ${maxFiles} of ${domainFiles.length.toLocaleString()} files. Use search to narrow results.
                    </p>
                `;
            }
        }

        function createFileCard(file, viewMode) {
            const domain = file.category || 'Uncategorized';
            const config = domainConfig[domain] || { color: 'bg-gray-600', icon: 'fa-folder' };
            const fileId = file.id;
            const card = document.createElement('div');
            card.className = 'file-card relative';
            card.dataset.id = fileId;
            const starsHtml = [1,2,3,4,5].map(i => '<i class="fas fa-star ' + (i <= (file._rating || 0) ? 'filled' : '') + '" onclick="event.stopPropagation(); setRating(\'' + fileId + '\', ' + i + ')"></i>').join('');
            // Get AI summary if available
            const aiData = aiSuggestions[fileId] || file._aiData || {};
            const summary = aiData.summary || file._summary || '';
            const truncatedSummary = summary.length > 80 ? summary.substring(0, 80) + '...' : summary;

            // Smart search relevance info
            const hasSearchScore = file._searchScore && file._searchScore > 0 && smartSearchEnabled && currentSearchQuery;
            const queryWords = currentSearchQuery ? currentSearchQuery.toLowerCase().split(/\s+/).filter(w => w.length > 2) : [];
            const relevancePercent = hasSearchScore ? calculateRelevancePercent(file, queryWords) : 0;
            const matchSources = [];
            if (file._searchMatches) {
                if (file._searchMatches.filename) matchSources.push('name');
                if (file._searchMatches.summary) matchSources.push('summary');
                if (file._searchMatches.tags) matchSources.push('tags');
            }

            // Highlight filename if searching
            let displayName = file.name || 'Unnamed';
            let displaySummary = truncatedSummary;
            if (hasSearchScore && file._matchedTerms && file._matchedTerms.length > 0) {
                displayName = highlightSearchTerms(displayName, file._matchedTerms);
                displaySummary = highlightSearchTerms(truncatedSummary, file._matchedTerms);
            }

            const relevanceBadge = hasSearchScore ? '<span class="relevance-badge ml-2">' + relevancePercent + '% match</span>' : '';
            const matchIndicator = hasSearchScore && matchSources.length > 0 ? '<span class="match-indicator">Found in: ' + matchSources.join(', ') + '</span>' : '';

            if (viewMode === 'list') {
                card.className += ' bg-white/5 rounded-lg p-3 flex items-center gap-4 hover:bg-white/10 transition-all cursor-pointer';
                if (file._color) card.style.borderLeft = '4px solid ' + getColorHex(file._color);
                card.innerHTML = '<input type="checkbox" class="file-checkbox accent-purple-500" data-id="' + fileId + '" ' + (selectedFiles.has(fileId) ? 'checked' : '') + ' onclick="event.stopPropagation(); toggleFileSelection(\'' + fileId + '\')"><i class="favorite-btn ' + (file._favorite ? 'active text-red-500' : 'text-gray-500') + ' fas fa-heart" onclick="event.stopPropagation(); toggleFavorite(\'' + fileId + '\')"></i><span class="' + config.color + ' px-2 py-1 rounded text-xs">' + domain + '</span><span class="flex-1 truncate">' + getFileTypeIconFA(file.mime_type) + ' ' + displayName + relevanceBadge + (summary ? ' <span class="text-purple-400/70 text-xs italic ml-2">' + displaySummary + '</span>' : '') + '</span><span class="star-rating text-sm">' + starsHtml + '</span><span class="text-purple-400 text-xs w-24 truncate">' + (file.subcategory || '') + '</span><div class="flex gap-2"><button onclick="event.stopPropagation(); previewFile(\'' + fileId + '\')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm"><i class="fas fa-eye"></i></button><a href="' + getDownloadLink(file) + '" target="_blank" onclick="event.stopPropagation();" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm"><i class="fas fa-download"></i></a><a href="' + file.link + '" target="_blank" onclick="event.stopPropagation();" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm"><i class="fas fa-external-link-alt"></i></a><button onclick="event.stopPropagation(); openLocalAIRename(\'' + fileId + '\')" class="px-3 py-1 bg-yellow-600/80 hover:bg-yellow-600 rounded text-sm" title="Smart Rename"><i class="fas fa-magic"></i></button></div>';
            } else if (viewMode === 'compact') {
                card.className += ' bg-white/5 rounded-lg p-2 hover:bg-white/10 transition-all cursor-pointer text-center';
                if (file._color) card.style.borderTop = '3px solid ' + getColorHex(file._color);
                card.innerHTML = '<div class="text-2xl mb-1">' + getFileTypeIconFA(file.mime_type) + '</div><div class="text-xs truncate" title="' + file.name + '">' + displayName + '</div>' + (file._favorite ? '<i class="fas fa-heart text-red-500 text-xs"></i>' : '');
            } else {
                card.className += ' bg-white/5 backdrop-blur rounded-xl border border-white/10 p-4 card-hover transition-all';
                // Check if this file is batch-selected
                if (batchSelectedFiles.has(fileId)) {
                    card.classList.add('batch-selected');
                }
                const summaryHtml = summary ? '<p class="text-xs mb-2 line-clamp-2" style="font-size: 0.8rem; color: #94a3b8; font-style: italic;">' + displaySummary + '</p>' : '';
                const relevanceRow = hasSearchScore ? '<div class="flex items-center gap-2 mb-2">' + relevanceBadge + matchIndicator + '</div>' : '';
                // Add batch checkbox (hidden by default, shown when selection mode active)
                const batchCheckbox = '<div class="file-card-checkbox' + (batchSelectedFiles.has(fileId) ? ' checked' : '') + '" onclick="event.stopPropagation(); toggleBatchFileSelection(event, \'' + fileId + '\')"></div>';
                card.innerHTML = batchCheckbox + (file._color ? '<div class="color-strip" style="background: ' + getColorHex(file._color) + ';"></div>' : '') + '<div class="flex items-center justify-between mb-2"><input type="checkbox" class="file-checkbox accent-purple-500" data-id="' + fileId + '" ' + (selectedFiles.has(fileId) ? 'checked' : '') + ' onclick="event.stopPropagation(); toggleFileSelection(\'' + fileId + '\')"><span class="' + config.color + ' px-2 py-1 rounded-full text-xs"><i class="fas ' + config.icon + ' mr-1"></i>' + domain + '</span><span class="text-xs text-green-400">' + (file.confidence > 0.7 ? Math.round(file.confidence * 100) + '%' : '') + '</span></div>' + relevanceRow + '<h3 class="font-semibold text-white mb-1 line-clamp-2 text-sm" title="' + file.name + '">' + getFileTypeIconFA(file.mime_type) + ' ' + displayName + '</h3><p class="text-purple-300 text-xs mb-1">' + (file.subcategory || '') + '</p>' + summaryHtml + '<div class="flex items-center justify-between mb-2"><div class="star-rating">' + starsHtml + '</div><i class="favorite-btn fas fa-heart ' + (file._favorite ? 'active text-red-500' : 'text-gray-500') + '" onclick="event.stopPropagation(); toggleFavorite(\'' + fileId + '\')"></i></div>' + (file.tags && file.tags.length > 0 && file.tags[0] !== 'uncategorized' ? '<div class="flex flex-wrap gap-1 mb-3">' + file.tags.slice(0, 3).map(tag => '<span class="px-2 py-1 bg-purple-500/30 text-purple-200 text-xs rounded-full">' + tag + '</span>').join('') + '</div>' : '') + '<div class="flex gap-2 mt-3"><button onclick="event.stopPropagation(); previewFile(\'' + fileId + '\')" class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-all"><i class="fas fa-eye mr-1"></i> Preview</button><a href="' + getDownloadLink(file) + '" target="_blank" onclick="event.stopPropagation();" class="flex-1 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm transition-all text-center"><i class="fas fa-download mr-1"></i> Download</a></div><div class="flex gap-2 mt-2"><a href="' + file.link + '" target="_blank" onclick="event.stopPropagation();" class="flex-1 text-center py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition-all"><i class="fas fa-external-link-alt mr-1"></i> Open</a><button onclick="event.stopPropagation(); openLocalAIRename(\'' + fileId + '\')" class="py-2 px-3 bg-yellow-600/80 hover:bg-yellow-600 rounded-lg text-sm transition-all" title="Smart Rename Suggestion"><i class="fas fa-magic"></i></button></div>';
            }
            card.addEventListener('click', () => previewFile(fileId));
            return card;
        }

        function getColorHex(color) { const colors = { red: '#ef4444', orange: '#f97316', yellow: '#eab308', green: '#22c55e', blue: '#3b82f6', purple: '#a855f7', pink: '#ec4899', cyan: '#06b6d4' }; return colors[color] || '#6b7280'; }
        function getDownloadLink(file) { if (file.id && file.link && file.link.includes('drive.google.com')) return 'https://drive.google.com/uc?export=download&id=' + file.id; return file.link || '#'; }

        function toggleFavorite(fileId, skipUndo = false) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            const previousValue = file._favorite || false;
            file._favorite = !file._favorite;

            // Push to undo stack before making changes
            if (!skipUndo) {
                pushToUndoStack(
                    file._favorite ? 'favorite' : 'unfavorite',
                    fileId,
                    previousValue,
                    file._favorite,
                    file._favorite ? 'Added to favorites' : 'Removed from favorites'
                );
            }

            userPrefs.favorites[fileId] = file._favorite;
            if (!file._favorite) delete userPrefs.favorites[fileId];
            saveUserPrefs();
            document.querySelectorAll('.file-card[data-id="' + fileId + '"] .favorite-btn').forEach(btn => { btn.classList.toggle('active', file._favorite); btn.classList.toggle('text-red-500', file._favorite); btn.classList.toggle('text-gray-500', !file._favorite); });
            updateHeaderStats(); buildSidebar();

            // Show undo bar instead of toast
            if (!skipUndo) {
                showUndoBar(file._favorite ? 'Added to favorites' : 'Removed from favorites');
            }
        }

        function setRating(fileId, rating, skipUndo = false) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            const previousValue = file._rating || 0;
            const newRating = file._rating === rating ? 0 : rating;

            // Push to undo stack before making changes
            if (!skipUndo) {
                pushToUndoStack('rating', fileId, previousValue, newRating, 'Rating changed');
            }

            file._rating = newRating;
            userPrefs.ratings[fileId] = file._rating;
            if (!file._rating) delete userPrefs.ratings[fileId];
            saveUserPrefs();
            document.querySelectorAll('.file-card[data-id="' + fileId + '"] .star-rating i').forEach((star, i) => { star.classList.toggle('filled', i < file._rating); });
            buildSidebar();

            // Show undo bar instead of toast
            if (!skipUndo) {
                showUndoBar(file._rating ? 'Rated ' + file._rating + ' star' + (file._rating !== 1 ? 's' : '') : 'Rating cleared');
            }
        }

        function setColor(fileId, color, skipUndo = false) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            const previousValue = file._color || '';

            // Push to undo stack before making changes
            if (!skipUndo) {
                pushToUndoStack('color', fileId, previousValue, color, color ? 'Set ' + color + ' label' : 'Cleared label');
            }

            file._color = color;
            userPrefs.colors[fileId] = color;
            if (!color) delete userPrefs.colors[fileId];
            saveUserPrefs(); buildSidebar(); displayedCount = 0; displayFiles();

            // Show undo bar instead of toast
            if (!skipUndo) {
                showUndoBar(color ? 'Set ' + color + ' label' : 'Cleared color label');
            }
        }

        function toggleFileSelection(fileId) { if (selectedFiles.has(fileId)) selectedFiles.delete(fileId); else selectedFiles.add(fileId); document.querySelectorAll('.file-checkbox[data-id="' + fileId + '"]').forEach(cb => { cb.checked = selectedFiles.has(fileId); }); }
        function selectAll() { const allChecked = selectedFiles.size === filteredFiles.length; if (allChecked) selectedFiles.clear(); else filteredFiles.forEach(f => selectedFiles.add(f.id)); document.querySelectorAll('.file-checkbox').forEach(cb => { cb.checked = !allChecked; }); toast(allChecked ? 'Deselected all' : 'Selected ' + selectedFiles.size + ' files', 'info'); }
        function bulkFavorite() { if (selectedFiles.size === 0) { toast('No files selected', 'error'); return; } selectedFiles.forEach(fileId => { const file = allFiles.find(f => f.id === fileId); if (file) { file._favorite = true; userPrefs.favorites[fileId] = true; } }); saveUserPrefs(); updateHeaderStats(); buildSidebar(); displayedCount = 0; displayFiles(); toast('Added ' + selectedFiles.size + ' to favorites', 'success'); }
        function bulkEditTags() { if (selectedFiles.size === 0) { toast('No files selected', 'error'); return; } if (selectedFiles.size === 1) openTagsEditor(Array.from(selectedFiles)[0]); else toast('Select one file for tags', 'info'); }
        function downloadSelected() { if (selectedFiles.size === 0) { toast('No files selected', 'error'); return; } selectedFiles.forEach(fileId => { const file = allFiles.find(f => f.id === fileId); if (file) window.open(getDownloadLink(file), '_blank'); }); toast('Opening ' + selectedFiles.size + ' downloads', 'info'); }
        function openTagsEditor(fileId) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;
            tagsEditorFileId = fileId;
            tagsEditorTags = [...(file._customTags || [])];
            document.getElementById('tagsEditorFileName').textContent = 'File: ' + file.name;
            renderTagsEditorList();
            renderSuggestedTags();
            document.getElementById('newTagInput').value = '';
            document.getElementById('tagsEditorModal').classList.remove('hidden');
        }
        function closeTagsEditor() { document.getElementById('tagsEditorModal').classList.add('hidden'); tagsEditorFileId = null; tagsEditorTags = []; }
        function renderTagsEditorList() {
            const container = document.getElementById('currentTagsList');
            if (tagsEditorTags.length === 0) { container.innerHTML = '<span class="text-purple-400 text-sm">No custom tags</span>'; }
            else { container.innerHTML = tagsEditorTags.map(tag => '<span class="tag-pill">' + tag + '<button onclick="removeTagFromEditor(\'' + tag + '\')" class="text-red-400 hover:text-red-300"><i class="fas fa-times"></i></button></span>').join(''); }
        }
        function renderSuggestedTags() {
            const allTags = {};
            allFiles.forEach(f => { (f._customTags || []).forEach(t => allTags[t] = (allTags[t] || 0) + 1); });
            const suggestions = Object.entries(allTags).sort((a,b) => b[1]-a[1]).slice(0,10).map(([tag]) => tag).filter(tag => !tagsEditorTags.includes(tag));
            const defaultSuggestions = ['important','review','archive','todo','reference','project','personal','work'];
            const finalSuggestions = [...new Set([...suggestions, ...defaultSuggestions])].slice(0,8).filter(tag => !tagsEditorTags.includes(tag));
            document.getElementById('suggestedTags').innerHTML = finalSuggestions.map(tag => '<button onclick="addTagToEditor(\'' + tag + '\')" class="px-2 py-1 bg-white/10 hover:bg-purple-600 rounded-full text-xs transition-all">+ ' + tag + '</button>').join('');
        }
        function addTagFromEditor() { const input = document.getElementById('newTagInput'); const tag = input.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-'); if (tag && !tagsEditorTags.includes(tag)) { tagsEditorTags.push(tag); renderTagsEditorList(); renderSuggestedTags(); } input.value = ''; input.focus(); }
        function addTagToEditor(tag) { if (!tagsEditorTags.includes(tag)) { tagsEditorTags.push(tag); renderTagsEditorList(); renderSuggestedTags(); } }
        function removeTagFromEditor(tag) { tagsEditorTags = tagsEditorTags.filter(t => t !== tag); renderTagsEditorList(); renderSuggestedTags(); }
        function saveTagsFromEditor() {
            if (!tagsEditorFileId) return;
            const file = allFiles.find(f => f.id === tagsEditorFileId);
            if (file) {
                // Save previous tags for undo
                const previousTags = file._customTags ? [...file._customTags] : [];
                const newTags = [...tagsEditorTags];

                // Push to undo stack
                pushToUndoStack('tags', tagsEditorFileId, previousTags, newTags, 'Tags updated');

                file._customTags = newTags;
                userPrefs.customTags[tagsEditorFileId] = tagsEditorTags;
                if (tagsEditorTags.length === 0) delete userPrefs.customTags[tagsEditorFileId];
                saveUserPrefs();
                buildSidebar();
                displayedCount = 0;
                displayFiles();
                showUndoBar('Tags updated');
            }
            closeTagsEditor();
        }

        function previewFile(fileId) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;
            currentPreviewFile = file;
            document.getElementById('previewTitle').textContent = file.name || 'Preview';
            document.getElementById('previewOpenBtn').href = file.link || '#';
            document.getElementById('previewDownloadBtn').href = getDownloadLink(file);
            const mimeType = file.mime_type || '';
            const thumbEl = document.getElementById('previewThumb');
            if (mimeType.includes('image')) { thumbEl.innerHTML = '<img src="https://drive.google.com/thumbnail?id=' + file.id + '&sz=w400" class="max-w-full max-h-full rounded-lg" onerror="this.parentElement.innerHTML=\'' + getFileTypeIcon(getFileTypeName(mimeType)) + '\'">'; }
            else { thumbEl.innerHTML = '<span class="text-6xl">' + getFileTypeIcon(getFileTypeName(mimeType)) + '</span>'; }
            document.getElementById('prevName').textContent = file.name || '-';
            document.getElementById('prevDomain').textContent = file.category || '-';
            document.getElementById('prevCategory').textContent = file.subcategory || '-';
            document.getElementById('prevType').textContent = getFileTypeName(mimeType);
            document.getElementById('prevSize').textContent = formatSize(parseInt(file.size) || 0);
            document.getElementById('prevModified').textContent = file.modified ? new Date(file.modified).toLocaleString() : '-';
            document.getElementById('prevCreated').textContent = file.created ? new Date(file.created).toLocaleString() : '-';
            document.getElementById('prevConfidence').textContent = file.confidence ? Math.round(file.confidence * 100) + '%' : '-';
            document.getElementById('prevTags').textContent = (file.tags || []).join(', ') || '-';
            // Show AI summary if available
            const aiData = aiSuggestions[fileId] || file._aiData || {};
            const summary = aiData.summary || file._summary || '';
            const summarySection = document.getElementById('prevSummarySection');
            const summaryEl = document.getElementById('prevSummary');
            if (summary && summary.trim() !== '') {
                summarySection.classList.remove('hidden');
                summaryEl.textContent = summary;
            } else {
                summarySection.classList.add('hidden');
            }
            document.getElementById('prevNotes').value = file._notes || '';
            const customTagsEl = document.getElementById('previewCustomTags');
            if (file._customTags && file._customTags.length > 0) { customTagsEl.innerHTML = file._customTags.map(tag => '<span class="tag-pill">' + tag + '</span>').join(''); }
            else { customTagsEl.innerHTML = '<span class="text-purple-400 text-xs">None</span>'; }
            document.getElementById('previewStars').innerHTML = [1,2,3,4,5].map(i => '<i class="fas fa-star ' + (i <= (file._rating || 0) ? 'filled' : '') + '" onclick="setPreviewRating(' + i + ')"></i>').join('');
            document.querySelectorAll('#previewColors .color-dot').forEach(dot => { dot.classList.toggle('selected', dot.dataset.color === file._color); });
            updatePreviewFavButton();
            // Populate related files section
            populateRelatedFiles(file);
            document.getElementById('previewModal').classList.remove('hidden');
        }
        function closePreview() { document.getElementById('previewModal').classList.add('hidden'); currentPreviewFile = null; }
        function setPreviewRating(rating) { if (!currentPreviewFile) return; currentPreviewFile._rating = currentPreviewFile._rating === rating ? 0 : rating; document.getElementById('previewStars').querySelectorAll('i').forEach((star, i) => { star.classList.toggle('filled', i < currentPreviewFile._rating); }); }
        function setPreviewColor(color) { if (!currentPreviewFile) return; currentPreviewFile._color = color; document.querySelectorAll('#previewColors .color-dot').forEach(dot => { dot.classList.toggle('selected', dot.dataset.color === color); }); }
        function togglePreviewFavorite() { if (!currentPreviewFile) return; currentPreviewFile._favorite = !currentPreviewFile._favorite; updatePreviewFavButton(); }
        function updatePreviewFavButton() { const btn = document.getElementById('prevFavBtn'); if (currentPreviewFile?._favorite) { btn.innerHTML = '<i class="fas fa-heart mr-2"></i> Unfavorite'; btn.classList.add('bg-red-600'); btn.classList.remove('bg-red-600/50'); } else { btn.innerHTML = '<i class="far fa-heart mr-2"></i> Favorite'; btn.classList.remove('bg-red-600'); btn.classList.add('bg-red-600/50'); } }
        function savePreviewChanges() {
            if (!currentPreviewFile) return;
            const file = currentPreviewFile;
            file._notes = document.getElementById('prevNotes').value;
            userPrefs.favorites[file.id] = file._favorite; userPrefs.ratings[file.id] = file._rating; userPrefs.colors[file.id] = file._color; userPrefs.notes[file.id] = file._notes;
            if (!file._favorite) delete userPrefs.favorites[file.id]; if (!file._rating) delete userPrefs.ratings[file.id]; if (!file._color) delete userPrefs.colors[file.id]; if (!file._notes) delete userPrefs.notes[file.id];
            saveUserPrefs(); updateHeaderStats(); buildSidebar(); displayedCount = 0; displayFiles(); closePreview(); toast('Changes saved!', 'success');
        }

        // Copy link from preview modal
        function copyPreviewLink() {
            if (!currentPreviewFile || !currentPreviewFile.link) {
                toast('No link available for this file', 'error');
                return;
            }
            navigator.clipboard.writeText(currentPreviewFile.link);
            toast('Link copied to clipboard!', 'success');
        }

        // Show related files from preview modal
        function showPreviewRelated() {
            if (!currentPreviewFile) {
                toast('No file selected', 'error');
                return;
            }
            closePreview();
            showRelated(currentPreviewFile.id);
        }

        // ============================================================
        // ADVANCED ANALYTICS DASHBOARD
        // ============================================================

        let advancedAnalyticsCharts = {};

        function openAdvancedAnalytics() {
            const modal = document.getElementById('advancedAnalyticsModal');
            modal.classList.add('show');
            calculateAllAnalytics();
        }

        function closeAdvancedAnalytics() {
            const modal = document.getElementById('advancedAnalyticsModal');
            modal.classList.remove('show');
            // Destroy charts to prevent memory leaks
            Object.values(advancedAnalyticsCharts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            advancedAnalyticsCharts = {};
        }

        function showAnalyticsTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.analytics-tab').forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Update panels
            document.querySelectorAll('.analytics-panel').forEach(panel => panel.classList.remove('active'));

            const panelMap = {
                'overview': 'analyticsOverview',
                'files': 'analyticsFiles',
                'tags': 'analyticsTags',
                'ai': 'analyticsAI',
                'storage': 'analyticsStorage',
                'quality': 'analyticsQuality'
            };

            document.getElementById(panelMap[tabName]).classList.add('active');
        }

        // Backward compatibility - keep showAnalytics as alias
        function showAnalytics() {
            openAdvancedAnalytics();
        }

        function closeAnalytics() {
            closeAdvancedAnalytics();
        }

        function calculateAllAnalytics() {
            const total = allFiles.length;
            const chartColors = ['#7c3aed', '#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#ec4899', '#06b6d4', '#8b5cf6', '#10b981', '#f97316'];

            // ===== OVERVIEW METRICS =====
            document.getElementById('metricTotalFiles').textContent = total.toLocaleString();

            // Calculate total storage
            let totalBytes = 0;
            allFiles.forEach(f => { totalBytes += f.size || 0; });
            document.getElementById('metricTotalStorage').textContent = formatFileSize(totalBytes);

            // Count unique tags
            const allTags = new Set();
            allFiles.forEach(f => {
                const tags = f.tags || f.ai_tags || [];
                tags.forEach(t => allTags.add(t.toLowerCase()));
            });
            document.getElementById('metricTotalTags').textContent = allTags.size.toLocaleString();

            // Count duplicates
            const md5Map = {};
            allFiles.forEach(f => { if (f.md5) (md5Map[f.md5] = md5Map[f.md5] || []).push(f); });
            const duplicateCount = Object.values(md5Map).filter(arr => arr.length > 1).reduce((sum, arr) => sum + arr.length - 1, 0);
            document.getElementById('metricDuplicates').textContent = duplicateCount.toLocaleString();

            // ===== FILE TYPE CHART =====
            const typeCounts = {};
            allFiles.forEach(f => {
                const t = getFileTypeName(f.mime_type || '');
                typeCounts[t] = (typeCounts[t] || 0) + 1;
            });

            const sortedTypes = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

            if (advancedAnalyticsCharts.fileType) advancedAnalyticsCharts.fileType.destroy();
            const fileTypeCtx = document.getElementById('advFileTypeChart');
            if (fileTypeCtx) {
                advancedAnalyticsCharts.fileType = new Chart(fileTypeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedTypes.map(([t]) => t),
                        datasets: [{
                            data: sortedTypes.map(([, c]) => c),
                            backgroundColor: chartColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#c4b5fd', padding: 12 } }
                        }
                    }
                });
            }

            // ===== SOURCE CHART =====
            const sourceCounts = {};
            allFiles.forEach(f => {
                const src = f.category || 'Unknown';
                sourceCounts[src] = (sourceCounts[src] || 0) + 1;
            });

            const sortedSources = Object.entries(sourceCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

            if (advancedAnalyticsCharts.source) advancedAnalyticsCharts.source.destroy();
            const sourceCtx = document.getElementById('advSourceChart');
            if (sourceCtx) {
                advancedAnalyticsCharts.source = new Chart(sourceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedSources.map(([s]) => s),
                        datasets: [{
                            data: sortedSources.map(([, c]) => c),
                            backgroundColor: chartColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#c4b5fd', padding: 12 } }
                        }
                    }
                });
            }

            // ===== AI PROGRESS RINGS =====
            const summarizedCount = allFiles.filter(f => f.summary && f.summary.length > 10).length;
            const taggedCount = allFiles.filter(f => (f.tags && f.tags.length > 0) || (f.ai_tags && f.ai_tags.length > 0)).length;
            const renamedCount = allFiles.filter(f => f.rename_approved || f.ai_renamed).length;

            updateProgressRing('aiSummaryRing', 'aiSummaryPercent', summarizedCount, total, '#22c55e');
            updateProgressRing('aiTaggedRing', 'aiTaggedPercent', taggedCount, total, '#3b82f6');
            updateProgressRing('aiRenamedRing', 'aiRenamedPercent', renamedCount, total, '#a855f7');

            // ===== FILES TAB =====
            // File Distribution Bar Chart
            if (advancedAnalyticsCharts.fileDist) advancedAnalyticsCharts.fileDist.destroy();
            const fileDistCtx = document.getElementById('advFileDistChart');
            if (fileDistCtx) {
                advancedAnalyticsCharts.fileDist = new Chart(fileDistCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedTypes.map(([t]) => t),
                        datasets: [{
                            label: 'Files',
                            data: sortedTypes.map(([, c]) => c),
                            backgroundColor: '#7c3aed'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#c4b5fd' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                            y: { ticks: { color: '#c4b5fd' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });
            }

            // Timeline Chart
            const months = {};
            allFiles.forEach(f => {
                const d = new Date(f.created || f.modified);
                if (!isNaN(d)) {
                    const m = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
                    months[m] = (months[m] || 0) + 1;
                }
            });
            const sortedMonths = Object.keys(months).sort().slice(-12);

            if (advancedAnalyticsCharts.timeline) advancedAnalyticsCharts.timeline.destroy();
            const timelineCtx = document.getElementById('advTimelineChart');
            if (timelineCtx) {
                advancedAnalyticsCharts.timeline = new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: 'Files',
                            data: sortedMonths.map(m => months[m]),
                            borderColor: '#7c3aed',
                            backgroundColor: 'rgba(124, 58, 237, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#c4b5fd' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                            y: { ticks: { color: '#c4b5fd' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });
            }

            // Largest Files Table
            const largestFiles = [...allFiles].sort((a, b) => (b.size || 0) - (a.size || 0)).slice(0, 10);
            document.getElementById('largestFilesTable').innerHTML = largestFiles.map(f => `
                <tr onclick="closeAdvancedAnalytics(); previewFile('${f.id}')" style="cursor: pointer;">
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</td>
                    <td>${getFileTypeName(f.mime_type || '')}</td>
                    <td>${formatFileSize(f.size || 0)}</td>
                    <td>${f.category || 'Unknown'}</td>
                </tr>
            `).join('');

            // File Types Table
            const allTypesData = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
            const typeStorage = {};
            allFiles.forEach(f => {
                const t = getFileTypeName(f.mime_type || '');
                typeStorage[t] = (typeStorage[t] || 0) + (f.size || 0);
            });

            document.getElementById('fileTypesTable').innerHTML = allTypesData.map(([type, count]) => `
                <tr>
                    <td>${type}</td>
                    <td>${count.toLocaleString()}</td>
                    <td>${((count / total) * 100).toFixed(1)}%</td>
                    <td>${formatFileSize(typeStorage[type] || 0)}</td>
                </tr>
            `).join('');

            // ===== TAGS TAB =====
            const tagCounts = {};
            let totalTagCount = 0;
            let filesWithTags = 0;

            allFiles.forEach(f => {
                const tags = f.tags || f.ai_tags || [];
                if (tags.length > 0) filesWithTags++;
                totalTagCount += tags.length;
                tags.forEach(t => {
                    const tag = t.toLowerCase();
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });

            const sortedTagCounts = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);

            document.getElementById('tagMetricTotal').textContent = Object.keys(tagCounts).length.toLocaleString();
            document.getElementById('tagMetricTaggedFiles').textContent = filesWithTags.toLocaleString();
            document.getElementById('tagMetricAvgTags').textContent = filesWithTags > 0 ? (totalTagCount / filesWithTags).toFixed(1) : '0';
            document.getElementById('tagMetricTopTag').textContent = sortedTagCounts.length > 0 ? sortedTagCounts[0][0] : '-';

            // Tag Cloud
            const tagCloudHtml = sortedTagCounts.slice(0, 50).map(([tag, count], i) => {
                const size = Math.max(0.7, Math.min(1.4, 0.7 + (count / (sortedTagCounts[0][1] || 1)) * 0.7));
                const colorIndex = i % chartColors.length;
                return `<span class="tag" style="font-size: ${size}rem; background: ${chartColors[colorIndex]}30; color: ${chartColors[colorIndex]};">${tag} (${count})</span>`;
            }).join('');
            document.getElementById('analyticsTagCloud').innerHTML = tagCloudHtml || '<span style="color: #94a3b8;">No tags found</span>';

            // Top Tags Chart
            const top15Tags = sortedTagCounts.slice(0, 15);
            if (advancedAnalyticsCharts.tags) advancedAnalyticsCharts.tags.destroy();
            const tagsCtx = document.getElementById('advTagsChart');
            if (tagsCtx) {
                advancedAnalyticsCharts.tags = new Chart(tagsCtx, {
                    type: 'bar',
                    data: {
                        labels: top15Tags.map(([t]) => t),
                        datasets: [{
                            label: 'Files',
                            data: top15Tags.map(([, c]) => c),
                            backgroundColor: chartColors
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#c4b5fd' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                            y: { ticks: { color: '#c4b5fd' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });
            }

            // All Tags Table
            document.getElementById('allTagsTable').innerHTML = sortedTagCounts.map(([tag, count]) => `
                <tr>
                    <td>${tag}</td>
                    <td>${count.toLocaleString()}</td>
                    <td>${((count / total) * 100).toFixed(1)}%</td>
                </tr>
            `).join('');

            // ===== AI ANALYSIS TAB =====
            document.getElementById('aiMetricSummarized').textContent = summarizedCount.toLocaleString();
            document.getElementById('aiMetricTagged').textContent = taggedCount.toLocaleString();
            document.getElementById('aiMetricRenamed').textContent = renamedCount.toLocaleString();

            const badFilenameCount = allFiles.filter(f => f.bad_filename || (f.suggested_name && !f.rename_approved)).length;
            document.getElementById('aiMetricBadNames').textContent = badFilenameCount.toLocaleString();

            // AI Status Chart
            if (advancedAnalyticsCharts.aiStatus) advancedAnalyticsCharts.aiStatus.destroy();
            const aiStatusCtx = document.getElementById('advAIStatusChart');
            if (aiStatusCtx) {
                advancedAnalyticsCharts.aiStatus = new Chart(aiStatusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Summarized', 'Tagged', 'Renamed', 'Bad Filenames'],
                        datasets: [{
                            label: 'Files',
                            data: [summarizedCount, taggedCount, renamedCount, badFilenameCount],
                            backgroundColor: ['#22c55e', '#3b82f6', '#a855f7', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#c4b5fd' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                            y: { ticks: { color: '#c4b5fd' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });
            }

            // Rename suggestions counts
            const pendingRenames = allFiles.filter(f => f.suggested_name && !f.rename_approved && !f.rename_rejected).length;
            const approvedRenames = allFiles.filter(f => f.rename_approved).length;
            const rejectedRenames = allFiles.filter(f => f.rename_rejected).length;

            document.getElementById('aiPendingRenames').textContent = pendingRenames.toLocaleString();
            document.getElementById('aiApprovedRenames').textContent = approvedRenames.toLocaleString();
            document.getElementById('aiRejectedRenames').textContent = rejectedRenames.toLocaleString();

            // ===== STORAGE TAB =====
            document.getElementById('storageMetricTotal').textContent = formatFileSize(totalBytes);

            // Storage by type
            const pdfSize = allFiles.filter(f => (f.mime_type || '').includes('pdf')).reduce((s, f) => s + (f.size || 0), 0);
            const docSize = allFiles.filter(f => {
                const m = f.mime_type || '';
                return m.includes('word') || m.includes('document') || m.includes('msword') || m.includes('officedocument');
            }).reduce((s, f) => s + (f.size || 0), 0);
            const imgSize = allFiles.filter(f => (f.mime_type || '').includes('image')).reduce((s, f) => s + (f.size || 0), 0);

            document.getElementById('storageMetricPDF').textContent = formatFileSize(pdfSize);
            document.getElementById('storageMetricDocs').textContent = formatFileSize(docSize);
            document.getElementById('storageMetricImages').textContent = formatFileSize(imgSize);

            // Storage by Type Chart
            if (advancedAnalyticsCharts.storageType) advancedAnalyticsCharts.storageType.destroy();
            const storageTypeCtx = document.getElementById('advStorageTypeChart');
            if (storageTypeCtx) {
                advancedAnalyticsCharts.storageType = new Chart(storageTypeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(typeStorage).slice(0, 8),
                        datasets: [{
                            data: Object.values(typeStorage).sort((a, b) => b - a).slice(0, 8),
                            backgroundColor: chartColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#c4b5fd', padding: 12 } }
                        }
                    }
                });
            }

            // Storage by Source Chart
            const sourceStorage = {};
            allFiles.forEach(f => {
                const src = f.category || 'Unknown';
                sourceStorage[src] = (sourceStorage[src] || 0) + (f.size || 0);
            });
            const sortedSourceStorage = Object.entries(sourceStorage).sort((a, b) => b[1] - a[1]).slice(0, 8);

            if (advancedAnalyticsCharts.storageSource) advancedAnalyticsCharts.storageSource.destroy();
            const storageSourceCtx = document.getElementById('advStorageSourceChart');
            if (storageSourceCtx) {
                advancedAnalyticsCharts.storageSource = new Chart(storageSourceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedSourceStorage.map(([s]) => s),
                        datasets: [{
                            data: sortedSourceStorage.map(([, sz]) => sz),
                            backgroundColor: chartColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#c4b5fd', padding: 12 } }
                        }
                    }
                });
            }

            // Storage Top Files Table
            document.getElementById('storageTopFilesTable').innerHTML = largestFiles.map((f, i) => `
                <tr onclick="closeAdvancedAnalytics(); previewFile('${f.id}')" style="cursor: pointer;">
                    <td>${i + 1}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</td>
                    <td>${formatFileSize(f.size || 0)}</td>
                    <td>${getFileTypeName(f.mime_type || '')}</td>
                </tr>
            `).join('');

            // ===== QUALITY TAB =====
            calculateHealthScore();
        }

        function updateProgressRing(ringId, percentId, current, total, color) {
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            const circumference = 364.42; // 2 * PI * 58
            const offset = circumference - (percent / 100) * circumference;

            const ring = document.getElementById(ringId);
            if (ring) {
                const progressCircle = ring.querySelector('.progress');
                if (progressCircle) {
                    progressCircle.style.strokeDashoffset = offset;
                    progressCircle.style.stroke = color;
                }
            }

            const percentEl = document.getElementById(percentId);
            if (percentEl) {
                percentEl.textContent = percent + '%';
            }
        }

        function calculateHealthScore() {
            const total = allFiles.length;
            if (total === 0) {
                document.getElementById('healthScoreValue').textContent = 'N/A';
                document.getElementById('healthScoreLabel').textContent = 'No files to analyze';
                return;
            }

            // Calculate individual scores (0-100)
            const summarizedCount = allFiles.filter(f => f.summary && f.summary.length > 10).length;
            const taggedCount = allFiles.filter(f => (f.tags && f.tags.length > 0) || (f.ai_tags && f.ai_tags.length > 0)).length;
            const goodFilenameCount = allFiles.filter(f => !f.bad_filename && !f.suggested_name).length;
            const ratedCount = allFiles.filter(f => userPrefs.ratings && userPrefs.ratings[f.id]).length;
            const organizedCount = allFiles.filter(f => f.full_category || (userPrefs.colors && userPrefs.colors[f.id])).length;

            const md5Map = {};
            allFiles.forEach(f => { if (f.md5) (md5Map[f.md5] = md5Map[f.md5] || []).push(f); });
            const noDuplicatesCount = total - Object.values(md5Map).filter(arr => arr.length > 1).reduce((sum, arr) => sum + arr.length - 1, 0);

            const summaryScore = (summarizedCount / total) * 100;
            const tagScore = (taggedCount / total) * 100;
            const filenameScore = (goodFilenameCount / total) * 100;
            const ratingScore = (ratedCount / total) * 100;
            const organizationScore = (organizedCount / total) * 100;
            const duplicateScore = (noDuplicatesCount / total) * 100;

            // Weighted average
            const weights = { summary: 25, tags: 20, filename: 20, rating: 10, organization: 15, duplicates: 10 };
            const healthScore = Math.round(
                (summaryScore * weights.summary +
                tagScore * weights.tags +
                filenameScore * weights.filename +
                ratingScore * weights.rating +
                organizationScore * weights.organization +
                duplicateScore * weights.duplicates) / 100
            );

            // Update health score display
            const scoreCircle = document.getElementById('healthScoreCircle');
            let scoreColor = '#22c55e'; // Green
            let scoreLabel = 'Excellent';

            if (healthScore < 40) {
                scoreColor = '#ef4444';
                scoreLabel = 'Needs Work';
            } else if (healthScore < 60) {
                scoreColor = '#f59e0b';
                scoreLabel = 'Fair';
            } else if (healthScore < 80) {
                scoreColor = '#3b82f6';
                scoreLabel = 'Good';
            }

            document.getElementById('healthScoreValue').textContent = healthScore;
            document.getElementById('healthScoreLabel').textContent = scoreLabel;
            scoreCircle.style.setProperty('--score', healthScore);
            scoreCircle.style.setProperty('--score-color', scoreColor);

            // Health Breakdown
            document.getElementById('healthBreakdown').innerHTML = `
                <div class="health-item">
                    <i class="fas fa-align-left" style="background: rgba(34, 197, 94, 0.2); color: #22c55e;"></i>
                    <div class="health-info">
                        <div class="health-label">Summaries</div>
                        <div class="health-value">${Math.round(summaryScore)}%</div>
                    </div>
                </div>
                <div class="health-item">
                    <i class="fas fa-tags" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;"></i>
                    <div class="health-info">
                        <div class="health-label">Tagged Files</div>
                        <div class="health-value">${Math.round(tagScore)}%</div>
                    </div>
                </div>
                <div class="health-item">
                    <i class="fas fa-file-signature" style="background: rgba(168, 85, 247, 0.2); color: #a855f7;"></i>
                    <div class="health-info">
                        <div class="health-label">Good Filenames</div>
                        <div class="health-value">${Math.round(filenameScore)}%</div>
                    </div>
                </div>
                <div class="health-item">
                    <i class="fas fa-star" style="background: rgba(245, 158, 11, 0.2); color: #fbbf24;"></i>
                    <div class="health-info">
                        <div class="health-label">Rated Files</div>
                        <div class="health-value">${Math.round(ratingScore)}%</div>
                    </div>
                </div>
                <div class="health-item">
                    <i class="fas fa-folder-open" style="background: rgba(236, 72, 153, 0.2); color: #f472b6;"></i>
                    <div class="health-info">
                        <div class="health-label">Organized</div>
                        <div class="health-value">${Math.round(organizationScore)}%</div>
                    </div>
                </div>
                <div class="health-item">
                    <i class="fas fa-clone" style="background: rgba(6, 182, 212, 0.2); color: #22d3ee;"></i>
                    <div class="health-info">
                        <div class="health-label">Unique Files</div>
                        <div class="health-value">${Math.round(duplicateScore)}%</div>
                    </div>
                </div>
            `;

            // Files Needing Attention
            const filesNeedingAttention = allFiles.filter(f =>
                f.bad_filename ||
                (!f.summary || f.summary.length < 10) ||
                (f.suggested_name && !f.rename_approved)
            ).slice(0, 10);

            document.getElementById('filesNeedingAttention').innerHTML = filesNeedingAttention.length > 0 ?
                filesNeedingAttention.map(f => {
                    let issue = 'Missing data';
                    if (f.bad_filename) issue = 'Bad filename';
                    else if (f.suggested_name && !f.rename_approved) issue = 'Pending rename';
                    else if (!f.summary || f.summary.length < 10) issue = 'No summary';

                    return `
                        <div class="attention-file" onclick="closeAdvancedAnalytics(); previewFile('${f.id}')">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="file-name">${f.name}</span>
                            <span class="issue-badge">${issue}</span>
                        </div>
                    `;
                }).join('') :
                '<p style="color: #94a3b8; text-align: center; padding: 20px;">No files need immediate attention!</p>';

            // Recommendations
            const recommendations = [];

            if (summaryScore < 50) {
                recommendations.push({
                    priority: 'high',
                    icon: 'fa-align-left',
                    title: 'Generate More Summaries',
                    description: `Only ${Math.round(summaryScore)}% of files have summaries. Run AI analysis to improve searchability.`
                });
            }

            if (tagScore < 50) {
                recommendations.push({
                    priority: 'high',
                    icon: 'fa-tags',
                    title: 'Add Tags to Files',
                    description: `${Math.round(100 - tagScore)}% of files have no tags. Tags help with organization and discovery.`
                });
            }

            if (filenameScore < 80) {
                recommendations.push({
                    priority: 'medium',
                    icon: 'fa-file-signature',
                    title: 'Review File Names',
                    description: `${allFiles.filter(f => f.bad_filename || f.suggested_name).length} files have problematic names. Use AI Renamer to fix them.`
                });
            }

            if (duplicateScore < 95) {
                recommendations.push({
                    priority: 'medium',
                    icon: 'fa-clone',
                    title: 'Remove Duplicates',
                    description: `Found ${total - noDuplicatesCount} potential duplicate files. Review and clean up to save space.`
                });
            }

            if (ratingScore < 20) {
                recommendations.push({
                    priority: 'low',
                    icon: 'fa-star',
                    title: 'Rate Your Files',
                    description: `Rate important files to quickly find your best resources later.`
                });
            }

            document.getElementById('analyticsRecommendations').innerHTML = recommendations.length > 0 ?
                recommendations.map(rec => `
                    <div class="recommendation-item ${rec.priority}">
                        <i class="fas ${rec.icon}"></i>
                        <div class="rec-content">
                            <h5>${rec.title}</h5>
                            <p>${rec.description}</p>
                        </div>
                    </div>
                `).join('') :
                '<div class="recommendation-item low"><i class="fas fa-check-circle"></i><div class="rec-content"><h5>Great Job!</h5><p>Your knowledge base is well organized. Keep up the good work!</p></div></div>';
        }

        function showDuplicates() {
            const md5Map = {};
            allFiles.forEach(f => { if (f.md5) (md5Map[f.md5] = md5Map[f.md5] || []).push(f); });
            const dups = Object.entries(md5Map).filter(([_, arr]) => arr.length > 1);
            document.getElementById('duplicatesContent').innerHTML = dups.length === 0 ? '<p class="text-center text-purple-300 py-8">No duplicates found</p>' : dups.slice(0, 30).map(([md5, files]) => '<div class="bg-white/5 rounded-lg p-4 mb-4"><div class="text-xs text-purple-400 mb-2">MD5: ' + md5.slice(0,12) + '... &bull; ' + files.length + ' copies</div>' + files.map(f => '<div class="flex justify-between items-center py-2 border-b border-white/10 last:border-0"><span class="text-sm truncate flex-1">' + f.name + '</span><button onclick="closeDuplicates(); previewFile(\'' + f.id + '\')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs ml-2">View</button></div>').join('') + '</div>').join('');
            document.getElementById('duplicatesModal').classList.remove('hidden');
        }
        function closeDuplicates() { document.getElementById('duplicatesModal').classList.add('hidden'); }

        // ============================================================
        // SMART DUPLICATE DETECTION (Content-based similarity)
        // ============================================================

        let currentDuplicateGroups = [];
        let filesMarkedForDeletion = [];

        // Function 1: Calculate content similarity between two files
        function calculateContentSimilarity(file1, file2) {
            // Don't compare file to itself
            if (file1.path === file2.path || file1.id === file2.id) {
                return 0;
            }

            let similarityScore = 0;
            let maxPossibleScore = 0;

            // Get AI data from either merged format or direct properties
            const summary1 = file1._summary || file1.ai_summary || file1.summary || '';
            const summary2 = file2._summary || file2.ai_summary || file2.summary || '';
            const tags1 = file1._aiTags || file1.ai_tags || file1.tags || [];
            const tags2 = file2._aiTags || file2.ai_tags || file2.tags || [];
            const suggestedName1 = file1._suggestedName || file1.ai_suggested_name || '';
            const suggestedName2 = file2._suggestedName || file2.ai_suggested_name || '';

            // METHOD 1: Summary similarity (most important - 50 points max)
            if (summary1 && summary2) {
                maxPossibleScore += 50;

                // Normalize summaries: lowercase, remove punctuation, split into words
                const normalize = (text) => {
                    return text.toLowerCase()
                        .replace(/[^\w\s]/g, '')
                        .split(/\s+/)
                        .filter(word => word.length > 3);
                };

                const words1 = normalize(summary1);
                const words2 = normalize(summary2);

                // Remove common stop words that don't indicate similarity
                const stopWords = ['this', 'that', 'with', 'from', 'have', 'been', 'were', 'they', 'their', 'what', 'when', 'where', 'which', 'while', 'about', 'document', 'provides', 'includes', 'discusses', 'covers', 'outlines', 'describes', 'contains', 'presents', 'explains', 'details', 'information', 'overview', 'also', 'such', 'more', 'other', 'some', 'most', 'than', 'then', 'into', 'only', 'just', 'over', 'very', 'well', 'being', 'these', 'those', 'could', 'would', 'should', 'each', 'both', 'does', 'make', 'made', 'many', 'much', 'like', 'same', 'different', 'various'];

                const meaningful1 = words1.filter(w => !stopWords.includes(w));
                const meaningful2 = words2.filter(w => !stopWords.includes(w));

                // Calculate Jaccard similarity: intersection / union
                const set1 = new Set(meaningful1);
                const set2 = new Set(meaningful2);
                const intersection = [...set1].filter(word => set2.has(word));
                const union = new Set([...set1, ...set2]);

                if (union.size > 0) {
                    const jaccardSimilarity = intersection.length / union.size;
                    similarityScore += Math.round(jaccardSimilarity * 50);
                }
            }

            // METHOD 2: Tag overlap (30 points max)
            if (tags1 && tags2 && tags1.length > 0 && tags2.length > 0) {
                maxPossibleScore += 30;

                const normalizedTags1 = tags1.map(t => t.toLowerCase());
                const normalizedTags2 = tags2.map(t => t.toLowerCase());

                const sharedTags = normalizedTags1.filter(tag => normalizedTags2.includes(tag));
                const allTags = new Set([...normalizedTags1, ...normalizedTags2]);

                if (allTags.size > 0) {
                    const tagSimilarity = sharedTags.length / allTags.size;
                    similarityScore += Math.round(tagSimilarity * 30);
                }
            }

            // METHOD 3: Suggested filename similarity (20 points max)
            if (suggestedName1 && suggestedName2) {
                maxPossibleScore += 20;

                const name1 = suggestedName1.toLowerCase().replace(/[_\-\.]/g, ' ').split(/\s+/);
                const name2 = suggestedName2.toLowerCase().replace(/[_\-\.]/g, ' ').split(/\s+/);

                const nameSet1 = new Set(name1.filter(w => w.length > 2));
                const nameSet2 = new Set(name2.filter(w => w.length > 2));
                const nameIntersection = [...nameSet1].filter(word => nameSet2.has(word));
                const nameUnion = new Set([...nameSet1, ...nameSet2]);

                if (nameUnion.size > 0) {
                    const nameSimilarity = nameIntersection.length / nameUnion.size;
                    similarityScore += Math.round(nameSimilarity * 20);
                }
            }

            // Calculate percentage
            if (maxPossibleScore === 0) {
                return 0;
            }

            return Math.round((similarityScore / maxPossibleScore) * 100);
        }

        // Function 2: Find duplicate groups
        function findDuplicateGroups(files, threshold = 70) {
            // Only consider files that have AI data (summaries/tags)
            const filesWithAI = files.filter(f => {
                const hasSummary = f._summary || f.ai_summary || f.summary;
                const hasTags = (f._aiTags && f._aiTags.length > 0) || (f.ai_tags && f.ai_tags.length > 0) || (f.tags && f.tags.length > 0);
                return hasSummary || hasTags;
            });

            const duplicateGroups = [];
            const processedFiles = new Set();

            console.log(`Scanning ${filesWithAI.length} files with AI data for duplicates...`);

            for (let i = 0; i < filesWithAI.length; i++) {
                const file1 = filesWithAI[i];
                const file1Key = file1.path || file1.id;

                // Skip if already part of a duplicate group
                if (processedFiles.has(file1Key)) {
                    continue;
                }

                const group = {
                    primary: file1,
                    duplicates: [],
                    averageSimilarity: 0
                };

                for (let j = i + 1; j < filesWithAI.length; j++) {
                    const file2 = filesWithAI[j];
                    const file2Key = file2.path || file2.id;

                    // Skip if already processed
                    if (processedFiles.has(file2Key)) {
                        continue;
                    }

                    const similarity = calculateContentSimilarity(file1, file2);

                    if (similarity >= threshold) {
                        group.duplicates.push({
                            file: file2,
                            similarity: similarity
                        });
                        processedFiles.add(file2Key);
                    }
                }

                // Only add to groups if duplicates were found
                if (group.duplicates.length > 0) {
                    // Calculate average similarity
                    const totalSimilarity = group.duplicates.reduce((sum, d) => sum + d.similarity, 0);
                    group.averageSimilarity = Math.round(totalSimilarity / group.duplicates.length);

                    duplicateGroups.push(group);
                    processedFiles.add(file1Key);
                }
            }

            // Sort groups by number of duplicates (most duplicates first)
            duplicateGroups.sort((a, b) => b.duplicates.length - a.duplicates.length);

            console.log(`Found ${duplicateGroups.length} duplicate groups`);

            return duplicateGroups;
        }

        // Function 3: Get duplicate statistics
        function getDuplicateStats(duplicateGroups) {
            let totalDuplicateFiles = 0;
            let potentialSpaceSaved = 0;

            duplicateGroups.forEach(group => {
                totalDuplicateFiles += group.duplicates.length;

                // Estimate space saved (sum of duplicate file sizes)
                group.duplicates.forEach(dup => {
                    if (dup.file.size) {
                        potentialSpaceSaved += dup.file.size;
                    }
                });
            });

            return {
                groupCount: duplicateGroups.length,
                totalDuplicates: totalDuplicateFiles,
                potentialSpaceSaved: potentialSpaceSaved,
                potentialSpaceSavedFormatted: formatFileSizeForDuplicates(potentialSpaceSaved)
            };
        }

        // Function 4: Format file size helper
        function formatFileSizeForDuplicates(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Function: Show smart duplicates modal
        function showSmartDuplicates() {
            const modal = document.getElementById('smartDuplicatesModal');
            modal.style.display = 'flex';

            // Show loading state
            document.getElementById('duplicatesLoading').style.display = 'block';
            document.getElementById('duplicateGroupsList').style.display = 'none';
            document.getElementById('noDuplicatesMessage').style.display = 'none';

            // Use setTimeout to allow UI to update before heavy computation
            setTimeout(() => {
                refreshDuplicates();
            }, 100);
        }

        // Function: Refresh duplicates with current threshold
        function refreshDuplicates() {
            const threshold = parseInt(document.getElementById('similarityThreshold').value);

            // Find duplicate groups
            currentDuplicateGroups = findDuplicateGroups(allFiles, threshold);

            // Get statistics
            const stats = getDuplicateStats(currentDuplicateGroups);

            // Update stats display
            document.getElementById('dupGroupCount').textContent = stats.groupCount;
            document.getElementById('dupFileCount').textContent = stats.totalDuplicates;
            document.getElementById('dupSpaceSaved').textContent = stats.potentialSpaceSavedFormatted;

            // Update sidebar count
            const sidebarCount = document.getElementById('smartDupCount');
            if (sidebarCount) {
                sidebarCount.textContent = stats.totalDuplicates;
            }

            // Hide loading
            document.getElementById('duplicatesLoading').style.display = 'none';

            // Show results or empty state
            if (currentDuplicateGroups.length === 0) {
                document.getElementById('noDuplicatesMessage').style.display = 'block';
                document.getElementById('duplicateGroupsList').style.display = 'none';
            } else {
                document.getElementById('noDuplicatesMessage').style.display = 'none';
                document.getElementById('duplicateGroupsList').style.display = 'block';
                renderDuplicateGroups(currentDuplicateGroups);
            }
        }

        // Function: Render duplicate groups
        function renderDuplicateGroups(groups) {
            const container = document.getElementById('duplicateGroupsList');
            container.innerHTML = '';

            groups.forEach((group, index) => {
                const primaryPath = (group.primary.path || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                const primarySummary = group.primary._summary || group.primary.ai_summary || group.primary.summary || '';
                const primaryTags = group.primary._aiTags || group.primary.ai_tags || group.primary.tags || [];

                const groupHTML = `
                    <div class="duplicate-group" style="background: rgba(30, 27, 75, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 16px; overflow: hidden;">
                        <!-- Group Header -->
                        <div class="duplicate-group-header" style="padding: 16px; background: rgba(124, 58, 237, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: #e2e8f0;">
                                    <i class="fas fa-layer-group" style="color: #f59e0b; margin-right: 8px;"></i>
                                    Group ${index + 1}
                                </span>
                                <span style="margin-left: 12px; font-size: 0.85rem; color: #94a3b8;">
                                    ${group.duplicates.length + 1} similar files &bull; ${group.averageSimilarity}% average similarity
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="toggleGroupExpand(${index})"
                                        style="padding: 6px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">
                                    <i class="fas fa-chevron-down" id="groupExpandIcon${index}"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Primary File -->
                        <div class="primary-file" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <div style="padding: 8px; background: rgba(16, 185, 129, 0.2); border-radius: 8px;">
                                    <i class="fas fa-star" style="color: #10b981;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #e2e8f0; margin-bottom: 4px; word-break: break-all;">
                                        ${group.primary.name}
                                        <span style="font-size: 0.75rem; padding: 2px 8px; background: rgba(16, 185, 129, 0.2); color: #10b981; border-radius: 4px; margin-left: 8px;">PRIMARY</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px; word-break: break-all;">
                                        ${group.primary.path || group.primary.id}
                                    </div>
                                    ${primarySummary ? `<div style="font-size: 0.85rem; color: #94a3b8; line-height: 1.5;">${primarySummary}</div>` : ''}
                                    ${primaryTags.length > 0 ? `
                                        <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                            ${primaryTags.slice(0, 6).map(tag => `<span style="font-size: 0.7rem; padding: 2px 8px; background: rgba(124, 58, 237, 0.3); color: #c4b5fd; border-radius: 9999px;">${tag}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    <button onclick="openFileLocationDup('${primaryPath}')"
                                            style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: none; color: #94a3b8; border-radius: 6px; cursor: pointer;"
                                            title="Copy file path">
                                        <i class="fas fa-folder-open"></i>
                                    </button>
                                    <button onclick="previewFileFromDup('${group.primary.id}')"
                                            style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: none; color: #94a3b8; border-radius: 6px; cursor: pointer;"
                                            title="Preview file">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Duplicate Files -->
                        <div class="duplicate-files-list" id="duplicatesList${index}" style="background: rgba(0,0,0,0.2);">
                            ${group.duplicates.map((dup, dupIndex) => {
                                const dupPath = (dup.file.path || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                                return `
                                    <div class="duplicate-file-item" style="padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: flex-start; gap: 12px;">
                                        <div style="padding: 8px; background: rgba(239, 68, 68, 0.2); border-radius: 8px;">
                                            <i class="fas fa-clone" style="color: #ef4444;"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; color: #e2e8f0; margin-bottom: 4px; word-break: break-all;">
                                                ${dup.file.name}
                                                <span style="font-size: 0.75rem; padding: 2px 8px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border-radius: 4px; margin-left: 8px;">${dup.similarity}% MATCH</span>
                                            </div>
                                            <div style="font-size: 0.8rem; color: #64748b; word-break: break-all;">
                                                ${dup.file.path || dup.file.id}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 6px;">
                                            <button onclick="openFileLocationDup('${dupPath}')"
                                                    style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: none; color: #94a3b8; border-radius: 6px; cursor: pointer;"
                                                    title="Copy file path">
                                                <i class="fas fa-folder-open"></i>
                                            </button>
                                            <button onclick="markForDeletion('${dupPath}')"
                                                    style="padding: 6px 10px; background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; border-radius: 6px; cursor: pointer;"
                                                    title="Mark for deletion">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', groupHTML);
            });
        }

        // Function: Close modal
        function closeSmartDuplicatesModal() {
            document.getElementById('smartDuplicatesModal').style.display = 'none';
        }

        // Function: Toggle group expand/collapse
        function toggleGroupExpand(index) {
            const list = document.getElementById(`duplicatesList${index}`);
            const icon = document.getElementById(`groupExpandIcon${index}`);

            if (list.style.display === 'none') {
                list.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
            } else {
                list.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            }
        }

        // Function: Open file location (copy to clipboard)
        function openFileLocationDup(filePath) {
            // Copy path to clipboard
            navigator.clipboard.writeText(filePath).then(() => {
                toast('File path copied to clipboard!', 'success');
            }).catch(() => {
                toast(`Path: ${filePath}`, 'info');
            });
        }

        // Function: Preview file from duplicates modal
        function previewFileFromDup(fileId) {
            const file = allFiles.find(f => f.id === fileId);
            if (file) {
                closeSmartDuplicatesModal();
                previewFile(fileId);
            }
        }

        // Function: Mark file for deletion
        function markForDeletion(filePath) {
            if (!filesMarkedForDeletion.includes(filePath)) {
                filesMarkedForDeletion.push(filePath);
                toast(`File marked for deletion. ${filesMarkedForDeletion.length} files in deletion list.`, 'info');
            } else {
                toast('File already marked for deletion', 'info');
            }
        }

        // Function: Export duplicate report
        function exportDuplicateReport() {
            const report = {
                generated: new Date().toISOString(),
                threshold: document.getElementById('similarityThreshold').value + '%',
                stats: getDuplicateStats(currentDuplicateGroups),
                groups: currentDuplicateGroups.map(group => ({
                    primaryFile: group.primary.name,
                    primaryPath: group.primary.path || group.primary.id,
                    primarySummary: group.primary._summary || group.primary.ai_summary || '',
                    duplicateCount: group.duplicates.length,
                    averageSimilarity: group.averageSimilarity,
                    duplicates: group.duplicates.map(d => ({
                        name: d.file.name,
                        path: d.file.path || d.file.id,
                        similarity: d.similarity
                    }))
                })),
                filesMarkedForDeletion: filesMarkedForDeletion
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `duplicate_report_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            toast('Duplicate report exported!', 'success');
        }

        // Function: Initialize smart duplicate count on load
        function initSmartDuplicateCount() {
            setTimeout(() => {
                const quickDuplicateGroups = findDuplicateGroups(allFiles, 70);
                const stats = getDuplicateStats(quickDuplicateGroups);

                const sidebarCount = document.getElementById('smartDupCount');
                if (sidebarCount) {
                    sidebarCount.textContent = stats.totalDuplicates;
                }
            }, 500);
        }

        // ============================================================
        // END OF SMART DUPLICATE DETECTION
        // ============================================================

        function showRelated(fileId) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            // Use enhanced similarity algorithm
            const relatedResults = findRelatedFiles(file, allFiles, 20);

            let contentHtml = '';
            if (relatedResults.length === 0) {
                contentHtml = '<p class="text-center text-purple-300 py-8">No related files found</p>';
            } else {
                contentHtml = relatedResults.map(item => {
                    const f = item.file;
                    const similarity = getSimilarityLevel(item.score);
                    const displayName = f.ai_suggested_name || f.name || 'Unknown';
                    const sharedTagsHtml = item.sharedTags.length > 0 ?
                        '<div class="flex gap-1 flex-wrap mt-1">' +
                        item.sharedTags.slice(0, 4).map(t => '<span class="px-2 py-0.5 bg-cyan-500/20 text-cyan-300 text-xs rounded-full">' + t + '</span>').join('') +
                        '</div>' : '';

                    return '<div class="flex justify-between items-start py-3 border-b border-white/10 last:border-0">' +
                        '<div class="flex-1">' +
                            '<div class="text-sm font-medium flex items-center gap-2">' +
                                '<span>' + displayName + '</span>' +
                                '<span class="related-similarity-badge ' + similarity.class + '">' + similarity.label + '</span>' +
                            '</div>' +
                            '<div class="text-xs text-purple-400 mt-1">' + (f.full_category || f.category || 'Uncategorized') + '</div>' +
                            sharedTagsHtml +
                        '</div>' +
                        '<button onclick="closeRelated(); previewFile(\'' + f.id + '\')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs ml-2">View</button>' +
                    '</div>';
                }).join('');
            }

            document.getElementById('relatedContent').innerHTML = contentHtml;
            document.getElementById('relatedModal').classList.remove('hidden');
        }
        function closeRelated() { document.getElementById('relatedModal').classList.add('hidden'); }

        function showContextMenu(x, y) { const menu = document.getElementById('contextMenu'); menu.style.left = Math.min(x, window.innerWidth - 200) + 'px'; menu.style.top = Math.min(y, window.innerHeight - 300) + 'px'; menu.classList.add('show'); }
        function contextAction(action) {
            document.getElementById('contextMenu').classList.remove('show');
            if (!contextMenuFile) return;
            const f = allFiles.find(x => x.id === contextMenuFile);
            switch(action) {
                case 'preview': previewFile(contextMenuFile); break;
                case 'favorite': toggleFavorite(contextMenuFile); break;
                case 'tags': openTagsEditor(contextMenuFile); break;
                case 'open': if (f?.link) window.open(f.link, '_blank'); break;
                case 'color': document.getElementById('colorPickerModal').classList.remove('hidden'); break;
                case 'rating': const r = prompt('Enter rating (1-5):', f?._rating || ''); if (r && !isNaN(r)) setRating(contextMenuFile, parseInt(r)); break;
                case 'related': showRelated(contextMenuFile); break;
                case 'copy': if (f?.link) { navigator.clipboard.writeText(f.link); toast('Link copied!', 'success'); } break;
                case 'smartRename': openLocalAIRename(contextMenuFile); break;
            }
        }
        function applyColorFromPicker(color) { if (contextMenuFile) setColor(contextMenuFile, color); closeColorPicker(); }
        function closeColorPicker() { document.getElementById('colorPickerModal').classList.add('hidden'); }

        function formatSize(bytes) { if (bytes === 0) return '0 B'; const k = 1024, sizes = ['B', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i]; }
        function formatFileSize(bytes) { return formatSize(bytes); } // Alias for formatSize
        function getFileTypeName(mimeType) { if (!mimeType) return 'Other'; if (mimeType.includes('folder')) return 'Folder'; if (mimeType.includes('image')) return 'Image'; if (mimeType.includes('video')) return 'Video'; if (mimeType.includes('audio')) return 'Audio'; if (mimeType.includes('pdf')) return 'PDF'; if (mimeType.includes('document') || mimeType.includes('word')) return 'Document'; if (mimeType.includes('spreadsheet') || mimeType.includes('excel')) return 'Spreadsheet'; if (mimeType.includes('presentation')) return 'Presentation'; if (mimeType.includes('text')) return 'Text'; if (mimeType.includes('json')) return 'JSON'; return 'Other'; }
        function getFileTypeIcon(type) { const icons = { 'Folder': '<i class="fas fa-folder text-yellow-400"></i>', 'Image': '<i class="fas fa-image text-pink-400"></i>', 'Video': '<i class="fas fa-video text-red-400"></i>', 'Audio': '<i class="fas fa-music text-green-400"></i>', 'PDF': '<i class="fas fa-file-pdf text-red-500"></i>', 'Document': '<i class="fas fa-file-word text-blue-400"></i>', 'Spreadsheet': '<i class="fas fa-file-excel text-green-500"></i>', 'Presentation': '<i class="fas fa-file-powerpoint text-orange-400"></i>', 'Text': '<i class="fas fa-file-alt text-gray-400"></i>', 'JSON': '<i class="fas fa-code text-blue-300"></i>', 'Other': '<i class="fas fa-file text-gray-400"></i>' }; return icons[type] || '<i class="fas fa-file text-gray-400"></i>'; }
        function getFileTypeIconFA(mimeType) { const type = getFileTypeName(mimeType); const icons = { 'Folder': '<i class="fas fa-folder text-yellow-400"></i>', 'Image': '<i class="fas fa-image text-pink-400"></i>', 'Video': '<i class="fas fa-video text-red-400"></i>', 'Audio': '<i class="fas fa-music text-green-400"></i>', 'PDF': '<i class="fas fa-file-pdf text-red-500"></i>', 'Document': '<i class="fas fa-file-word text-blue-400"></i>', 'Spreadsheet': '<i class="fas fa-file-excel text-green-500"></i>', 'Presentation': '<i class="fas fa-file-powerpoint text-orange-400"></i>', 'Text': '<i class="fas fa-file-alt text-gray-400"></i>', 'JSON': '<i class="fas fa-code text-blue-300"></i>', 'Other': '<i class="fas fa-file text-gray-400"></i>' }; return icons[type] || '<i class="fas fa-file text-gray-400"></i>'; }
        function toast(msg, type = 'success') { const t = document.getElementById('toast'); const icon = document.getElementById('toastIcon'); icon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle'; document.getElementById('toastMsg').textContent = msg; t.className = 'toast ' + type + ' show'; setTimeout(() => t.classList.remove('show'), 3000); }
        function toggleSection(header) { header.classList.toggle('collapsed'); const content = header.nextElementSibling; if (content) content.classList.toggle('collapsed'); }
        function exportData() { const data = JSON.stringify({ files: filteredFiles, preferences: userPrefs }, null, 2); const blob = new Blob([data], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'knowledge_base_export.json'; a.click(); toast('Exported ' + filteredFiles.length + ' files', 'success'); }

        function handleKeyboard(e) {
            // Handle Ctrl+Z for Undo
            if (e.ctrlKey && e.key.toLowerCase() === 'z' && !e.shiftKey) {
                e.preventDefault();
                performUndo();
                return;
            }
            // Handle Ctrl+Shift+S for Smart Search toggle
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                toggleSmartSearch();
                return;
            }
            // Handle Escape in search input
            if (e.key === 'Escape' && document.activeElement === document.getElementById('searchInput')) {
                clearSearch();
                document.getElementById('searchInput').blur();
                return;
            }
            if (e.target.matches('input, textarea')) return;
            switch(e.key.toLowerCase()) {
                case '/': e.preventDefault(); document.getElementById('searchInput').focus(); break;
                case 'escape': closePreview(); closeAnalytics(); closeDuplicates(); closeSmartDuplicatesModal(); closeRelated(); closeColorPicker(); closeTagsEditor(); closeUserManual(); closeAIRenamer(); closeLocalAIRename(); clearAllFilters(); break;
                case 'g': document.getElementById('viewMode').value = 'grid'; changeViewMode(); toast('Grid view', 'info'); break;
                case 'l': document.getElementById('viewMode').value = 'list'; changeViewMode(); toast('List view', 'info'); break;
                case 'k': document.getElementById('viewMode').value = 'kanban'; changeViewMode(); toast('Kanban view', 'info'); break;
                case 'p': document.getElementById('viewMode').value = 'dual'; changeViewMode(); toast('Dual-Pane view', 'info'); break;
                case 'd': showDuplicates(); break;
                case 'c': showSmartDuplicates(); break;
                case 'r': showRecent(); break;
                case 'a': if (!e.ctrlKey) showAnalytics(); break;
                case 'f': if (selectedFiles.size > 0) bulkFavorite(); break;
                case 't': if (selectedFiles.size === 1) openTagsEditor(Array.from(selectedFiles)[0]); break;
                case 'n': if (selectedFiles.size === 1) openLocalAIRename(Array.from(selectedFiles)[0]); break;
                case '?': showUserManual(); break;
                case '1': case '2': case '3': case '4': case '5': if (selectedFiles.size === 1) setRating(Array.from(selectedFiles)[0], parseInt(e.key)); break;
            }
        }

        // ==========================================
        // COMPREHENSIVE USER MANUAL SYSTEM
        // ==========================================
        let currentManualSection = 'welcome';
        const manualSections = ['welcome','getting-started','sidebar','search','views','personalization','preview','analytics','special-tools','shortcuts','context-menu','workflows','data','troubleshooting'];

        function showUserManual() {
            document.getElementById('userManualModal').classList.remove('hidden');
            initComprehensiveManual();
        }
        function closeUserManual() { document.getElementById('userManualModal').classList.add('hidden'); }

        function initComprehensiveManual() {
            const navItems = document.querySelectorAll('.manual-nav-item');
            navItems.forEach(item => {
                item.onclick = function() {
                    navigateToSection(this.dataset.section);
                };
            });
            navigateToSection('welcome');
        }

        function navigateToSection(section) {
            currentManualSection = section;
            const navItems = document.querySelectorAll('.manual-nav-item');
            navItems.forEach(item => {
                if (item.dataset.section === section) {
                    item.classList.add('bg-amber-500/30','text-amber-100','border','border-amber-500/30');
                    item.classList.remove('hover:bg-white/10','text-purple-200');
                } else {
                    item.classList.remove('bg-amber-500/30','text-amber-100','border','border-amber-500/30');
                    item.classList.add('hover:bg-white/10','text-purple-200');
                }
            });
            document.getElementById('manualContentArea').innerHTML = getComprehensiveManualContent(section);
            document.getElementById('manualContentArea').scrollTop = 0;
        }

        function navigateManual(dir) {
            const idx = manualSections.indexOf(currentManualSection);
            if (dir === 'next' && idx < manualSections.length - 1) navigateToSection(manualSections[idx + 1]);
            else if (dir === 'prev' && idx > 0) navigateToSection(manualSections[idx - 1]);
        }

        function searchManual(query) {
            const q = query.toLowerCase();
            document.querySelectorAll('.manual-nav-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(q) ? 'flex' : 'none';
            });
        }

        function printManual() {
            const content = document.getElementById('manualContentArea').innerHTML;
            const win = window.open('','','width=800,height=600');
            win.document.write('<html><head>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ec4899">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="<head>#129504; Kn">
  <link rel="apple-touch-icon" href="icons/icon.svg">
  <meta name="mobile-web-app-capable" content="yes"><title>Knowledge Base Dashboard Manual</title><style>body{font-family:system-ui;padding:40px;max-width:800px;margin:0 auto}h1,h2,h3{color:#6b21a8}kbd{background:#e9d5ff;padding:2px 8px;border-radius:4px}code{background:#f3e8ff;padding:2px 6px;border-radius:3px}.tip-box{background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;margin:12px 0}.warning-box{background:#fee2e2;border-left:4px solid #ef4444;padding:12px;margin:12px 0}</style></head><body>'+content+'<script>if("serviceWorker"in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(r=>console.log("SW:",r.scope)).catch(e=>console.log("SW err:",e));});}</script>
</body></html>');
            win.document.close();
            win.print();
        }

        function getComprehensiveManualContent(section) {
            const c = {
'welcome': `
<div class="text-center mb-10">
    <div class="text-7xl mb-4">&#129504;</div>
    <h1 class="text-4xl font-bold bg-gradient-to-r from-white via-purple-300 to-amber-300 bg-clip-text text-transparent mb-3">Knowledge Base Dashboard</h1>
    <p class="text-xl text-purple-300">Complete User Manual - Version 3.0</p>
    <p class="text-sm text-gray-400 mt-2">Your comprehensive guide to organizing 27,566+ files with 39+ powerful features</p>
</div>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-gradient-to-br from-purple-600/30 to-purple-800/30 p-5 rounded-xl text-center border border-purple-500/30">
        <div class="text-3xl font-bold text-purple-400">27,566+</div>
        <div class="text-sm text-gray-400">Total Files</div>
    </div>
    <div class="bg-gradient-to-br from-cyan-600/30 to-cyan-800/30 p-5 rounded-xl text-center border border-cyan-500/30">
        <div class="text-3xl font-bold text-cyan-400">100+</div>
        <div class="text-sm text-gray-400">Categories</div>
    </div>
    <div class="bg-gradient-to-br from-green-600/30 to-green-800/30 p-5 rounded-xl text-center border border-green-500/30">
        <div class="text-3xl font-bold text-green-400">9</div>
        <div class="text-sm text-gray-400">Domains</div>
    </div>
    <div class="bg-gradient-to-br from-amber-600/30 to-amber-800/30 p-5 rounded-xl text-center border border-amber-500/30">
        <div class="text-3xl font-bold text-amber-400">39+</div>
        <div class="text-sm text-gray-400">Features</div>
    </div>
</div>

<div class="bg-gradient-to-r from-amber-500/20 to-yellow-500/20 border border-amber-500/30 rounded-xl p-6 mb-8">
    <h3 class="text-lg font-bold text-amber-300 mb-3"><i class="fas fa-star mr-2"></i>What This Dashboard Does</h3>
    <p class="text-purple-200 mb-4">This dashboard transforms your Google Drive knowledge base into an interactive, searchable, and highly organized workspace. Every feature is designed to help you find files instantly, organize them your way, and discover insights about your collection.</p>
    <div class="grid grid-cols-2 gap-3 text-sm">
        <div class="flex items-start gap-2"><i class="fas fa-check text-green-400 mt-1"></i><span class="text-purple-200">Instant search with wildcards & regex</span></div>
        <div class="flex items-start gap-2"><i class="fas fa-check text-green-400 mt-1"></i><span class="text-purple-200">5 different view modes</span></div>
        <div class="flex items-start gap-2"><i class="fas fa-check text-green-400 mt-1"></i><span class="text-purple-200">Star ratings & color labels</span></div>
        <div class="flex items-start gap-2"><i class="fas fa-check text-green-400 mt-1"></i><span class="text-purple-200">Custom tags & personal notes</span></div>
        <div class="flex items-start gap-2"><i class="fas fa-check text-green-400 mt-1"></i><span class="text-purple-200">Advanced analytics with 6 tabs</span></div>
        <div class="flex items-start gap-2"><i class="fas fa-check text-green-400 mt-1"></i><span class="text-purple-200">Duplicate detection (MD5 & AI)</span></div>
        <div class="flex items-start gap-2"><i class="fas fa-check text-green-400 mt-1"></i><span class="text-purple-200">AI-powered smart rename</span></div>
        <div class="flex items-start gap-2"><i class="fas fa-check text-green-400 mt-1"></i><span class="text-purple-200">Research assistant chat</span></div>
    </div>
</div>

<h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-book-reader text-purple-400"></i>Manual Sections Overview</h3>
<div class="grid grid-cols-2 gap-3">
    <div class="bg-white/5 p-4 rounded-xl hover:bg-white/10 cursor-pointer transition-colors" onclick="navigateToSection('getting-started')">
        <h4 class="font-semibold text-cyan-400 mb-1"><i class="fas fa-rocket mr-2"></i>Getting Started</h4>
        <p class="text-sm text-gray-400">Load your data and start exploring in 5 minutes</p>
    </div>
    <div class="bg-white/5 p-4 rounded-xl hover:bg-white/10 cursor-pointer transition-colors" onclick="navigateToSection('sidebar')">
        <h4 class="font-semibold text-green-400 mb-1"><i class="fas fa-bars mr-2"></i>Sidebar Navigation</h4>
        <p class="text-sm text-gray-400">Quick actions, virtual folders, sources, categories</p>
    </div>
    <div class="bg-white/5 p-4 rounded-xl hover:bg-white/10 cursor-pointer transition-colors" onclick="navigateToSection('search')">
        <h4 class="font-semibold text-yellow-400 mb-1"><i class="fas fa-search mr-2"></i>Search & Filtering</h4>
        <p class="text-sm text-gray-400">Wildcards, regex, smart search with relevance</p>
    </div>
    <div class="bg-white/5 p-4 rounded-xl hover:bg-white/10 cursor-pointer transition-colors" onclick="navigateToSection('views')">
        <h4 class="font-semibold text-pink-400 mb-1"><i class="fas fa-th-large mr-2"></i>View Modes</h4>
        <p class="text-sm text-gray-400">Grid, List, Kanban, Compact, Dual-Pane</p>
    </div>
    <div class="bg-white/5 p-4 rounded-xl hover:bg-white/10 cursor-pointer transition-colors" onclick="navigateToSection('personalization')">
        <h4 class="font-semibold text-purple-400 mb-1"><i class="fas fa-palette mr-2"></i>Personalization</h4>
        <p class="text-sm text-gray-400">Ratings, colors, favorites, tags, notes</p>
    </div>
    <div class="bg-white/5 p-4 rounded-xl hover:bg-white/10 cursor-pointer transition-colors" onclick="navigateToSection('analytics')">
        <h4 class="font-semibold text-blue-400 mb-1"><i class="fas fa-chart-pie mr-2"></i>Analytics</h4>
        <p class="text-sm text-gray-400">6-tab dashboard with health scores</p>
    </div>
</div>
`,

'getting-started': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-rocket text-xl"></i>
    </div>
    Getting Started
</h1>

<div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-5 mb-8">
    <p class="text-cyan-200"><i class="fas fa-info-circle mr-2"></i>This guide will have you exploring your knowledge base in under 5 minutes. Follow these steps in order for the best experience.</p>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Step 1: Load Your Knowledge Base</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="flex items-start gap-4">
        <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">1</div>
        <div class="flex-1">
            <h4 class="font-semibold text-lg mb-2">Click the "Select knowledge_base.json" Button</h4>
            <p class="text-purple-300 mb-3">Located at the top of the main content area. This button opens a file picker dialog.</p>
            <div class="bg-black/30 rounded-lg p-4 text-sm">
                <p class="text-gray-400 mb-2">Your JSON file is typically located at:</p>
                <code class="text-cyan-400">C:\\Users\\YourName\\Desktop\\KnowledgeBase\\knowledge_base_output\\knowledge_base.json</code>
            </div>
        </div>
    </div>
</div>

<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="flex items-start gap-4">
        <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">2</div>
        <div class="flex-1">
            <h4 class="font-semibold text-lg mb-2">Wait for Files to Load</h4>
            <p class="text-purple-300 mb-3">The dashboard will process your JSON file and display statistics. For 27,000+ files, this takes 2-5 seconds.</p>
            <div class="flex gap-4 mt-4">
                <div class="bg-purple-600/20 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-purple-400">27,566</div>
                    <div class="text-xs text-gray-400">Files Loaded</div>
                </div>
                <div class="bg-cyan-600/20 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-cyan-400">9</div>
                    <div class="text-xs text-gray-400">Domains</div>
                </div>
                <div class="bg-green-600/20 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-400">100+</div>
                    <div class="text-xs text-gray-400">Categories</div>
                </div>
            </div>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Step 2: Your First Search</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="flex items-start gap-4">
        <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">3</div>
        <div class="flex-1">
            <h4 class="font-semibold text-lg mb-2">Press <kbd class="bg-purple-600 px-3 py-1 rounded mx-1">/</kbd> to Focus Search</h4>
            <p class="text-purple-300 mb-3">This keyboard shortcut instantly focuses the search box. Try these searches:</p>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-black/30 rounded-lg p-3">
                    <code class="text-yellow-400">adhd</code>
                    <p class="text-xs text-gray-400 mt-1">Find all ADHD-related files</p>
                </div>
                <div class="bg-black/30 rounded-lg p-3">
                    <code class="text-yellow-400">*.pdf</code>
                    <p class="text-xs text-gray-400 mt-1">Find all PDF files</p>
                </div>
                <div class="bg-black/30 rounded-lg p-3">
                    <code class="text-yellow-400">patient*</code>
                    <p class="text-xs text-gray-400 mt-1">Wildcard search</p>
                </div>
                <div class="bg-black/30 rounded-lg p-3">
                    <code class="text-yellow-400">2024</code>
                    <p class="text-xs text-gray-400 mt-1">Find 2024 files</p>
                </div>
            </div>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Step 3: Preview a File</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="flex items-start gap-4">
        <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center font-bold shrink-0">4</div>
        <div class="flex-1">
            <h4 class="font-semibold text-lg mb-2">Click Any File Card</h4>
            <p class="text-purple-300 mb-3">Opens the Preview Modal where you can:</p>
            <ul class="space-y-2 text-purple-200">
                <li><i class="fas fa-star text-yellow-400 mr-2"></i>Rate the file 1-5 stars</li>
                <li><i class="fas fa-palette text-pink-400 mr-2"></i>Apply a color label</li>
                <li><i class="fas fa-heart text-red-400 mr-2"></i>Mark as favorite</li>
                <li><i class="fas fa-tags text-green-400 mr-2"></i>Add custom tags</li>
                <li><i class="fas fa-sticky-note text-cyan-400 mr-2"></i>Write personal notes</li>
                <li><i class="fas fa-external-link-alt text-purple-400 mr-2"></i>Open in Google Drive</li>
            </ul>
        </div>
    </div>
</div>

<div class="bg-amber-500/20 border border-amber-500/30 rounded-xl p-5 mt-6">
    <h4 class="font-bold text-amber-300 mb-2"><i class="fas fa-lightbulb mr-2"></i>Pro Tip: Essential Shortcuts</h4>
    <p class="text-purple-200 mb-3">Master these 5 shortcuts to navigate 10x faster:</p>
    <div class="flex flex-wrap gap-3">
        <span class="bg-black/30 px-3 py-2 rounded-lg"><kbd class="bg-purple-600 px-2 py-1 rounded mr-2">/</kbd>Search</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg"><kbd class="bg-purple-600 px-2 py-1 rounded mr-2">G</kbd>Grid</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg"><kbd class="bg-purple-600 px-2 py-1 rounded mr-2">L</kbd>List</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg"><kbd class="bg-purple-600 px-2 py-1 rounded mr-2">A</kbd>Analytics</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg"><kbd class="bg-purple-600 px-2 py-1 rounded mr-2">Esc</kbd>Close</span>
    </div>
</div>
`,

'sidebar': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-bars text-xl"></i>
    </div>
    Sidebar Navigation
</h1>

<p class="text-lg text-purple-300 mb-8">The sidebar is your command center for filtering and navigating your knowledge base. It contains 8 major sections, each designed for a specific purpose.</p>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-bolt text-yellow-400 mr-2"></i>Quick Actions</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">One-click access to common operations:</p>
    <div class="grid grid-cols-2 gap-3">
        <div class="bg-black/30 rounded-lg p-3 flex items-center gap-3">
            <i class="fas fa-heart text-red-400"></i>
            <div>
                <div class="font-semibold">Show Favorites</div>
                <div class="text-xs text-gray-400">Filter to favorited files only</div>
            </div>
        </div>
        <div class="bg-black/30 rounded-lg p-3 flex items-center gap-3">
            <i class="fas fa-star text-yellow-400"></i>
            <div>
                <div class="font-semibold">Show Rated</div>
                <div class="text-xs text-gray-400">Files with 1-5 star ratings</div>
            </div>
        </div>
        <div class="bg-black/30 rounded-lg p-3 flex items-center gap-3">
            <i class="fas fa-clock text-cyan-400"></i>
            <div>
                <div class="font-semibold">Recent Files</div>
                <div class="text-xs text-gray-400">Last 50 modified files (R)</div>
            </div>
        </div>
        <div class="bg-black/30 rounded-lg p-3 flex items-center gap-3">
            <i class="fas fa-chart-pie text-purple-400"></i>
            <div>
                <div class="font-semibold">Analytics</div>
                <div class="text-xs text-gray-400">Open analytics dashboard (A)</div>
            </div>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-folder text-blue-400 mr-2"></i>Virtual Folders</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Smart collections based on your organization:</p>
    <div class="space-y-3">
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-pink-400 mb-2">By Color</h4>
            <p class="text-sm text-gray-400">Click any color to see all files with that label. Colors include: Red, Orange, Yellow, Green, Blue, Purple, Pink, Cyan.</p>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-yellow-400 mb-2">By Rating</h4>
            <p class="text-sm text-gray-400">Filter files by star rating (1-5 stars). Great for finding your highest-rated resources.</p>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-database text-purple-400 mr-2"></i>Sources Section</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Filter by where files came from:</p>
    <div class="flex flex-wrap gap-2">
        <span class="bg-purple-600/30 px-3 py-2 rounded-lg text-sm">Google Drive</span>
        <span class="bg-blue-600/30 px-3 py-2 rounded-lg text-sm">Local Files</span>
        <span class="bg-green-600/30 px-3 py-2 rounded-lg text-sm">Downloads</span>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-globe text-cyan-400 mr-2"></i>Domains Section</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Your 9 knowledge domains with file counts:</p>
    <div class="grid grid-cols-3 gap-2 text-sm">
        <span class="bg-black/30 px-3 py-2 rounded-lg">Psychiatry</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg">Media Production</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg">Business</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg">Technology</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg">Personal</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg">Education</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg">Creative</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg">Research</span>
        <span class="bg-black/30 px-3 py-2 rounded-lg">Archives</span>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-sitemap text-green-400 mr-2"></i>Categories Tree</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Hierarchical, collapsible category browser with 100+ categories. Click arrows to expand/collapse. Each category shows its file count.</p>
    <div class="bg-black/30 rounded-lg p-4 font-mono text-sm">
        <div class="text-gray-400">&#9660; Psychiatry (5,234)</div>
        <div class="text-gray-400 ml-4">&#9660; ADHD (1,823)</div>
        <div class="text-gray-500 ml-8">&#8226; Assessment Tools (234)</div>
        <div class="text-gray-500 ml-8">&#8226; Treatment Protocols (456)</div>
        <div class="text-gray-400 ml-4">&#9654; Anxiety (987)...</div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-file-alt text-orange-400 mr-2"></i>File Types</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Filter by file format:</p>
    <div class="flex flex-wrap gap-2">
        <span class="bg-red-600/30 px-3 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-1"></i>PDFs</span>
        <span class="bg-blue-600/30 px-3 py-2 rounded-lg text-sm"><i class="fas fa-file-word mr-1"></i>Documents</span>
        <span class="bg-green-600/30 px-3 py-2 rounded-lg text-sm"><i class="fas fa-file-excel mr-1"></i>Spreadsheets</span>
        <span class="bg-yellow-600/30 px-3 py-2 rounded-lg text-sm"><i class="fas fa-file-powerpoint mr-1"></i>Presentations</span>
        <span class="bg-purple-600/30 px-3 py-2 rounded-lg text-sm"><i class="fas fa-image mr-1"></i>Images</span>
        <span class="bg-pink-600/30 px-3 py-2 rounded-lg text-sm"><i class="fas fa-video mr-1"></i>Videos</span>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-tags text-teal-400 mr-2"></i>Tags Cloud</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Your custom tags appear here. Click any tag to filter. Tags with more files appear larger.</p>
</div>
`,

'search': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-search text-xl"></i>
    </div>
    Search & Filtering
</h1>

<p class="text-lg text-purple-300 mb-8">The search system is the fastest way to find files. It supports instant search, wildcards, regular expressions, and AI-powered smart search.</p>

<h2 class="text-2xl font-bold mb-4 text-white">Basic Search</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Press <kbd class="bg-purple-600 px-3 py-1 rounded mx-1">/</kbd> to focus the search box. Results appear instantly as you type.</p>
    <div class="space-y-3">
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-cyan-400 mb-2">Plain Text Search</h4>
            <code class="text-yellow-400">adhd treatment</code>
            <p class="text-sm text-gray-400 mt-2">Finds files containing "adhd" AND "treatment" anywhere in the name, path, or tags.</p>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Wildcard Search</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Use * and ? for flexible matching:</p>
    <div class="grid grid-cols-2 gap-3">
        <div class="bg-black/30 rounded-lg p-4">
            <code class="text-yellow-400">*.pdf</code>
            <p class="text-sm text-gray-400 mt-2">All PDF files</p>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <code class="text-yellow-400">patient*</code>
            <p class="text-sm text-gray-400 mt-2">Files starting with "patient"</p>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <code class="text-yellow-400">*2024*</code>
            <p class="text-sm text-gray-400 mt-2">Files containing "2024"</p>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <code class="text-yellow-400">report?.docx</code>
            <p class="text-sm text-gray-400 mt-2">report1.docx, report2.docx, etc.</p>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Regex Mode</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Toggle "Regex" checkbox for regular expression searches:</p>
    <div class="grid grid-cols-2 gap-3">
        <div class="bg-black/30 rounded-lg p-4">
            <code class="text-yellow-400">^ADHD.*\\.pdf$</code>
            <p class="text-sm text-gray-400 mt-2">PDFs starting with "ADHD"</p>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <code class="text-yellow-400">\\d{4}-\\d{2}-\\d{2}</code>
            <p class="text-sm text-gray-400 mt-2">Date pattern (YYYY-MM-DD)</p>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-brain text-purple-400 mr-2"></i>Smart Search (AI-Powered)</h2>
<div class="bg-gradient-to-r from-purple-500/20 to-cyan-500/20 border border-purple-500/30 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Press <kbd class="bg-purple-600 px-3 py-1 rounded mx-1">Ctrl+Shift+S</kbd> to open Smart Search. This AI-powered search understands context and ranks results by relevance.</p>
    <h4 class="font-semibold text-cyan-400 mb-2">Features:</h4>
    <ul class="space-y-2 text-purple-200 text-sm">
        <li><i class="fas fa-check text-green-400 mr-2"></i><strong>Relevance Scoring</strong> - Results ranked by how well they match</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i><strong>Match Highlighting</strong> - See exactly what matched</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i><strong>Category Boosting</strong> - Prioritizes matches in relevant domains</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i><strong>Recency Weighting</strong> - Newer files ranked higher</li>
    </ul>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Search Options</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="space-y-4">
        <div class="flex items-center gap-4">
            <div class="w-32 text-purple-400 font-semibold">Case Sensitive</div>
            <div class="text-purple-200">Toggle to match exact letter case</div>
        </div>
        <div class="flex items-center gap-4">
            <div class="w-32 text-purple-400 font-semibold">Regex Mode</div>
            <div class="text-purple-200">Enable regular expression syntax</div>
        </div>
        <div class="flex items-center gap-4">
            <div class="w-32 text-purple-400 font-semibold">Search In</div>
            <div class="text-purple-200">Search names, paths, tags, or all</div>
        </div>
    </div>
</div>

<div class="bg-amber-500/20 border border-amber-500/30 rounded-xl p-5">
    <h4 class="font-bold text-amber-300 mb-2"><i class="fas fa-lightbulb mr-2"></i>Pro Tips</h4>
    <ul class="space-y-2 text-purple-200 text-sm">
        <li><i class="fas fa-arrow-right text-amber-400 mr-2"></i>Press <kbd class="bg-purple-600 px-2 py-1 rounded text-xs">Esc</kbd> to clear search and show all files</li>
        <li><i class="fas fa-arrow-right text-amber-400 mr-2"></i>Combine search with sidebar filters for precise results</li>
        <li><i class="fas fa-arrow-right text-amber-400 mr-2"></i>Search is instant - no need to press Enter</li>
    </ul>
</div>
`,

'views': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-th-large text-xl"></i>
    </div>
    View Modes
</h1>

<p class="text-lg text-purple-300 mb-8">Choose from 5 different view modes to display your files. Each mode is optimized for different tasks. Switch instantly using keyboard shortcuts.</p>

<h2 class="text-2xl font-bold mb-4 text-white flex items-center gap-2">
    <kbd class="bg-purple-600 px-3 py-1 rounded text-sm">G</kbd> Grid View
</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="flex gap-6">
        <div class="flex-1">
            <p class="text-purple-300 mb-3">Visual cards in a responsive grid. Best for browsing and visual scanning.</p>
            <ul class="space-y-2 text-sm text-purple-200">
                <li><i class="fas fa-check text-green-400 mr-2"></i>Shows file icon, name, domain, category</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>Color labels visible as borders</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>Star ratings displayed on cards</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>Heart icon for favorites</li>
            </ul>
        </div>
        <div class="w-48 bg-black/30 rounded-xl p-3 shrink-0">
            <div class="grid grid-cols-2 gap-2">
                <div class="bg-purple-600/30 h-16 rounded-lg"></div>
                <div class="bg-cyan-600/30 h-16 rounded-lg"></div>
                <div class="bg-green-600/30 h-16 rounded-lg"></div>
                <div class="bg-yellow-600/30 h-16 rounded-lg"></div>
            </div>
            <p class="text-xs text-gray-500 text-center mt-2">Grid Layout</p>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white flex items-center gap-2">
    <kbd class="bg-purple-600 px-3 py-1 rounded text-sm">L</kbd> List View
</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="flex gap-6">
        <div class="flex-1">
            <p class="text-purple-300 mb-3">Detailed rows with sortable columns. Best for comparing and sorting.</p>
            <ul class="space-y-2 text-sm text-purple-200">
                <li><i class="fas fa-check text-green-400 mr-2"></i>Click headers to sort (Name, Size, Date, Rating)</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>Shows more files at once</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>Full path visible</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>File size and date columns</li>
            </ul>
        </div>
        <div class="w-48 bg-black/30 rounded-xl p-3 shrink-0">
            <div class="space-y-1">
                <div class="bg-purple-600/30 h-6 rounded"></div>
                <div class="bg-cyan-600/30 h-6 rounded"></div>
                <div class="bg-green-600/30 h-6 rounded"></div>
                <div class="bg-yellow-600/30 h-6 rounded"></div>
            </div>
            <p class="text-xs text-gray-500 text-center mt-2">List Layout</p>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white flex items-center gap-2">
    <kbd class="bg-purple-600 px-3 py-1 rounded text-sm">K</kbd> Kanban View
</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="flex gap-6">
        <div class="flex-1">
            <p class="text-purple-300 mb-3">Columns organized by domain. Great for project management style viewing.</p>
            <ul class="space-y-2 text-sm text-purple-200">
                <li><i class="fas fa-check text-green-400 mr-2"></i>One column per domain</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>Horizontal scrolling for many domains</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>Cards stacked within columns</li>
            </ul>
        </div>
        <div class="w-48 bg-black/30 rounded-xl p-3 shrink-0">
            <div class="flex gap-2">
                <div class="flex-1 space-y-1">
                    <div class="bg-purple-600/30 h-8 rounded"></div>
                    <div class="bg-purple-600/20 h-8 rounded"></div>
                </div>
                <div class="flex-1 space-y-1">
                    <div class="bg-cyan-600/30 h-8 rounded"></div>
                    <div class="bg-cyan-600/20 h-8 rounded"></div>
                </div>
            </div>
            <p class="text-xs text-gray-500 text-center mt-2">Kanban Layout</p>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white flex items-center gap-2">
    <kbd class="bg-purple-600 px-3 py-1 rounded text-sm">C</kbd> Compact View
</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-3">Minimal cards showing just filenames. Maximizes visible files. Great for rapid scanning.</p>
</div>

<h2 class="text-2xl font-bold mb-4 text-white flex items-center gap-2">
    <kbd class="bg-purple-600 px-3 py-1 rounded text-sm">P</kbd> Dual-Pane View
</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-3">Split view with file list on left and preview on right. Perfect for reviewing files without opening modals.</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-check text-green-400 mr-2"></i>Click file in left pane to preview on right</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Full file details in preview pane</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Add ratings/tags without opening modal</li>
    </ul>
</div>
`,

'personalization': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-palette text-xl"></i>
    </div>
    Personalization Features
</h1>

<p class="text-lg text-purple-300 mb-8">Make your knowledge base truly yours. All personalization data is saved locally and persists across sessions.</p>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-star text-yellow-400 mr-2"></i>Star Ratings (1-5)</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Rate files from 1 to 5 stars to mark their importance or quality.</p>
    <div class="bg-black/30 rounded-lg p-4 mb-4">
        <h4 class="font-semibold mb-2">How to Rate:</h4>
        <ul class="space-y-2 text-sm text-purple-200">
            <li><i class="fas fa-keyboard text-cyan-400 mr-2"></i>Select file, press <kbd class="bg-purple-600 px-2 py-1 rounded text-xs">1</kbd>-<kbd class="bg-purple-600 px-2 py-1 rounded text-xs">5</kbd></li>
            <li><i class="fas fa-mouse-pointer text-cyan-400 mr-2"></i>Click stars in Preview Modal</li>
            <li><i class="fas fa-mouse text-cyan-400 mr-2"></i>Right-click > Rating submenu</li>
        </ul>
    </div>
    <div class="flex gap-4 text-sm">
        <div class="flex items-center gap-1"><span class="text-yellow-400">&#9733;&#9733;&#9733;&#9733;&#9733;</span> Critical</div>
        <div class="flex items-center gap-1"><span class="text-yellow-400">&#9733;&#9733;&#9733;&#9733;</span><span class="text-gray-500">&#9733;</span> Important</div>
        <div class="flex items-center gap-1"><span class="text-yellow-400">&#9733;&#9733;&#9733;</span><span class="text-gray-500">&#9733;&#9733;</span> Useful</div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-palette text-pink-400 mr-2"></i>Color Labels</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Apply one of 8 colors to visually categorize files:</p>
    <div class="grid grid-cols-4 gap-3 mb-4">
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-red-500"></div><span>Red</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-orange-500"></div><span>Orange</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-yellow-500"></div><span>Yellow</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-green-500"></div><span>Green</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-blue-500"></div><span>Blue</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-purple-500"></div><span>Purple</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-pink-500"></div><span>Pink</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-cyan-500"></div><span>Cyan</span></div>
    </div>
    <div class="bg-amber-500/20 border border-amber-500/30 rounded-lg p-4">
        <h4 class="font-bold text-amber-300 mb-2"><i class="fas fa-lightbulb mr-2"></i>Suggested Color Coding System</h4>
        <div class="grid grid-cols-2 gap-2 text-sm">
            <div><span class="text-red-400">Red</span> = Urgent/Priority</div>
            <div><span class="text-yellow-400">Yellow</span> = Needs Review</div>
            <div><span class="text-green-400">Green</span> = Completed/Good</div>
            <div><span class="text-blue-400">Blue</span> = Reference</div>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-heart text-red-400 mr-2"></i>Favorites</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Mark your most important files with a heart. Access them instantly via Quick Actions.</p>
    <div class="bg-black/30 rounded-lg p-4">
        <h4 class="font-semibold mb-2">How to Favorite:</h4>
        <ul class="space-y-2 text-sm text-purple-200">
            <li><i class="fas fa-keyboard text-cyan-400 mr-2"></i>Select file, press <kbd class="bg-purple-600 px-2 py-1 rounded text-xs">F</kbd></li>
            <li><i class="fas fa-mouse-pointer text-cyan-400 mr-2"></i>Click heart icon on card or in Preview</li>
            <li><i class="fas fa-mouse text-cyan-400 mr-2"></i>Right-click > Favorite</li>
        </ul>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-tags text-green-400 mr-2"></i>Custom Tags</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Create your own tags for any categorization system. Tags appear in the sidebar's Tags Cloud.</p>
    <div class="bg-black/30 rounded-lg p-4 mb-4">
        <h4 class="font-semibold mb-2">How to Add Tags:</h4>
        <ul class="space-y-2 text-sm text-purple-200">
            <li><i class="fas fa-keyboard text-cyan-400 mr-2"></i>Select file, press <kbd class="bg-purple-600 px-2 py-1 rounded text-xs">T</kbd></li>
            <li><i class="fas fa-mouse-pointer text-cyan-400 mr-2"></i>Click Tags button in Preview Modal</li>
            <li><i class="fas fa-mouse text-cyan-400 mr-2"></i>Right-click > Tags</li>
        </ul>
    </div>
    <p class="text-sm text-gray-400">Examples: project-alpha, to-read, important-2024, needs-review</p>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-sticky-note text-cyan-400 mr-2"></i>Personal Notes</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Add private notes to any file. Notes are saved locally and only visible to you.</p>
    <p class="text-sm text-gray-400">Access via the Preview Modal's Notes tab. Notes support multi-line text.</p>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-undo text-blue-400 mr-2"></i>Undo System</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Made a mistake? Press <kbd class="bg-purple-600 px-3 py-1 rounded mx-1">Ctrl+Z</kbd> to undo the last action.</p>
    <p class="text-sm text-gray-400">Works for: favorites, ratings, colors, and tags. An undo bar appears at the bottom with a timer.</p>
</div>
`,

'preview': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-eye text-xl"></i>
    </div>
    Preview Modal
</h1>

<p class="text-lg text-purple-300 mb-8">Click any file card to open the Preview Modal - your detailed view for file information and personalization.</p>

<h2 class="text-2xl font-bold mb-4 text-white">Modal Sections</h2>
<div class="space-y-4 mb-8">
    <div class="bg-white/5 rounded-xl p-5">
        <h4 class="font-semibold text-cyan-400 mb-2"><i class="fas fa-info-circle mr-2"></i>File Information</h4>
        <ul class="space-y-1 text-sm text-purple-200">
            <li>Full file name and extension</li>
            <li>Complete file path</li>
            <li>File size (formatted)</li>
            <li>Last modified date</li>
            <li>MIME type</li>
            <li>Domain and Category</li>
        </ul>
    </div>

    <div class="bg-white/5 rounded-xl p-5">
        <h4 class="font-semibold text-yellow-400 mb-2"><i class="fas fa-star mr-2"></i>Rating Section</h4>
        <p class="text-sm text-purple-200">Click stars to rate 1-5, or press number keys 1-5.</p>
    </div>

    <div class="bg-white/5 rounded-xl p-5">
        <h4 class="font-semibold text-pink-400 mb-2"><i class="fas fa-palette mr-2"></i>Color Picker</h4>
        <p class="text-sm text-purple-200">Click any color circle to apply that color label.</p>
    </div>

    <div class="bg-white/5 rounded-xl p-5">
        <h4 class="font-semibold text-green-400 mb-2"><i class="fas fa-tags mr-2"></i>Tags Section</h4>
        <p class="text-sm text-purple-200">View existing tags, add new ones, or remove tags. Type and press Enter to add.</p>
    </div>

    <div class="bg-white/5 rounded-xl p-5">
        <h4 class="font-semibold text-blue-400 mb-2"><i class="fas fa-sticky-note mr-2"></i>Notes Section</h4>
        <p class="text-sm text-purple-200">Text area for personal notes. Auto-saves as you type.</p>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Action Buttons</h2>
<div class="grid grid-cols-2 gap-4">
    <div class="bg-white/5 rounded-xl p-4">
        <h4 class="font-semibold text-purple-400 mb-2"><i class="fas fa-external-link-alt mr-2"></i>Open in Drive</h4>
        <p class="text-sm text-gray-400">Opens the file in Google Drive</p>
    </div>
    <div class="bg-white/5 rounded-xl p-4">
        <h4 class="font-semibold text-purple-400 mb-2"><i class="fas fa-project-diagram mr-2"></i>Find Related</h4>
        <p class="text-sm text-gray-400">Shows similar files by category/tags</p>
    </div>
    <div class="bg-white/5 rounded-xl p-4">
        <h4 class="font-semibold text-purple-400 mb-2"><i class="fas fa-copy mr-2"></i>Copy Link</h4>
        <p class="text-sm text-gray-400">Copies the Drive link to clipboard</p>
    </div>
    <div class="bg-white/5 rounded-xl p-4">
        <h4 class="font-semibold text-purple-400 mb-2"><i class="fas fa-magic mr-2"></i>Smart Rename</h4>
        <p class="text-sm text-gray-400">AI-suggested file name based on metadata</p>
    </div>
</div>
`,

'analytics': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-chart-pie text-xl"></i>
    </div>
    Analytics Dashboard
</h1>

<p class="text-lg text-purple-300 mb-8">Press <kbd class="bg-purple-600 px-3 py-1 rounded mx-1">A</kbd> to open the comprehensive Analytics Dashboard with 6 detailed tabs.</p>

<h2 class="text-2xl font-bold mb-4 text-white">Tab 1: Overview</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">High-level statistics about your entire knowledge base:</p>
    <div class="grid grid-cols-3 gap-4">
        <div class="bg-black/30 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-400">27,566</div>
            <div class="text-sm text-gray-400">Total Files</div>
        </div>
        <div class="bg-black/30 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-cyan-400">142 GB</div>
            <div class="text-sm text-gray-400">Total Size</div>
        </div>
        <div class="bg-black/30 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-400">9</div>
            <div class="text-sm text-gray-400">Domains</div>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Tab 2: Files</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Charts showing file distribution:</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-chart-pie text-cyan-400 mr-2"></i>Files by Domain (pie chart)</li>
        <li><i class="fas fa-chart-bar text-cyan-400 mr-2"></i>Files by Type (bar chart)</li>
        <li><i class="fas fa-chart-line text-cyan-400 mr-2"></i>Files Over Time (timeline)</li>
    </ul>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Tab 3: Tags</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300">Analysis of your custom tags - most used, tag distribution, tagging trends.</p>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Tab 4: AI Insights</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300">AI-generated insights about your collection patterns and recommendations.</p>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Tab 5: Storage</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Storage analysis and largest files:</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-hdd text-yellow-400 mr-2"></i>Space used by domain</li>
        <li><i class="fas fa-file-alt text-yellow-400 mr-2"></i>Largest files list</li>
        <li><i class="fas fa-chart-pie text-yellow-400 mr-2"></i>Storage by file type</li>
    </ul>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Tab 6: Quality / Health Score</h2>
<div class="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-500/30 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Your Knowledge Base Health Score with breakdown:</p>
    <div class="grid grid-cols-2 gap-4">
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-green-400 mb-2">Organization Score</h4>
            <p class="text-sm text-gray-400">Based on categorization and tagging</p>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-blue-400 mb-2">Duplicate Score</h4>
            <p class="text-sm text-gray-400">Percentage of unique files</p>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-yellow-400 mb-2">Naming Score</h4>
            <p class="text-sm text-gray-400">Quality of file names</p>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-purple-400 mb-2">Recency Score</h4>
            <p class="text-sm text-gray-400">How up-to-date your files are</p>
        </div>
    </div>
</div>
`,

'special-tools': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-magic text-xl"></i>
    </div>
    Special Tools
</h1>

<p class="text-lg text-purple-300 mb-8">Advanced features for power users - duplicates detection, AI rename, research chat, and batch operations.</p>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-clone text-yellow-400 mr-2"></i>Duplicate Detection (D)</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Press <kbd class="bg-purple-600 px-3 py-1 rounded mx-1">D</kbd> to find duplicate files using MD5 hash matching.</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-check text-green-400 mr-2"></i>Exact content matching via MD5 checksums</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Groups duplicates together</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Shows file sizes to identify space waste</li>
    </ul>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-brain text-purple-400 mr-2"></i>Smart Duplicates (AI-Based)</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Uses content similarity analysis to find near-duplicates and related files:</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-check text-green-400 mr-2"></i>Finds similar files even with different names</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Shows similarity percentage</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Based on domain, category, and tags</li>
    </ul>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-magic text-emerald-400 mr-2"></i>Smart Rename (N)</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Press <kbd class="bg-purple-600 px-3 py-1 rounded mx-1">N</kbd> for AI-suggested file names based on metadata:</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-check text-green-400 mr-2"></i>Uses domain, category, tags, and date</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Generates multiple alternatives</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>No external API required - works locally</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Copy suggested name to clipboard</li>
    </ul>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-comments text-blue-400 mr-2"></i>Research Chat (Ctrl+Shift+R)</h2>
<div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-blue-500/30 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">AI-powered research assistant that knows your files:</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-check text-green-400 mr-2"></i>Ask questions about your knowledge base</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Get file recommendations</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Summarize categories</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Powered by Gemini API (optional)</li>
    </ul>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-layer-group text-pink-400 mr-2"></i>Batch Operations (Ctrl+Shift+B)</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Select multiple files and apply actions in bulk:</p>
    <div class="grid grid-cols-2 gap-3">
        <div class="bg-black/30 rounded-lg p-3 text-sm">
            <div class="font-semibold text-green-400">Add Tags</div>
            <div class="text-gray-400">Apply same tag to all selected</div>
        </div>
        <div class="bg-black/30 rounded-lg p-3 text-sm">
            <div class="font-semibold text-pink-400">Set Color</div>
            <div class="text-gray-400">Apply same color label</div>
        </div>
        <div class="bg-black/30 rounded-lg p-3 text-sm">
            <div class="font-semibold text-yellow-400">Set Rating</div>
            <div class="text-gray-400">Apply same star rating</div>
        </div>
        <div class="bg-black/30 rounded-lg p-3 text-sm">
            <div class="font-semibold text-red-400">Set Favorites</div>
            <div class="text-gray-400">Favorite all selected files</div>
        </div>
        <div class="bg-black/30 rounded-lg p-3 text-sm">
            <div class="font-semibold text-cyan-400">Export List</div>
            <div class="text-gray-400">Export selected as CSV/JSON</div>
        </div>
        <div class="bg-black/30 rounded-lg p-3 text-sm">
            <div class="font-semibold text-purple-400">Approve Renames</div>
            <div class="text-gray-400">Batch approve AI suggestions</div>
        </div>
    </div>
</div>
`,

'shortcuts': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-keyboard text-xl"></i>
    </div>
    Keyboard Shortcuts
</h1>

<p class="text-lg text-purple-300 mb-8">Master these shortcuts to navigate your knowledge base at lightning speed.</p>

<h2 class="text-2xl font-bold mb-4 text-white">Navigation & Views</h2>
<div class="grid grid-cols-2 gap-3 mb-8">
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">/</kbd>
        <div><div class="font-semibold">Focus Search</div><div class="text-sm text-gray-400">Jump to search box</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">Esc</kbd>
        <div><div class="font-semibold">Clear/Close</div><div class="text-sm text-gray-400">Clear search or close modal</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">G</kbd>
        <div><div class="font-semibold">Grid View</div><div class="text-sm text-gray-400">Switch to grid layout</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">L</kbd>
        <div><div class="font-semibold">List View</div><div class="text-sm text-gray-400">Switch to list layout</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">K</kbd>
        <div><div class="font-semibold">Kanban View</div><div class="text-sm text-gray-400">Switch to kanban layout</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">P</kbd>
        <div><div class="font-semibold">Dual-Pane</div><div class="text-sm text-gray-400">Switch to split view</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">C</kbd>
        <div><div class="font-semibold">Compact View</div><div class="text-sm text-gray-400">Minimal card layout</div></div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Tools & Features</h2>
<div class="grid grid-cols-2 gap-3 mb-8">
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">A</kbd>
        <div><div class="font-semibold">Analytics</div><div class="text-sm text-gray-400">Open analytics dashboard</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">D</kbd>
        <div><div class="font-semibold">Duplicates</div><div class="text-sm text-gray-400">Find duplicate files</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">R</kbd>
        <div><div class="font-semibold">Recent</div><div class="text-sm text-gray-400">Show recent files</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">?</kbd>
        <div><div class="font-semibold">Help</div><div class="text-sm text-gray-400">Open this manual</div></div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">File Actions (with file selected)</h2>
<div class="grid grid-cols-2 gap-3 mb-8">
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">F</kbd>
        <div><div class="font-semibold">Favorite</div><div class="text-sm text-gray-400">Toggle favorite</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">T</kbd>
        <div><div class="font-semibold">Tags</div><div class="text-sm text-gray-400">Open tags editor</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">N</kbd>
        <div><div class="font-semibold">Smart Rename</div><div class="text-sm text-gray-400">AI rename suggestions</div></div>
    </div>
    <div class="bg-white/5 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-4 py-2 rounded text-lg font-mono">1-5</kbd>
        <div><div class="font-semibold">Rate</div><div class="text-sm text-gray-400">Set star rating</div></div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Combo Shortcuts</h2>
<div class="grid grid-cols-1 gap-3">
    <div class="bg-gradient-to-r from-purple-500/20 to-cyan-500/20 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-3 py-2 rounded font-mono">Ctrl+Z</kbd>
        <div><div class="font-semibold">Undo</div><div class="text-sm text-gray-400">Undo last action (favorites, ratings, colors, tags)</div></div>
    </div>
    <div class="bg-gradient-to-r from-purple-500/20 to-cyan-500/20 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-3 py-2 rounded font-mono">Ctrl+Shift+S</kbd>
        <div><div class="font-semibold">Smart Search</div><div class="text-sm text-gray-400">AI-powered search with relevance scoring</div></div>
    </div>
    <div class="bg-gradient-to-r from-purple-500/20 to-cyan-500/20 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-3 py-2 rounded font-mono">Ctrl+Shift+R</kbd>
        <div><div class="font-semibold">Research Chat</div><div class="text-sm text-gray-400">Open AI research assistant</div></div>
    </div>
    <div class="bg-gradient-to-r from-purple-500/20 to-cyan-500/20 p-4 rounded-xl flex items-center gap-4">
        <kbd class="bg-purple-600 px-3 py-2 rounded font-mono">Ctrl+Shift+B</kbd>
        <div><div class="font-semibold">Batch Select</div><div class="text-sm text-gray-400">Toggle batch selection mode</div></div>
    </div>
</div>
`,

'context-menu': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-red-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-mouse-pointer text-xl"></i>
    </div>
    Context Menu
</h1>

<p class="text-lg text-purple-300 mb-8">Right-click any file card to access the context menu with quick actions.</p>

<h2 class="text-2xl font-bold mb-4 text-white">Available Options</h2>
<div class="space-y-3">
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-eye text-cyan-400 w-8 text-center"></i>
        <div><div class="font-semibold">Preview</div><div class="text-sm text-gray-400">Open the preview modal</div></div>
    </div>
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-heart text-red-400 w-8 text-center"></i>
        <div><div class="font-semibold">Favorite</div><div class="text-sm text-gray-400">Toggle favorite status</div></div>
    </div>
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-tags text-green-400 w-8 text-center"></i>
        <div><div class="font-semibold">Tags</div><div class="text-sm text-gray-400">Open tags editor</div></div>
    </div>
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-external-link-alt text-purple-400 w-8 text-center"></i>
        <div><div class="font-semibold">Open in Drive</div><div class="text-sm text-gray-400">Open file in Google Drive</div></div>
    </div>
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-palette text-pink-400 w-8 text-center"></i>
        <div><div class="font-semibold">Color</div><div class="text-sm text-gray-400">Submenu with 8 color options</div></div>
    </div>
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-star text-yellow-400 w-8 text-center"></i>
        <div><div class="font-semibold">Rating</div><div class="text-sm text-gray-400">Submenu with 1-5 star options</div></div>
    </div>
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-project-diagram text-blue-400 w-8 text-center"></i>
        <div><div class="font-semibold">Find Related</div><div class="text-sm text-gray-400">Show similar files</div></div>
    </div>
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-link text-gray-400 w-8 text-center"></i>
        <div><div class="font-semibold">Copy Link</div><div class="text-sm text-gray-400">Copy Drive link to clipboard</div></div>
    </div>
    <div class="bg-white/5 rounded-xl p-4 flex items-center gap-4">
        <i class="fas fa-magic text-emerald-400 w-8 text-center"></i>
        <div><div class="font-semibold">Smart Rename</div><div class="text-sm text-gray-400">Get AI rename suggestions</div></div>
    </div>
</div>
`,

'workflows': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-route text-xl"></i>
    </div>
    Tips & Workflows
</h1>

<p class="text-lg text-purple-300 mb-8">Real-world workflows and pro tips to get the most out of your knowledge base.</p>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-search text-cyan-400 mr-2"></i>Finding Research Papers</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <ol class="space-y-3 text-purple-200">
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">1</span>Click a domain in sidebar (e.g., Psychiatry)</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">2</span>Expand and click a category (e.g., ADHD)</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">3</span>Filter by PDF in File Types section</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">4</span>Search for specific terms</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">5</span>Heart the best papers for quick access</li>
    </ol>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-layer-group text-green-400 mr-2"></i>Organizing by Priority</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <ol class="space-y-3 text-purple-200">
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">1</span>Press <kbd class="bg-purple-600 px-2 py-1 rounded text-xs">L</kbd> for List view</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">2</span>Click Size header to sort by file size</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">3</span>Rate files: 5&#9733; critical, 4&#9733; important, 3&#9733; useful</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">4</span>Color code: Red=Urgent, Yellow=Review, Green=Done</li>
    </ol>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-folder-plus text-yellow-400 mr-2"></i>Creating Project Collections</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <ol class="space-y-3 text-purple-200">
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">1</span>Search for your topic</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">2</span>Right-click each relevant file, add tag like "project-alpha"</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">3</span>Click your tag in sidebar Tags Cloud to see your collection</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">4</span>Use batch mode (Ctrl+Shift+B) to tag multiple files at once</li>
    </ol>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-broom text-pink-400 mr-2"></i>Cleaning Up Duplicates</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <ol class="space-y-3 text-purple-200">
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">1</span>Press <kbd class="bg-purple-600 px-2 py-1 rounded text-xs">D</kbd> to open Duplicates modal</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">2</span>Review duplicate groups</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">3</span>Mark the preferred version with a star or color</li>
        <li class="flex gap-3"><span class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-sm shrink-0">4</span>Use Smart Duplicates for similar (not exact) files</li>
    </ol>
</div>

<div class="bg-amber-500/20 border border-amber-500/30 rounded-xl p-5">
    <h4 class="font-bold text-amber-300 mb-3"><i class="fas fa-lightbulb mr-2"></i>Pro Tips</h4>
    <ul class="space-y-2 text-purple-200 text-sm">
        <li><i class="fas fa-arrow-right text-amber-400 mr-2"></i>Combine filters: Domain + Category + File Type for precise results</li>
        <li><i class="fas fa-arrow-right text-amber-400 mr-2"></i>Use Virtual Folders (by color/rating) to find your organized files quickly</li>
        <li><i class="fas fa-arrow-right text-amber-400 mr-2"></i>Check Analytics weekly to monitor your knowledge base health</li>
        <li><i class="fas fa-arrow-right text-amber-400 mr-2"></i>Use Research Chat to ask questions about your file collection</li>
    </ul>
</div>
`,

'data': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-database text-xl"></i>
    </div>
    Data & Persistence
</h1>

<p class="text-lg text-purple-300 mb-8">Understanding how your data is stored, saved, and protected.</p>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-hdd text-cyan-400 mr-2"></i>Local Storage</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">All your personalization data is stored in your browser's localStorage:</p>
    <div class="bg-black/30 rounded-lg p-4 font-mono text-sm mb-4">
        <div class="text-gray-400">localStorage keys:</div>
        <div class="text-cyan-400 ml-4"> userPrefs (favorites, ratings, colors, notes, tags)</div>
        <div class="text-cyan-400 ml-4"> viewMode (grid, list, kanban, etc.)</div>
        <div class="text-cyan-400 ml-4"> searchHistory</div>
        <div class="text-cyan-400 ml-4"> lastLoadedFile</div>
    </div>
    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
        <h4 class="font-semibold text-green-400 mb-2"><i class="fas fa-shield-alt mr-2"></i>Privacy Note</h4>
        <p class="text-sm text-purple-200">All data stays in YOUR browser. Nothing is sent to external servers. Your preferences are completely private.</p>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-save text-green-400 mr-2"></i>What Gets Saved</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="grid grid-cols-2 gap-4">
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-purple-400 mb-2">Saved Automatically</h4>
            <ul class="space-y-1 text-sm text-gray-400">
                <li>&#10003; Favorites</li>
                <li>&#10003; Star ratings</li>
                <li>&#10003; Color labels</li>
                <li>&#10003; Custom tags</li>
                <li>&#10003; Personal notes</li>
                <li>&#10003; View mode preference</li>
            </ul>
        </div>
        <div class="bg-black/30 rounded-lg p-4">
            <h4 class="font-semibold text-yellow-400 mb-2">NOT Saved</h4>
            <ul class="space-y-1 text-sm text-gray-400">
                <li>&#10007; Current search query</li>
                <li>&#10007; Sidebar filters</li>
                <li>&#10007; Modal states</li>
                <li>&#10007; Sort order</li>
            </ul>
        </div>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-file-export text-yellow-400 mr-2"></i>Exporting Data</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">Use Batch Operations to export your data:</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-check text-green-400 mr-2"></i>Export selected files as CSV</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Export selected files as JSON</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Includes all personalization data</li>
    </ul>
</div>

<h2 class="text-2xl font-bold mb-4 text-white"><i class="fas fa-undo text-blue-400 mr-2"></i>Undo System</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <p class="text-purple-300 mb-4">The dashboard maintains an undo stack for recent actions:</p>
    <ul class="space-y-2 text-sm text-purple-200">
        <li><i class="fas fa-arrow-right text-cyan-400 mr-2"></i>Press Ctrl+Z to undo</li>
        <li><i class="fas fa-arrow-right text-cyan-400 mr-2"></i>Undo bar appears at bottom with 5-second timer</li>
        <li><i class="fas fa-arrow-right text-cyan-400 mr-2"></i>Works for: favorites, ratings, colors, tags</li>
    </ul>
</div>
`,

'troubleshooting': `
<h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
    <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-wrench text-xl"></i>
    </div>
    Troubleshooting
</h1>

<p class="text-lg text-purple-300 mb-8">Common issues and how to resolve them.</p>

<h2 class="text-2xl font-bold mb-4 text-white">File Won't Load</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-4">
        <h4 class="font-semibold text-red-400 mb-2">Problem: JSON file fails to load</h4>
    </div>
    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
        <h4 class="font-semibold text-green-400 mb-2">Solutions:</h4>
        <ul class="space-y-2 text-sm text-purple-200">
            <li>1. Make sure you're selecting knowledge_base.json (not another JSON file)</li>
            <li>2. Check that the file isn't corrupted - try opening it in a text editor</li>
            <li>3. Ensure the file is in the correct format from the Python script</li>
            <li>4. Try refreshing the browser and loading again</li>
        </ul>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Search Not Working</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-4">
        <h4 class="font-semibold text-red-400 mb-2">Problem: Search returns no results</h4>
    </div>
    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
        <h4 class="font-semibold text-green-400 mb-2">Solutions:</h4>
        <ul class="space-y-2 text-sm text-purple-200">
            <li>1. Check if Case Sensitive is accidentally enabled</li>
            <li>2. Try simpler search terms</li>
            <li>3. Make sure Regex mode is off unless you're using regex</li>
            <li>4. Clear all sidebar filters first (press Esc)</li>
        </ul>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Personalization Not Saving</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-4">
        <h4 class="font-semibold text-red-400 mb-2">Problem: Ratings/colors/tags disappear after refresh</h4>
    </div>
    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
        <h4 class="font-semibold text-green-400 mb-2">Solutions:</h4>
        <ul class="space-y-2 text-sm text-purple-200">
            <li>1. Check if your browser is in Private/Incognito mode (localStorage disabled)</li>
            <li>2. Check if localStorage is full (clear old browser data)</li>
            <li>3. Make sure cookies/site data isn't being auto-cleared</li>
            <li>4. Try a different browser to test</li>
        </ul>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Slow Performance</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-4">
        <h4 class="font-semibold text-red-400 mb-2">Problem: Dashboard feels slow with many files</h4>
    </div>
    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
        <h4 class="font-semibold text-green-400 mb-2">Solutions:</h4>
        <ul class="space-y-2 text-sm text-purple-200">
            <li>1. Use Compact view for faster rendering</li>
            <li>2. Apply filters to reduce visible files</li>
            <li>3. Close other browser tabs</li>
            <li>4. Use List view instead of Grid for large sets</li>
        </ul>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-white">Keyboard Shortcuts Not Working</h2>
<div class="bg-white/5 rounded-xl p-5 mb-6">
    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
        <h4 class="font-semibold text-green-400 mb-2">Solutions:</h4>
        <ul class="space-y-2 text-sm text-purple-200">
            <li>1. Click somewhere in the main content area first (not in a text input)</li>
            <li>2. Close any open modals</li>
            <li>3. Make sure browser extensions aren't capturing the shortcut</li>
        </ul>
    </div>
</div>

<div class="bg-blue-500/20 border border-blue-500/30 rounded-xl p-5 mt-8">
    <h4 class="font-bold text-blue-400 mb-2"><i class="fas fa-question-circle mr-2"></i>Still Having Issues?</h4>
    <p class="text-purple-200">Try refreshing the page (Ctrl+Shift+R for hard refresh) or clearing your browser cache. Most issues are resolved by a fresh page load.</p>
</div>
`
            };
            return c[section] || c['welcome'];
        }

        // ==========================================
        // AI FILE RENAMER FUNCTIONS
        // ==========================================
        let aiSuggestions = {};
        let aiSuggestionsLoaded = false;

        function showGenerateSummariesInfo() {
            document.getElementById('generateSummariesModal').classList.remove('hidden');
        }

        function closeGenerateSummariesInfo() {
            document.getElementById('generateSummariesModal').classList.add('hidden');
        }

        function showAIRenamer() {
            document.getElementById('aiRenamerModal').classList.remove('hidden');
            if (!aiSuggestionsLoaded) {
                loadAISuggestions();
            }
        }

        function closeAIRenamer() {
            document.getElementById('aiRenamerModal').classList.add('hidden');
        }

        // ========== LOCAL AI RENAME (Metadata-based, no API) ==========
        let currentLocalAIRenameFile = null;
        let localAIAlternativesCache = [];

        function openLocalAIRename(fileId) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) {
                toast('File not found', 'error');
                return;
            }

            currentLocalAIRenameFile = file;

            // Show current name
            document.getElementById('localAICurrentName').textContent = file.name || 'Unnamed';

            // Show what we're basing the suggestion on
            const basedOnEl = document.getElementById('localAIBasedOn');
            let basedOnHTML = '';
            if (file.domain) basedOnHTML += '<span class="inline-block bg-purple-600/30 text-purple-300 px-2 py-1 rounded mr-1 mb-1">Domain: ' + file.domain + '</span>';
            if (file.category) basedOnHTML += '<span class="inline-block bg-blue-600/30 text-blue-300 px-2 py-1 rounded mr-1 mb-1">Category: ' + file.category + '</span>';
            if (file.subcategory) basedOnHTML += '<span class="inline-block bg-cyan-600/30 text-cyan-300 px-2 py-1 rounded mr-1 mb-1">Subcategory: ' + file.subcategory + '</span>';
            if (file.tags && file.tags.length > 0) {
                file.tags.slice(0, 3).forEach(function(tag) {
                    if (tag && tag !== 'uncategorized') {
                        basedOnHTML += '<span class="inline-block bg-yellow-600/30 text-yellow-300 px-2 py-1 rounded mr-1 mb-1">Tag: ' + tag + '</span>';
                    }
                });
            }
            if (file.modifiedTime) {
                const year = new Date(file.modifiedTime).getFullYear();
                basedOnHTML += '<span class="inline-block bg-gray-600/30 text-gray-300 px-2 py-1 rounded mr-1 mb-1">Year: ' + year + '</span>';
            }
            if (file.mime_type) {
                const fileType = getFileTypeLabel(file.mime_type);
                basedOnHTML += '<span class="inline-block bg-green-600/30 text-green-300 px-2 py-1 rounded mr-1 mb-1">Type: ' + fileType + '</span>';
            }
            basedOnEl.innerHTML = basedOnHTML || '<span class="text-gray-500">No metadata available - suggestion will be based on original filename</span>';

            // Generate suggestion
            const suggestion = generateLocalAIFilename(file);
            document.getElementById('localAISuggestion').value = suggestion;

            // Generate alternatives
            localAIAlternativesCache = generateLocalAIAlternatives(file);
            renderLocalAIAlternatives();

            // Show modal
            document.getElementById('localAIRenameModal').classList.remove('hidden');
        }

        function closeLocalAIRename() {
            document.getElementById('localAIRenameModal').classList.add('hidden');
            currentLocalAIRenameFile = null;
        }

        function getFileTypeLabel(mimeType) {
            if (!mimeType) return 'File';
            if (mimeType.includes('pdf')) return 'PDF';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'Document';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'Spreadsheet';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return 'Presentation';
            if (mimeType.includes('image')) return 'Image';
            if (mimeType.includes('video')) return 'Video';
            if (mimeType.includes('audio')) return 'Audio';
            if (mimeType.includes('text')) return 'Text';
            return 'File';
        }

        function cleanForLocalAIFilename(str) {
            if (!str) return '';
            return str
                .replace(/[^a-zA-Z0-9\s-]/g, '')  // Remove special chars except hyphens
                .replace(/\s+/g, '_')              // Spaces to underscores
                .replace(/_+/g, '_')               // Multiple underscores to single
                .replace(/^_|_$/g, '')             // Remove leading/trailing underscores
                .substring(0, 30);                 // Limit length
        }

        function generateLocalAIFilename(file) {
            const parts = [];
            const extension = file.name && file.name.includes('.') ? '.' + file.name.split('.').pop().toLowerCase() : '';

            // Strategy: Domain > Category/Subcategory > Tag > Year
            if (file.domain) {
                parts.push(cleanForLocalAIFilename(file.domain));
            } else if (file.category) {
                parts.push(cleanForLocalAIFilename(file.category));
            }

            // Add subcategory or first meaningful tag
            if (file.subcategory) {
                parts.push(cleanForLocalAIFilename(file.subcategory));
            } else if (file.tags && file.tags.length > 0) {
                const meaningfulTag = file.tags.find(function(t) { return t && t !== 'uncategorized' && t.length > 2; });
                if (meaningfulTag) {
                    parts.push(cleanForLocalAIFilename(meaningfulTag));
                }
            }

            // Add another tag if available and we don't have subcategory
            if (!file.subcategory && file.tags && file.tags.length > 1) {
                const secondTag = file.tags.slice(1).find(function(t) { return t && t !== 'uncategorized' && t.length > 2; });
                if (secondTag) {
                    parts.push(cleanForLocalAIFilename(secondTag));
                }
            }

            // Add year
            if (file.modifiedTime) {
                parts.push(new Date(file.modifiedTime).getFullYear());
            }

            // If we have nothing useful, clean up the original name
            if (parts.length === 0) {
                const cleanOriginal = file.name
                    .replace(/\.[^/.]+$/, '')  // Remove extension
                    .replace(/[^a-zA-Z0-9]/g, '_')
                    .replace(/_+/g, '_')
                    .replace(/^_|_$/g, '')
                    .substring(0, 40);
                return (cleanOriginal || 'Unnamed_File') + extension;
            }

            // Combine parts, ensuring reasonable length
            let result = parts.join('_');
            if (result.length > 50) {
                result = result.substring(0, 50).replace(/_$/, '');
            }

            return result + extension;
        }

        function generateLocalAIAlternatives(file) {
            const alternatives = [];
            const extension = file.name && file.name.includes('.') ? '.' + file.name.split('.').pop().toLowerCase() : '';
            const year = file.modifiedTime ? new Date(file.modifiedTime).getFullYear() : '';

            // Alternative 1: Category_Domain_Year
            if (file.category && file.domain && file.category !== file.domain) {
                const alt = cleanForLocalAIFilename(file.category) + '_' + cleanForLocalAIFilename(file.domain) + (year ? '_' + year : '') + extension;
                if (alt.length > 5) alternatives.push(alt);
            }

            // Alternative 2: Domain_AllTags
            if (file.domain && file.tags && file.tags.length > 0) {
                const tagPart = file.tags
                    .filter(function(t) { return t && t !== 'uncategorized'; })
                    .slice(0, 3)
                    .map(function(t) { return cleanForLocalAIFilename(t); })
                    .join('_');
                if (tagPart) {
                    const alt = cleanForLocalAIFilename(file.domain) + '_' + tagPart + extension;
                    if (alt.length > 5) alternatives.push(alt);
                }
            }

            // Alternative 3: Verbose - Domain_Category_Subcategory_Year
            if (file.domain) {
                let verbose = cleanForLocalAIFilename(file.domain);
                if (file.category && file.category !== file.domain) verbose += '_' + cleanForLocalAIFilename(file.category);
                if (file.subcategory) verbose += '_' + cleanForLocalAIFilename(file.subcategory);
                if (year) verbose += '_' + year;
                if (verbose.length > 5 && verbose.length < 60) alternatives.push(verbose + extension);
            }

            // Alternative 4: Short with random suffix - Domain_XXXX
            if (file.domain || file.category) {
                const base = cleanForLocalAIFilename(file.domain || file.category);
                const randomNum = Math.floor(Math.random() * 9000) + 1000;
                alternatives.push(base + '_' + randomNum + extension);
            }

            // Alternative 5: Type_Domain_Year (e.g., PDF_Psychiatry_2023)
            if (file.mime_type && (file.domain || file.category)) {
                const fileType = getFileTypeLabel(file.mime_type);
                const base = cleanForLocalAIFilename(file.domain || file.category);
                const alt = fileType + '_' + base + (year ? '_' + year : '') + extension;
                if (alt.length > 5) alternatives.push(alt);
            }

            // Remove duplicates and the primary suggestion
            const primarySuggestion = document.getElementById('localAISuggestion')?.value || '';
            return [...new Set(alternatives)]
                .filter(function(a) { return a && a !== extension && a !== primarySuggestion && a.length > 5; })
                .slice(0, 5);
        }

        function renderLocalAIAlternatives() {
            const altEl = document.getElementById('localAIAlternatives');
            if (localAIAlternativesCache.length === 0) {
                altEl.innerHTML = '<div class="text-gray-500 text-xs py-2">No alternative suggestions available</div>';
                return;
            }
            altEl.innerHTML = localAIAlternativesCache.map(function(alt) {
                const escapedAlt = alt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return '<div class="bg-black/20 border border-white/10 rounded px-3 py-2 text-sm text-gray-300 font-mono cursor-pointer hover:bg-yellow-600/20 hover:border-yellow-500/30 transition truncate" onclick="selectLocalAIAlternative(\'' + escapedAlt + '\')" title="Click to use: ' + escapedAlt + '">' + alt + '</div>';
            }).join('');
        }

        function selectLocalAIAlternative(alt) {
            document.getElementById('localAISuggestion').value = alt;
        }

        function regenerateLocalAISuggestion() {
            if (!currentLocalAIRenameFile) return;

            // Regenerate alternatives with shuffled order
            localAIAlternativesCache = generateLocalAIAlternatives(currentLocalAIRenameFile);

            // Pick a random alternative or regenerate primary
            if (localAIAlternativesCache.length > 0) {
                const randomIndex = Math.floor(Math.random() * localAIAlternativesCache.length);
                document.getElementById('localAISuggestion').value = localAIAlternativesCache[randomIndex];
                // Re-render alternatives without the selected one
                localAIAlternativesCache.splice(randomIndex, 1);
                // Add original suggestion back as alternative
                const newSuggestion = generateLocalAIFilename(currentLocalAIRenameFile);
                if (!localAIAlternativesCache.includes(newSuggestion)) {
                    localAIAlternativesCache.unshift(newSuggestion);
                }
                renderLocalAIAlternatives();
            }

            toast('Regenerated suggestion', 'info');
        }

        function copyLocalAIRename() {
            const suggestion = document.getElementById('localAISuggestion').value;
            if (!suggestion) {
                toast('No filename to copy', 'error');
                return;
            }

            navigator.clipboard.writeText(suggestion).then(function() {
                toast('Filename copied: ' + suggestion, 'success');
                closeLocalAIRename();
            }).catch(function() {
                // Fallback for older browsers
                const input = document.getElementById('localAISuggestion');
                input.select();
                document.execCommand('copy');
                toast('Filename copied: ' + suggestion, 'success');
                closeLocalAIRename();
            });
        }

        // Helper to open local AI rename from preview modal
        function openLocalAIRenameFromPreview() {
            if (!currentPreviewFile) {
                toast('No file selected', 'error');
                return;
            }
            openLocalAIRename(currentPreviewFile.id);
        }
        // ========== END LOCAL AI RENAME ==========

        function loadAISuggestions() {
            // Try to load from a file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        aiSuggestions = JSON.parse(evt.target.result);
                        aiSuggestionsLoaded = true;
                        updateAIStats();
                        filterAISuggestions();
                        // Automatically merge AI data with loaded files
                        if (allFiles.length > 0) {
                            applyAIDataToFiles();
                        }
                        toast('Loaded ' + Object.keys(aiSuggestions).length + ' AI suggestions', 'success');
                    } catch (err) {
                        toast('Error loading file: ' + err.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function updateAIStats() {
            let pending = 0, approved = 0, skipped = 0, withSummary = 0;
            const totalSuggestions = Object.keys(aiSuggestions).length;
            Object.values(aiSuggestions).forEach(s => {
                if (s.status === 'pending') pending++;
                else if (s.status === 'approved') approved++;
                else if (s.status === 'skipped') skipped++;
                if (s.summary && s.summary.trim() !== '' && s.summary !== 'No summary available') withSummary++;
            });
            document.getElementById('aiPendingCount').textContent = pending;
            document.getElementById('aiApprovedCount').textContent = approved;
            document.getElementById('aiSkippedCount').textContent = skipped;
            document.getElementById('aiRenamerCount').textContent = pending;
            // Update summary progress
            document.getElementById('aiSummaryStats').textContent = withSummary + ' of ' + totalSuggestions;
            const progressPercent = totalSuggestions > 0 ? Math.round((withSummary / totalSuggestions) * 100) : 0;
            document.getElementById('aiSummaryProgress').style.width = progressPercent + '%';
        }

        function filterAISuggestions() {
            const filter = document.getElementById('aiFilterStatus').value;
            const container = document.getElementById('aiSuggestionsList');

            const filtered = Object.entries(aiSuggestions).filter(([id, s]) => {
                if (filter === 'all') return true;
                return s.status === filter;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-purple-300"><i class="fas fa-check-circle text-6xl mb-4 text-green-400/50"></i><p>No ' + filter + ' suggestions.</p></div>';
                return;
            }

            container.innerHTML = filtered.map(([id, s]) => {
                const confidenceColor = s.confidence > 0.9 ? 'text-green-400' : s.confidence > 0.7 ? 'text-yellow-400' : 'text-orange-400';
                const statusBadge = s.status === 'approved' ? '<span class="px-2 py-1 bg-green-600 rounded-full text-xs">Approved</span>' :
                                   s.status === 'skipped' ? '<span class="px-2 py-1 bg-gray-600 rounded-full text-xs">Skipped</span>' : '';
                const summaryText = s.summary || 'No summary available';
                const isLongSummary = summaryText.length > 150;
                const summaryId = 'summary-' + id.replace(/[^a-zA-Z0-9]/g, '-');
                return '<div class="bg-white/5 rounded-xl p-4 mb-3 border border-white/10 hover:border-emerald-500/50 transition-all">' +
                    '<div class="flex items-start gap-4">' +
                        '<div class="flex-1">' +
                            '<div class="flex items-center gap-2 mb-2">' +
                                '<span class="text-xs bg-purple-600/50 px-2 py-1 rounded">' + (s.file_category || 'Unknown') + '</span>' +
                                '<span class="' + confidenceColor + ' text-xs">' + Math.round((s.confidence || 0) * 100) + '% confident</span>' +
                                (s.summary ? '<span class="px-2 py-1 bg-purple-500/30 rounded-full text-xs text-purple-300"><i class="fas fa-file-alt mr-1"></i>Has Summary</span>' : '') +
                                statusBadge +
                            '</div>' +
                            '<div class="mb-2">' +
                                '<div class="text-xs text-gray-400 mb-1">Original:</div>' +
                                '<div class="text-red-300 line-through text-sm">' + (s.original_name || 'Unknown') + '</div>' +
                            '</div>' +
                            '<div class="mb-2">' +
                                '<div class="text-xs text-gray-400 mb-1">Suggested:</div>' +
                                '<div class="text-emerald-300 font-medium">' + (s.suggested_name || 'Unknown') + '</div>' +
                            '</div>' +
                            '<div class="mb-2">' +
                                '<div class="text-xs text-gray-400 mb-1">Summary:</div>' +
                                '<div id="' + summaryId + '" class="text-sm text-purple-200" style="font-size: 0.85rem; color: #a5b4fc; line-height: 1.4;">' +
                                    (isLongSummary ? '<span class="summary-collapsed">' + summaryText.substring(0, 150) + '... <button onclick="toggleSummary(\'' + summaryId + '\')" class="text-purple-400 hover:text-purple-300 underline text-xs">Show more</button></span><span class="summary-expanded hidden">' + summaryText + ' <button onclick="toggleSummary(\'' + summaryId + '\')" class="text-purple-400 hover:text-purple-300 underline text-xs">Show less</button></span>' : summaryText) +
                                '</div>' +
                            '</div>' +
                            '<div class="flex flex-wrap gap-1">' +
                                ((s.tags || []).map(t => '<span class="px-2 py-1 bg-cyan-600/30 rounded-full text-xs">' + t + '</span>').join('')) +
                            '</div>' +
                        '</div>' +
                        '<div class="flex flex-col gap-2">' +
                            (s.status === 'pending' ?
                                '<button onclick="approveAISuggestion(\'' + id + '\')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm whitespace-nowrap"><i class="fas fa-check mr-1"></i> Approve</button>' +
                                '<button onclick="skipAISuggestion(\'' + id + '\')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm whitespace-nowrap"><i class="fas fa-forward mr-1"></i> Skip</button>'
                            : '<button onclick="resetAISuggestion(\'' + id + '\')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm whitespace-nowrap"><i class="fas fa-undo mr-1"></i> Reset</button>') +
                            (s.file_link ? '<a href="' + s.file_link + '" target="_blank" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm text-center whitespace-nowrap"><i class="fas fa-external-link-alt mr-1"></i> View</a>' : '') +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function toggleSummary(summaryId) {
            const el = document.getElementById(summaryId);
            if (!el) return;
            const collapsed = el.querySelector('.summary-collapsed');
            const expanded = el.querySelector('.summary-expanded');
            if (collapsed && expanded) {
                collapsed.classList.toggle('hidden');
                expanded.classList.toggle('hidden');
            }
        }

        function approveAISuggestion(id) {
            if (aiSuggestions[id]) {
                aiSuggestions[id].status = 'approved';
                updateAIStats();
                filterAISuggestions();
                toast('Rename approved!', 'success');
            }
        }

        function skipAISuggestion(id) {
            if (aiSuggestions[id]) {
                aiSuggestions[id].status = 'skipped';
                updateAIStats();
                filterAISuggestions();
                toast('Suggestion skipped', 'info');
            }
        }

        function resetAISuggestion(id) {
            if (aiSuggestions[id]) {
                aiSuggestions[id].status = 'pending';
                updateAIStats();
                filterAISuggestions();
                toast('Reset to pending', 'info');
            }
        }

        function approveAllPending() {
            let count = 0;
            Object.entries(aiSuggestions).forEach(([id, s]) => {
                if (s.status === 'pending') {
                    s.status = 'approved';
                    count++;
                }
            });
            updateAIStats();
            filterAISuggestions();
            toast('Approved ' + count + ' suggestions', 'success');
        }

        function exportApprovedRenames() {
            const approved = {};
            Object.entries(aiSuggestions).forEach(([id, s]) => {
                if (s.status === 'approved') {
                    approved[id] = {
                        original_name: s.original_name,
                        new_name: s.suggested_name,
                        summary: s.summary,
                        tags: s.tags,
                        file_link: s.file_link
                    };
                }
            });
            const count = Object.keys(approved).length;
            if (count === 0) {
                toast('No approved renames to export', 'info');
                return;
            }
            const blob = new Blob([JSON.stringify(approved, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'approved_renames_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            toast('Exported ' + count + ' approved renames', 'success');
        }

        // Merge AI suggestions data into files
        function mergeAIData(files, aiData) {
            // Creates a merged dataset combining knowledge_base files with AI suggestions
            // aiData is the ai_suggestions.json content (keyed by file ID)
            return files.map(file => {
                const ai = aiData[file.id];
                if (ai) {
                    return {
                        ...file,
                        _aiData: ai,
                        _summary: ai.summary || '',
                        _suggestedName: ai.suggested_name || '',
                        _aiTags: ai.tags || [],
                        _aiConfidence: ai.confidence || 0,
                        _hasSummary: !!(ai.summary && ai.summary.trim() !== '')
                    };
                }
                return file;
            });
        }

        // Apply AI data to currently loaded files
        function applyAIDataToFiles() {
            if (!aiSuggestionsLoaded || Object.keys(aiSuggestions).length === 0) return;
            allFiles = mergeAIData(allFiles, aiSuggestions);
            filteredFiles = mergeAIData(filteredFiles, aiSuggestions);
            displayedCount = 0;
            displayFiles();
            toast('AI data merged with ' + Object.keys(aiSuggestions).length + ' files', 'success');
            // Initialize smart duplicate count after AI data is merged
            initSmartDuplicateCount();
        }

        // =============================================
        // RESEARCH ASSISTANT CHAT FUNCTIONALITY
        // =============================================

        let chatHistory = [];
        let isProcessingChat = false;

        // Open chat modal
        function openResearchChat() {
            document.getElementById('researchChatModal').style.display = 'flex';
            document.getElementById('chatInput').focus();
        }

        // Close chat modal
        function closeResearchChat() {
            document.getElementById('researchChatModal').style.display = 'none';
        }

        // Clear chat history
        function clearChatHistory() {
            chatHistory = [];
            const messagesContainer = document.getElementById('chatMessages');

            // Keep only the welcome message
            messagesContainer.innerHTML = `
                <div class="chat-message assistant">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            <p>Chat cleared. How can I help you explore your documents?</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Handle keyboard input
        function handleChatKeydown(event) {
            // Auto-resize textarea
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

            // Send on Enter (without Shift)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Send chat message
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || isProcessingChat) return;

            isProcessingChat = true;
            document.getElementById('chatSendBtn').disabled = true;

            // Add user message to chat
            addMessageToChat('user', message);
            input.value = '';
            input.style.height = 'auto';

            // Add to history
            chatHistory.push({ role: 'user', content: message });

            // Show typing indicator
            showTypingIndicator();

            try {
                // Step 1: Search for relevant files
                const relevantFiles = searchFilesForChat(message);

                // Step 2: Build context from relevant files
                const context = buildContextFromFiles(relevantFiles);

                // Step 3: Generate response (either local or via Gemini API)
                const response = await generateChatResponse(message, context, relevantFiles);

                // Step 4: Add assistant message to chat
                hideTypingIndicator();
                addMessageToChat('assistant', response.text, response.referencedFiles);

                // Add to history
                chatHistory.push({ role: 'assistant', content: response.text });

            } catch (error) {
                console.error('Chat error:', error);
                hideTypingIndicator();
                addMessageToChat('assistant', 'I encountered an error processing your question. Please try again.');
            }

            isProcessingChat = false;
            document.getElementById('chatSendBtn').disabled = false;
        }

        // Search files for chat query
        function searchFilesForChat(query) {
            // Reuse the smart search logic
            const queryLower = query.toLowerCase();
            const queryWords = queryLower.split(/\s+/).filter(w => w.length > 2);

            // Remove question words
            const questionWords = ['what', 'where', 'when', 'which', 'who', 'how', 'does', 'have', 'find', 'show', 'tell', 'about', 'papers', 'documents', 'files', 'research', 'summarize', 'give', 'list'];
            const meaningfulWords = queryWords.filter(w => !questionWords.includes(w));

            if (meaningfulWords.length === 0) {
                return [];
            }

            const scored = allFiles.map(file => {
                let score = 0;

                // Get AI data from merged properties
                const summary = file._summary || file.ai_summary || file.summary || '';
                const tags = file._aiTags || file.ai_tags || file.tags || [];

                // Check summary
                if (summary) {
                    const summaryLower = summary.toLowerCase();
                    meaningfulWords.forEach(word => {
                        if (summaryLower.includes(word)) {
                            score += 10;
                        }
                    });
                }

                // Check tags
                if (tags && tags.length > 0) {
                    tags.forEach(tag => {
                        const tagLower = tag.toLowerCase();
                        meaningfulWords.forEach(word => {
                            if (tagLower.includes(word) || word.includes(tagLower)) {
                                score += 15; // Tags are very relevant
                            }
                        });
                    });
                }

                // Check filename
                const nameLower = (file.name || '').toLowerCase();
                meaningfulWords.forEach(word => {
                    if (nameLower.includes(word)) {
                        score += 5;
                    }
                });

                return { ...file, relevanceScore: score };
            });

            // Filter and sort by relevance
            return scored
                .filter(file => file.relevanceScore > 0)
                .sort((a, b) => b.relevanceScore - a.relevanceScore)
                .slice(0, 10); // Top 10 most relevant files
        }

        // Build context from files
        function buildContextFromFiles(files) {
            if (files.length === 0) {
                return "No relevant documents found in the knowledge base.";
            }

            let context = `Found ${files.length} relevant documents:\n\n`;

            files.forEach((file, index) => {
                const summary = file._summary || file.ai_summary || file.summary || '';
                const tags = file._aiTags || file.ai_tags || file.tags || [];
                const displayName = file._suggestedName || file.ai_suggested_name || file.name || 'Unknown';

                context += `Document ${index + 1}: "${displayName}"\n`;
                if (summary) {
                    context += `Summary: ${summary}\n`;
                }
                if (tags && tags.length > 0) {
                    context += `Tags: ${tags.join(', ')}\n`;
                }
                context += `\n`;
            });

            return context;
        }

        // Generate chat response
        async function generateChatResponse(userMessage, context, relevantFiles) {
            // Check if Gemini API key is available
            const apiKey = localStorage.getItem('gemini_api_key');

            if (apiKey) {
                // Use Gemini API for intelligent response
                return await generateGeminiResponse(userMessage, context, relevantFiles, apiKey);
            } else {
                // Fall back to local response
                return generateLocalResponse(userMessage, relevantFiles);
            }
        }

        // Generate response using Gemini API
        async function generateGeminiResponse(userMessage, context, relevantFiles, apiKey) {
            const prompt = `You are a helpful research assistant for a psychiatrist. You have access to summaries of their document collection.

Based on the following relevant documents from their knowledge base, answer their question. Be concise, helpful, and reference specific documents when appropriate.

USER QUESTION: ${userMessage}

RELEVANT DOCUMENTS:
${context}

INSTRUCTIONS:
- Provide a helpful, concise answer based on the documents found
- If relevant, mention specific document names
- If no relevant documents were found, say so helpfully
- Keep your response conversational and under 200 words
- Don't make up information not in the documents`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 500,
                            temperature: 0.7
                        }
                    })
                });

                const data = await response.json();

                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const text = data.candidates[0].content.parts[0].text;
                    return {
                        text: text,
                        referencedFiles: relevantFiles.slice(0, 5)
                    };
                } else {
                    throw new Error('Invalid API response');
                }

            } catch (error) {
                console.error('Gemini API error:', error);
                // Fall back to local response
                return generateLocalResponse(userMessage, relevantFiles);
            }
        }

        // Generate local response (no API)
        function generateLocalResponse(userMessage, relevantFiles) {
            if (relevantFiles.length === 0) {
                return {
                    text: "I couldn't find any documents matching your query. Try using different keywords, or make sure your files have been analyzed by the AI system.",
                    referencedFiles: []
                };
            }

            let response = `I found ${relevantFiles.length} document${relevantFiles.length > 1 ? 's' : ''} that may be relevant:\n\n`;

            relevantFiles.slice(0, 5).forEach((file, index) => {
                const displayName = file._suggestedName || file.ai_suggested_name || file.name || 'Unknown';
                const summary = file._summary || file.ai_summary || file.summary || '';

                response += `**${index + 1}. ${displayName}**\n`;
                if (summary) {
                    response += `${summary}\n\n`;
                }
            });

            if (relevantFiles.length > 5) {
                response += `\n...and ${relevantFiles.length - 5} more documents.`;
            }

            response += `\n\n*Note: For more intelligent responses, add your Gemini API key in Settings (gear icon).*`;

            return {
                text: response,
                referencedFiles: relevantFiles.slice(0, 5)
            };
        }

        // Get file icon for chat
        function getFileIconForChat(file) {
            const ext = (file.name || '').split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word', 'docx': 'fa-file-word',
                'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
                'jpg': 'fa-file-image', 'jpeg': 'fa-file-image', 'png': 'fa-file-image', 'gif': 'fa-file-image',
                'mp4': 'fa-file-video', 'mov': 'fa-file-video', 'avi': 'fa-file-video',
                'mp3': 'fa-file-audio', 'wav': 'fa-file-audio',
                'zip': 'fa-file-archive', 'rar': 'fa-file-archive',
                'txt': 'fa-file-alt',
                'html': 'fa-file-code', 'css': 'fa-file-code', 'js': 'fa-file-code'
            };
            return icons[ext] || 'fa-file';
        }

        // Add message to chat UI
        function addMessageToChat(role, text, referencedFiles = []) {
            const messagesContainer = document.getElementById('chatMessages');

            const avatarIcon = role === 'user' ? 'fa-user' : 'fa-robot';

            // Format text (convert markdown-like bold to HTML)
            const formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            let referencedFilesHTML = '';
            if (referencedFiles && referencedFiles.length > 0) {
                referencedFilesHTML = `
                    <div class="referenced-files">
                        <div class="referenced-files-header">
                            <i class="fas fa-file-alt"></i>
                            Referenced Documents (${referencedFiles.length})
                        </div>
                        ${referencedFiles.map(file => {
                            const escapedPath = (file.path || file.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                            const displayName = file._suggestedName || file.ai_suggested_name || file.name || 'Unknown';
                            const icon = getFileIconForChat(file);
                            return `
                                <div class="referenced-file" onclick="openFileFromChat('${escapedPath}')">
                                    <i class="fas ${icon} referenced-file-icon"></i>
                                    <span class="referenced-file-name">${displayName}</span>
                                    ${file.relevanceScore ? `<span class="referenced-file-similarity">${Math.min(100, file.relevanceScore)}% match</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            const messageHTML = `
                <div class="chat-message ${role}">
                    <div class="message-avatar">
                        <i class="fas ${avatarIcon}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            ${formattedText}
                        </div>
                        ${referencedFilesHTML}
                    </div>
                </div>
            `;

            messagesContainer.insertAdjacentHTML('beforeend', messageHTML);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Open file from chat reference
        function openFileFromChat(path) {
            const file = allFiles.find(f => (f.path || f.id) === path);
            if (file) {
                closeResearchChat();
                previewFile(file.id);
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingHTML = `
                <div class="chat-message assistant" id="typingIndicator">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', typingHTML);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Open chat settings modal
        function openChatSettings() {
            const currentKey = localStorage.getItem('gemini_api_key') || '';

            const modalHTML = `
                <div class="chat-modal-overlay" id="chatSettingsModal" onclick="closeChatSettings(event)" style="z-index: 1001;">
                    <div class="chat-modal-content" style="max-width: 450px; height: auto; max-height: 400px;" onclick="event.stopPropagation()">
                        <div class="chat-header" style="padding: 20px;">
                            <div class="chat-header-left">
                                <i class="fas fa-cog" style="color: #a78bfa;"></i>
                                <h3 style="margin: 0;">Chat Settings</h3>
                            </div>
                            <button onclick="closeChatSettings()" class="chat-header-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-size: 0.9rem; color: #94a3b8; margin-bottom: 8px;">
                                    Google Gemini 3 Flash API Key
                                </label>
                                <input type="password" id="geminiKeyInput" placeholder="Enter your Gemini API key"
                                       value="${currentKey}"
                                       style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; box-sizing: border-box;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-top: 8px;">
                                    Get a FREE key at: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #a78bfa;">aistudio.google.com</a>
                                </p>
                            </div>
                            <button onclick="saveGeminiKey()" style="width: 100%; padding: 12px; background: #7c3aed; border: none; border-radius: 8px; color: #fff; font-weight: 500; cursor: pointer;">
                                Save API Key
                            </button>
                            <p style="font-size: 0.75rem; color: #64748b; margin-top: 12px; text-align: center;">
                                Current status: <span style="color: ${currentKey ? '#10b981' : '#f59e0b'};">${currentKey ? ' Connected & Ready (gemini-3-flash-preview)' : 'Using basic mode'}</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close chat settings
        function closeChatSettings(event) {
            if (!event || event.target.id === 'chatSettingsModal') {
                const modal = document.getElementById('chatSettingsModal');
                if (modal) modal.remove();
            }
        }

        // Save Gemini API key
        function saveGeminiKey() {
            const key = document.getElementById('geminiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                toast('API key saved! The Research Assistant will now use Google Gemini 3 Flash.', 'success');
            } else {
                localStorage.removeItem('gemini_api_key');
                toast('API key removed. Using basic search mode.', 'info');
            }
            closeChatSettings();
        }

        // Keyboard shortcut: Ctrl+Shift+R to open Research Assistant
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                e.preventDefault();
                openResearchChat();
            }
            // Also close chat with Escape
            if (e.key === 'Escape' && document.getElementById('researchChatModal').style.display === 'flex') {
                closeResearchChat();
            }
        });

        // =============================================
        // BATCH FILE OPERATIONS FUNCTIONALITY
        // =============================================

        let batchSelectionModeActive = false;
        let batchSelectedFiles = new Set();

        // Toggle batch selection mode on/off
        function toggleBatchSelectionMode() {
            batchSelectionModeActive = !batchSelectionModeActive;

            const toggle = document.getElementById('selectionModeToggle');
            const batchActions = document.getElementById('batchActions');
            const icon = document.getElementById('selectionModeIcon');
            const text = document.getElementById('selectionModeText');
            const fileGrid = document.getElementById('fileGrid');

            if (batchSelectionModeActive) {
                toggle.classList.add('active');
                batchActions.style.display = 'flex';
                icon.className = 'fas fa-times';
                text.textContent = 'Exit Selection';
                fileGrid.classList.add('selection-mode-active');
                toast('Selection mode enabled. Click files to select them.', 'info');
            } else {
                toggle.classList.remove('active');
                batchActions.style.display = 'none';
                icon.className = 'fas fa-check-square';
                text.textContent = 'Select Files';
                fileGrid.classList.remove('selection-mode-active');
                batchClearSelection();
            }
        }

        // Toggle individual file selection
        function toggleBatchFileSelection(event, fileId) {
            event.stopPropagation();

            const checkbox = event.currentTarget;
            const fileCard = checkbox.closest('.file-card');

            if (batchSelectedFiles.has(fileId)) {
                batchSelectedFiles.delete(fileId);
                checkbox.classList.remove('checked');
                fileCard.classList.remove('batch-selected');
            } else {
                batchSelectedFiles.add(fileId);
                checkbox.classList.add('checked');
                fileCard.classList.add('batch-selected');
            }

            updateBatchSelectedCount();
        }

        // Select all visible files
        function batchSelectAllVisible() {
            const visibleCards = document.querySelectorAll('.file-card:not([style*="display: none"])');

            visibleCards.forEach(card => {
                const fileId = card.dataset.id;
                const checkbox = card.querySelector('.file-card-checkbox');

                if (fileId && !batchSelectedFiles.has(fileId)) {
                    batchSelectedFiles.add(fileId);
                    checkbox?.classList.add('checked');
                    card.classList.add('batch-selected');
                }
            });

            updateBatchSelectedCount();
            toast(`Selected ${batchSelectedFiles.size} files`, 'info');
        }

        // Clear all selections
        function batchClearSelection() {
            batchSelectedFiles.clear();

            document.querySelectorAll('.file-card-checkbox.checked').forEach(checkbox => {
                checkbox.classList.remove('checked');
            });

            document.querySelectorAll('.file-card.batch-selected').forEach(card => {
                card.classList.remove('batch-selected');
            });

            updateBatchSelectedCount();
        }

        // Update selected count display
        function updateBatchSelectedCount() {
            const countEl = document.getElementById('batchSelectedCount');
            if (countEl) {
                countEl.textContent = batchSelectedFiles.size;
            }

            // Enable/disable batch actions button
            const batchActionsBtn = document.getElementById('batchActionsBtn');
            if (batchActionsBtn) {
                batchActionsBtn.disabled = batchSelectedFiles.size === 0;
                batchActionsBtn.style.opacity = batchSelectedFiles.size === 0 ? '0.5' : '1';
            }
        }

        // Get selected files data
        function getBatchSelectedFilesData() {
            return Array.from(batchSelectedFiles).map(fileId => {
                return allFiles.find(f => f.id === fileId);
            }).filter(f => f !== undefined);
        }

        // Open batch actions modal
        function openBatchActionsModal() {
            if (batchSelectedFiles.size === 0) {
                toast('Please select at least one file first', 'warning');
                return;
            }

            document.getElementById('batchModalCount').textContent = batchSelectedFiles.size;
            document.getElementById('batchActionsModal').style.display = 'flex';
        }

        // Close batch actions modal
        function closeBatchActionsModal() {
            document.getElementById('batchActionsModal').style.display = 'none';
        }

        // Batch add tag
        function batchAddTag() {
            const tagInput = document.getElementById('batchTagInput');
            const tag = tagInput.value.trim().toLowerCase().replace(/\s+/g, '-');

            if (!tag) {
                toast('Please enter a tag name', 'warning');
                return;
            }

            const selectedFilesData = getBatchSelectedFilesData();
            let updatedCount = 0;

            selectedFilesData.forEach(file => {
                // Initialize custom tags if not exists
                if (!file._customTags) file._customTags = [];
                if (!file._customTags.includes(tag)) {
                    file._customTags.push(tag);
                    // Also store in userPrefs
                    if (!userPrefs.customTags) userPrefs.customTags = {};
                    if (!userPrefs.customTags[file.id]) userPrefs.customTags[file.id] = [];
                    if (!userPrefs.customTags[file.id].includes(tag)) {
                        userPrefs.customTags[file.id].push(tag);
                    }
                    updatedCount++;
                }
            });

            saveUserPrefs();
            tagInput.value = '';
            toast(`Added tag "${tag}" to ${updatedCount} files`, 'success');
            displayedCount = 0;
            displayFiles();
        }

        // Batch set color
        function batchSetColor(color) {
            const selectedFilesData = getBatchSelectedFilesData();

            selectedFilesData.forEach(file => {
                file._color = color;
                if (color) {
                    userPrefs.colors[file.id] = color;
                } else {
                    delete userPrefs.colors[file.id];
                }
            });

            saveUserPrefs();
            toast(`Set color ${color || 'cleared'} for ${selectedFilesData.length} files`, 'success');
            displayedCount = 0;
            displayFiles();
            buildSidebar();
        }

        // Batch set rating
        function batchSetRating(rating) {
            const selectedFilesData = getBatchSelectedFilesData();

            selectedFilesData.forEach(file => {
                file._rating = rating;
                if (rating > 0) {
                    userPrefs.ratings[file.id] = rating;
                } else {
                    delete userPrefs.ratings[file.id];
                }
            });

            saveUserPrefs();
            toast(`Set ${rating === 0 ? 'no' : rating + '-star'} rating for ${selectedFilesData.length} files`, 'success');
            displayedCount = 0;
            displayFiles();
            buildSidebar();
        }

        // Batch add to favorites
        function batchAddToFavorites() {
            const selectedFilesData = getBatchSelectedFilesData();

            selectedFilesData.forEach(file => {
                file._favorite = true;
                userPrefs.favorites[file.id] = true;
            });

            saveUserPrefs();
            toast(`Added ${selectedFilesData.length} files to favorites`, 'success');
            displayedCount = 0;
            displayFiles();
            updateHeaderStats();
            buildSidebar();
        }

        // Batch remove from favorites
        function batchRemoveFromFavorites() {
            const selectedFilesData = getBatchSelectedFilesData();

            selectedFilesData.forEach(file => {
                file._favorite = false;
                delete userPrefs.favorites[file.id];
            });

            saveUserPrefs();
            toast(`Removed ${selectedFilesData.length} files from favorites`, 'success');
            displayedCount = 0;
            displayFiles();
            updateHeaderStats();
            buildSidebar();
        }

        // Batch move to folder (generates script)
        function batchMoveToFolder() {
            const folderPath = document.getElementById('batchFolderInput').value.trim();

            if (!folderPath) {
                toast('Please enter a destination folder path', 'warning');
                return;
            }

            const selectedFilesData = getBatchSelectedFilesData();

            // Generate a batch script for moving files
            let batchScript = '@echo off\r\n';
            batchScript += 'chcp 65001 > nul\r\n';
            batchScript += `echo Moving ${selectedFilesData.length} files to ${folderPath}\r\n`;
            batchScript += 'echo.\r\n';
            batchScript += `if not exist "${folderPath}" mkdir "${folderPath}"\r\n`;
            batchScript += 'echo.\r\n';

            selectedFilesData.forEach(file => {
                const sourcePath = file.path || '';
                const fileName = file.name;
                if (sourcePath) {
                    batchScript += `echo Moving: ${fileName}\r\n`;
                    batchScript += `move "${sourcePath}" "${folderPath}\\${fileName}"\r\n`;
                }
            });

            batchScript += 'echo.\r\n';
            batchScript += `echo Done! Processed ${selectedFilesData.length} files.\r\n`;
            batchScript += 'pause\r\n';

            // Download the batch script
            const blob = new Blob([batchScript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `move_${selectedFilesData.length}_files.bat`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            toast(`Batch script downloaded! Run it to move ${selectedFilesData.length} files.`, 'success');
        }

        // Batch export list
        function batchExportList() {
            const format = document.getElementById('exportFormatSelect').value;
            const selectedFilesData = getBatchSelectedFilesData();

            let content, filename, mimeType;

            if (format === 'csv') {
                // CSV format
                const headers = ['Filename', 'Path', 'Category', 'Size', 'Summary', 'Tags'];
                const rows = selectedFilesData.map(file => {
                    const aiData = aiSuggestions[file.id] || {};
                    return [
                        file.name || '',
                        file.path || file.link || '',
                        file.category || '',
                        file.size || '',
                        (aiData.summary || file._summary || '').replace(/"/g, '""'),
                        (aiData.tags || file._aiTags || []).join('; ')
                    ];
                });

                content = headers.join(',') + '\n';
                content += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                filename = `selected_files_${selectedFilesData.length}.csv`;
                mimeType = 'text/csv';

            } else if (format === 'json') {
                // JSON format
                content = JSON.stringify(selectedFilesData.map(file => {
                    const aiData = aiSuggestions[file.id] || {};
                    return {
                        name: file.name,
                        path: file.path || file.link,
                        category: file.category,
                        size: file.size,
                        summary: aiData.summary || file._summary,
                        tags: aiData.tags || file._aiTags,
                        suggested_name: aiData.suggested_name || file._suggestedName,
                        rating: file._rating,
                        color: file._color,
                        favorite: file._favorite
                    };
                }), null, 2);
                filename = `selected_files_${selectedFilesData.length}.json`;
                mimeType = 'application/json';

            } else {
                // Plain text - just paths/links
                content = selectedFilesData.map(file => file.path || file.link || file.name).join('\n');
                filename = `selected_files_${selectedFilesData.length}.txt`;
                mimeType = 'text/plain';
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            toast(`Exported ${selectedFilesData.length} files as ${format.toUpperCase()}`, 'success');
        }

        // Batch approve AI renames
        function batchApproveRenames() {
            const selectedFilesData = getBatchSelectedFilesData();
            let approvedCount = 0;

            selectedFilesData.forEach(file => {
                const aiData = aiSuggestions[file.id];
                if (aiData && aiData.suggested_name && aiData.status !== 'approved') {
                    aiData.status = 'approved';
                    approvedCount++;
                }
            });

            if (approvedCount > 0) {
                toast(`Approved ${approvedCount} rename suggestions. Run the renamer script to apply changes.`, 'success');
            } else {
                toast('No pending rename suggestions found in selected files.', 'info');
            }
        }

        // Batch delete files (generates script)
        function batchDeleteFiles() {
            const selectedFilesData = getBatchSelectedFilesData();

            // Show confirmation dialog
            const confirmed = confirm(
                ` WARNING: You are about to generate a script to delete ${selectedFilesData.length} files!\n\n` +
                `This will create a batch file that you must run manually.\n\n` +
                `Are you sure you want to proceed?`
            );

            if (!confirmed) return;

            // Generate a deletion batch script
            let batchScript = '@echo off\r\n';
            batchScript += 'chcp 65001 > nul\r\n';
            batchScript += `echo ========================================\r\n`;
            batchScript += `echo WARNING: This will delete ${selectedFilesData.length} files!\r\n`;
            batchScript += `echo ========================================\r\n`;
            batchScript += 'echo.\r\n';
            batchScript += 'echo Press Ctrl+C to cancel, or\r\n';
            batchScript += 'pause\r\n';
            batchScript += 'echo.\r\n';

            selectedFilesData.forEach(file => {
                const filePath = file.path || '';
                if (filePath) {
                    batchScript += `del "${filePath}"\r\n`;
                    batchScript += `echo Deleted: ${file.name}\r\n`;
                }
            });

            batchScript += 'echo.\r\n';
            batchScript += `echo Done! Processed ${selectedFilesData.length} files.\r\n`;
            batchScript += 'pause\r\n';

            const blob = new Blob([batchScript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DELETE_${selectedFilesData.length}_files.bat`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            toast(`Deletion script downloaded. Review carefully before running!`, 'warning');
            closeBatchActionsModal();
        }

        // Keyboard shortcuts for batch operations
        document.addEventListener('keydown', (e) => {
            // Ctrl+Shift+B = toggle selection mode
            if (e.ctrlKey && e.shiftKey && e.key === 'B') {
                e.preventDefault();
                toggleBatchSelectionMode();
            }

            // Ctrl+A in selection mode = select all visible
            if (e.ctrlKey && e.key === 'a' && batchSelectionModeActive) {
                e.preventDefault();
                batchSelectAllVisible();
            }

            // Escape in selection mode = exit selection mode
            if (e.key === 'Escape' && batchSelectionModeActive) {
                toggleBatchSelectionMode();
            }

            // Escape closes batch actions modal
            if (e.key === 'Escape' && document.getElementById('batchActionsModal').style.display === 'flex') {
                closeBatchActionsModal();
            }
        });

    </script>

    <!-- Batch Actions Modal -->
    <div class="chat-modal-overlay" id="batchActionsModal" style="display: none;">
        <div class="chat-modal-content" style="max-width: 650px; height: auto; max-height: 85vh; overflow-y: auto;">

            <!-- Modal Header -->
            <div class="chat-header" style="padding: 20px 24px; position: sticky; top: 0; z-index: 10;">
                <div class="chat-header-left">
                    <i class="fas fa-bolt" style="font-size: 1.5rem; color: #f59e0b;"></i>
                    <div>
                        <h3 style="font-size: 1.2rem; margin: 0;">Batch Actions</h3>
                        <p style="font-size: 0.8rem; color: #64748b; margin: 4px 0 0 0;">
                            Apply actions to <span id="batchModalCount" style="color: #a78bfa; font-weight: 600;">0</span> selected files
                        </p>
                    </div>
                </div>
                <button onclick="closeBatchActionsModal()" class="chat-header-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div style="padding: 24px; display: flex; flex-direction: column; gap: 16px;">

                <!-- Action: Add Tag -->
                <div class="batch-action-item">
                    <div class="batch-action-header">
                        <i class="fas fa-tags" style="color: #a78bfa;"></i>
                        <span>Add Tag to All</span>
                    </div>
                    <div class="batch-action-content">
                        <input type="text" id="batchTagInput" placeholder="Enter tag name (e.g., important, review-later)"
                               style="flex: 1; padding: 10px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
                        <button onclick="batchAddTag()" class="batch-action-btn">
                            <i class="fas fa-plus"></i> Add Tag
                        </button>
                    </div>
                </div>

                <!-- Action: Set Color Label -->
                <div class="batch-action-item">
                    <div class="batch-action-header">
                        <i class="fas fa-palette" style="color: #ec4899;"></i>
                        <span>Set Color Label</span>
                    </div>
                    <div class="batch-action-content">
                        <div class="color-options" style="display: flex; gap: 8px; flex: 1; flex-wrap: wrap;">
                            <button onclick="batchSetColor('red')" class="color-btn" style="background: #ef4444;" title="Red"></button>
                            <button onclick="batchSetColor('orange')" class="color-btn" style="background: #f97316;" title="Orange"></button>
                            <button onclick="batchSetColor('yellow')" class="color-btn" style="background: #eab308;" title="Yellow"></button>
                            <button onclick="batchSetColor('green')" class="color-btn" style="background: #22c55e;" title="Green"></button>
                            <button onclick="batchSetColor('blue')" class="color-btn" style="background: #3b82f6;" title="Blue"></button>
                            <button onclick="batchSetColor('purple')" class="color-btn" style="background: #a855f7;" title="Purple"></button>
                            <button onclick="batchSetColor('pink')" class="color-btn" style="background: #ec4899;" title="Pink"></button>
                            <button onclick="batchSetColor(null)" class="color-btn" style="background: #64748b;" title="Remove Color"></button>
                        </div>
                    </div>
                </div>

                <!-- Action: Set Star Rating -->
                <div class="batch-action-item">
                    <div class="batch-action-header">
                        <i class="fas fa-star" style="color: #eab308;"></i>
                        <span>Set Star Rating</span>
                    </div>
                    <div class="batch-action-content">
                        <div class="rating-options" style="display: flex; gap: 8px; flex: 1; flex-wrap: wrap;">
                            <button onclick="batchSetRating(1)" class="rating-btn"></button>
                            <button onclick="batchSetRating(2)" class="rating-btn"></button>
                            <button onclick="batchSetRating(3)" class="rating-btn"></button>
                            <button onclick="batchSetRating(4)" class="rating-btn"></button>
                            <button onclick="batchSetRating(5)" class="rating-btn"></button>
                            <button onclick="batchSetRating(0)" class="rating-btn" style="color: #64748b;">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Action: Add to Favorites -->
                <div class="batch-action-item">
                    <div class="batch-action-header">
                        <i class="fas fa-heart" style="color: #ef4444;"></i>
                        <span>Favorites</span>
                    </div>
                    <div class="batch-action-content">
                        <p style="flex: 1; font-size: 0.85rem; color: #94a3b8;">
                            Add or remove all selected files from favorites.
                        </p>
                        <button onclick="batchAddToFavorites()" class="batch-action-btn" style="background: #ef4444;">
                            <i class="fas fa-heart"></i> Add All
                        </button>
                        <button onclick="batchRemoveFromFavorites()" class="batch-action-btn" style="background: rgba(255,255,255,0.1);">
                            <i class="fas fa-heart-broken"></i> Remove
                        </button>
                    </div>
                </div>

                <!-- Action: Move to Folder -->
                <div class="batch-action-item">
                    <div class="batch-action-header">
                        <i class="fas fa-folder" style="color: #06b6d4;"></i>
                        <span>Move to Folder (Generate Script)</span>
                    </div>
                    <div class="batch-action-content">
                        <input type="text" id="batchFolderInput" placeholder="Enter folder path (e.g., C:\Users\arnol\Desktop\Sorted)"
                               style="flex: 1; padding: 10px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
                        <button onclick="batchMoveToFolder()" class="batch-action-btn">
                            <i class="fas fa-folder-open"></i> Generate Script
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: #64748b; margin-top: 8px;">
                        <i class="fas fa-info-circle"></i> This generates a batch script. Files won't move until you run it.
                    </p>
                </div>

                <!-- Action: Export List -->
                <div class="batch-action-item">
                    <div class="batch-action-header">
                        <i class="fas fa-download" style="color: #10b981;"></i>
                        <span>Export File List</span>
                    </div>
                    <div class="batch-action-content">
                        <select id="exportFormatSelect" style="flex: 1; padding: 10px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;">
                            <option value="csv">CSV (Excel compatible)</option>
                            <option value="json">JSON (detailed data)</option>
                            <option value="txt">Text (file paths only)</option>
                        </select>
                        <button onclick="batchExportList()" class="batch-action-btn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <!-- Action: Approve AI Renames -->
                <div class="batch-action-item">
                    <div class="batch-action-header">
                        <i class="fas fa-robot" style="color: #a78bfa;"></i>
                        <span>Approve AI Rename Suggestions</span>
                    </div>
                    <div class="batch-action-content">
                        <p style="flex: 1; font-size: 0.85rem; color: #94a3b8;">
                            Approve AI-suggested names for all selected files that have pending suggestions.
                        </p>
                        <button onclick="batchApproveRenames()" class="batch-action-btn">
                            <i class="fas fa-check"></i> Approve All
                        </button>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="batch-action-item" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
                    <div class="batch-action-header" style="color: #ef4444;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Danger Zone</span>
                    </div>
                    <div class="batch-action-content">
                        <p style="flex: 1; font-size: 0.85rem; color: #fca5a5;">
                            Generate a script to delete selected files. This requires confirmation.
                        </p>
                        <button onclick="batchDeleteFiles()" class="batch-action-btn danger" style="background: #ef4444;">
                            <i class="fas fa-trash"></i> Delete Script
                        </button>
                    </div>
                </div>

            </div>

            <!-- Modal Footer -->
            <div style="padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; position: sticky; bottom: 0; background: rgba(30, 27, 75, 0.95);">
                <span style="font-size: 0.8rem; color: #64748b;">
                    <i class="fas fa-keyboard"></i> Tip: Use Ctrl+Shift+B to toggle selection mode
                </span>
                <button onclick="closeBatchActionsModal()" style="padding: 10px 24px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 8px; cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Research Assistant Chat Modal -->
    <div class="chat-modal-overlay" id="researchChatModal" style="display: none;">
        <div class="chat-modal-content">

            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-header-left">
                    <i class="fas fa-robot" style="font-size: 1.5rem; color: #a78bfa;"></i>
                    <div>
                        <h3 style="font-size: 1.1rem; margin: 0;">Research Assistant</h3>
                        <p style="font-size: 0.75rem; color: #64748b; margin: 0;">Ask questions about your 27,000+ documents</p>
                    </div>
                </div>
                <div class="chat-header-right">
                    <button onclick="openChatSettings()" class="chat-header-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button onclick="clearChatHistory()" class="chat-header-btn" title="Clear chat">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button onclick="closeResearchChat()" class="chat-header-btn" title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="chat-messages" id="chatMessages">

                <!-- Welcome Message -->
                <div class="chat-message assistant">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            <p>Hello! I'm your Research Assistant. I have access to summaries and tags for your entire document collection.</p>
                            <p style="margin-top: 10px;">Try asking me things like:</p>
                            <ul style="margin: 10px 0 0 20px; color: #94a3b8;">
                                <li>"What papers do I have about ADHD in adolescents?"</li>
                                <li>"Find research on treatment-resistant depression"</li>
                                <li>"Summarize my documents about medication interactions"</li>
                                <li>"What do I have on CBT for anxiety?"</li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Chat Input Area -->
            <div class="chat-input-area">
                <div class="chat-input-container">
                    <textarea
                        id="chatInput"
                        placeholder="Ask about your documents..."
                        rows="1"
                        onkeydown="handleChatKeydown(event)"
                    ></textarea>
                    <button onclick="sendChatMessage()" id="chatSendBtn" class="chat-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p class="chat-disclaimer">
                    <i class="fas fa-info-circle"></i>
                    Responses are based on AI-generated summaries of your files. Always verify important information.
                </p>
            </div>

        </div>
    </div>
<script>if("serviceWorker"in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(r=>console.log("SW:",r.scope)).catch(e=>console.log("SW err:",e));});}</script>
</body>
</html>
